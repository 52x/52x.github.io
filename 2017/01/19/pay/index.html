<!DOCTYPE html>
<html lang="zh">
    <head>
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.4 -->

    <!-- Title -->
    
    <title>
        
            微信公众号支付 | 
        
        Hexo
    </title>

    <!-- Meta & Info -->
    <meta charset="utf-8">

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    

    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="John Doe">
    <meta name="description" content="null">
    <meta name="keywords" content="null,支付">

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Hexo">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="微信公众号支付 | Hexo">
    <meta property="og:description" content="null">
    <meta property="og:article:tag" content="支付"> 

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS & jQuery -->
    
        <link rel="stylesheet" href="/css/material.min.css">
        <link rel="stylesheet" href="/css/style.min.css">
        <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


        <script src="/js/jquery.min.js"></script>
        <script src="/js/queue.js"></script>
    

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    


    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">1.</span> <span class="post-toc-text">最终实现目标</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">2.</span> <span class="post-toc-text">准备条件</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.</span> <span class="post-toc-text">微信支付思路</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.</span> <span class="post-toc-text">简单实现微信支付的两个功能</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">公众号支付</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.1.1.</span> <span class="post-toc-text">1.下单</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.1.1.1.</span> <span class="post-toc-text">下单（未付款）方法</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.1.1.2.</span> <span class="post-toc-text">获取页面调用所需参数</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.1.2.</span> <span class="post-toc-text">2.支付</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.1.3.</span> <span class="post-toc-text">3.支付回调</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">退款</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.</span> <span class="post-toc-text">源码</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">PayController.java</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">PayService.java 支付回调控制器</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.3.</span> <span class="post-toc-text">OrderController.java 订单控制器</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.4.</span> <span class="post-toc-text">OrderService.java 订单服务器</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.5.</span> <span class="post-toc-text">Order.java 订单类</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.6.</span> <span class="post-toc-text">SignMD5.java 签名工具类</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.7.</span> <span class="post-toc-text">WechatNotify.java 微信支付回调结果封装</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.8.</span> <span class="post-toc-text">WechatPayModel.java 微信支付统一订单接口参数封装模型</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.9.</span> <span class="post-toc-text">WechatRefundModel.java 微信退款接口参数封装模型</span></a></li></ol></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                微信公众号支付
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>John Doe</strong>
        <span>1月 19, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/支付/">支付</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=微信公众号支付&url=http://yoursite.com//2017/01/19/pay/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=微信公众号支付&url=http://yoursite.com//2017/01/19/pay/index.html&via=John Doe" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com//2017/01/19/pay/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com//2017/01/19/pay/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <p>微信支付功能模块是一个可以抽离的模块，因此controller、service等集中放在一个包下管理。
由于业务需求，现在与OrderController、OrderService集成耦合。
本文档是根据实际项目抽取总结出来的，很多代码可以根据实际开发进一步更改完善。</p>
<h1>最终实现目标</h1>
<ol>
<li>实现微信公众号支付功能</li>
<li>实现微信公众号退款功能</li>
<li>本文档附加了大部分的支付模块源码，通过本文档就能抽取出一个独立的支付模块，方便快速开发。</li>
</ol>
<h1>准备条件</h1>
<ol>
<li>
<p><a href="https://pay.weixin.qq.com/index.php" target="_blank" rel="external">微信支付|商户平台</a>的账号</p>
<ul>
<li>这个不归程序员准备，略过</li>
<li>商户平台的账号必须与公众号的配置对应，在公众号的微信支付模块设置</li>
</ul>
</li>
<li>
<p>一个可以在公网访问的公众号</p>
<ul>
<li>微信支付不能在localhost测试</li>
<li>微信支付不能在微信web开发者工具上测试，只能在手机真实试验</li>
<li>公众号相关配置的要配置设置好</li>
</ul>
</li>
</ol>
<h1>微信支付思路</h1>
<ol>
<li>应该存在一个支付页面，假设页面很简单，上面就一个支付按钮，用户点击按钮就能够完成支付。</li>
<li>用户点击的时候，Ajax 调用后台创建接口接口。</li>
<li>创建订单接口首先会创建一个未付款的订单，订单的参数如价格、数量、订单号、等可以根据业务自定义。</li>
<li>创建订单后，会调用微信提供的统一下单接口，微信会根据我们传递的参数，生成一个预支付交易会话标识（prepay_id，就是通过这个来识别该订单的），返回给后台。</li>
<li>后台接收到prepay_id后，构造微信支付所需要的参数，把参数返回给客户端。</li>
<li>客户端之前发起的 Ajax 请求，接收到成功的响应后，拿接收到的参数调用JSAPI支付接口，向微信发起支付。</li>
<li>如果之前的步骤都成功，微信会弹出支付页面，让用户输入密码支付。</li>
<li>支付成功后微信会跳转H5页面，并且异步通知后台支付结果，后台进一步处理订单，如标记订单付款成功，更新订单日志。</li>
</ol>
<p>简而言之，服务器创建订单，触发微信支付，支付后微信异步回调，服务器修改订单状态。</p>
<h1>简单实现微信支付的两个功能</h1>
<h2>公众号支付</h2>
<h3>1.下单</h3>
<p>第一步，根据业务生成未支付的订单，调用微信支付统一下单接口，获取微信支付统一订单号 prepay_id ，有了这个才能进一步支付；调起微信支付，获取微信支付下单结果信息集合，集合信息为供页面调用微信JS_API的一些字段信息。</p>
<h4>下单（未付款）方法</h4>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">    private static final String NOTIFY_URL = Global.getConfig("domainName") + "/pay/notify";//微信支付回调接口</div><div class="line">    private static final String PAY_RESULT_URL = Global.getConfig("domainName") + "/pay/result";//微信支付结果页面接口</div><div class="line">    private static final String PAY_BODY = "牙齐齐服务";</div><div class="line">    </div><div class="line">    /**</div><div class="line">     * 下单（但付款）</div><div class="line">     *</div><div class="line">     * @param items           订单对应项目</div><div class="line">     * @param owner           订单拥有者</div><div class="line">     * @return 微信支付下单结果信息集合</div><div class="line">     */</div><div class="line">    public Map add(Items items, User owner) &#123;</div><div class="line">        Order order = new Order();</div><div class="line">        order.setItems(items);</div><div class="line">        order.setPayMoney(items.getPrice());</div><div class="line">        order.setStatus(OrderStatus.NEED_PAY.getCode());</div><div class="line">        order.setPayResult(PayResult.NEED_PAY.getCode());</div><div class="line">        this.save(order);</div><div class="line">        //支付倒计时，定时删除未支付的订单</div><div class="line">        TIMER.schedule(new TimeoutTask(order.getId()), DEFAULT_VALIDITY_TIME);</div><div class="line">        //调用微信支付统一下单接口，获取微信支付统一订单号</div><div class="line">        String res = payService.unifiedorder(NOTIFY_URL, owner.getOpenId(), PAY_BODY, String.valueOf(order.getPayMoney()), order.getId());</div><div class="line">        //调起微信支付，获取微信支付下单结果信息集合</div><div class="line">        return payService.wechatPay(res, PAY_RESULT_URL);</div><div class="line">    &#125;</div><div class="line">   </div><div class="line">````    </div><div class="line"></div><div class="line">#### 微信支付统一下单接口</div><div class="line"></div><div class="line">````java</div><div class="line">    /**</div><div class="line">     * 微信支付统一下单接口</div><div class="line">     *</div><div class="line">     * @param notifyUrl    支付成功后回调路径</div><div class="line">     * @param openId       用户的 openId</div><div class="line">     * @param body         商品描述</div><div class="line">     * @param total        支付金额（单位分）</div><div class="line">     * @param out_trade_no 订单唯一订单号</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    public String unifiedorder(String notifyUrl, String openId, String body, String total, String out_trade_no) &#123;</div><div class="line">        WechatPayModel xml = new WechatPayModel();</div><div class="line">        xml.setAppid(Global.getConfig("appid"));</div><div class="line">        xml.setMch_id(Global.getConfig("mchid"));</div><div class="line">        xml.setNonce_str(encoder.createNonceStr());</div><div class="line">        xml.setBody(body);</div><div class="line">        xml.setOut_trade_no(out_trade_no);</div><div class="line">        xml.setTotal_fee(total);</div><div class="line">        xml.setSpbill_create_ip("127.0.0.1");//// TODO: 2016/6/28</div><div class="line">        xml.setNotify_url(notifyUrl);</div><div class="line">        xml.setTrade_type("JSAPI");</div><div class="line">        xml.setOpenid(openId);</div><div class="line">        xml.sign(encoder);</div><div class="line"></div><div class="line">        String result = restTemplate.postForObject("https://api.mch.weixin.qq.com/pay/unifiedorder", xml, String.class);</div><div class="line">        return result;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h4>获取页面调用所需参数</h4>
<p>需要注意的是支付不能在微信开发者接口测试，只能在手机上测试哦！</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/**</span></div><div class="line"> * 调起微信支付</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> model</div><div class="line"> * <span class="doctag">@param</span> res   预支付订单 字符串</div><div class="line"> * <span class="doctag">@param</span> url   微信支付 url</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">wechatPay</span><span class="params">(Model model, String res, String url)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Map&lt;String, String&gt; start = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        StringBuilder startSign = <span class="keyword">new</span> StringBuilder();</div><div class="line">        Map&lt;String, String&gt; pay = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        StringBuilder paySign = <span class="keyword">new</span> StringBuilder();</div><div class="line">        Map map = XmlHelper.of(res).toMap();</div><div class="line">        <span class="keyword">if</span> (StringUtils.equals((String) map.get(<span class="string">"return_code"</span>), <span class="string">"SUCCESS"</span>)) &#123;</div><div class="line">            <span class="comment">// 得到的预支付订单，重新生成微信支付参数</span></div><div class="line">            String prepay_id = (String) map.get(<span class="string">"prepay_id"</span>);</div><div class="line">            String jsapi_ticket = TicketManager.getDefaultTicket();</div><div class="line">            <span class="comment">// 生成 微信支付 config 参数</span></div><div class="line">            start.put(<span class="string">"appId"</span>, Global.getConfig(<span class="string">"appid"</span>));</div><div class="line">            start.put(<span class="string">"nonceStr"</span>, encoder.createNonceStr());</div><div class="line">            start.put(<span class="string">"timestamp"</span>, encoder.createTimeStamp());</div><div class="line">            <span class="comment">// 生成 config 签名</span></div><div class="line">            startSign.append(<span class="string">"jsapi_ticket="</span>).append(jsapi_ticket);</div><div class="line">            startSign.append(<span class="string">"&amp;noncestr="</span>).append(start.get(<span class="string">"nonceStr"</span>));</div><div class="line">            startSign.append(<span class="string">"&amp;timestamp="</span>).append(start.get(<span class="string">"timestamp"</span>));</div><div class="line">            startSign.append(<span class="string">"&amp;url="</span>).append(url);</div><div class="line">            start.put(<span class="string">"signature"</span>, encoder.encode(startSign.toString()));</div><div class="line"></div><div class="line">            <span class="comment">// config信息验证后会执行ready方法的参数</span></div><div class="line">            pay.put(<span class="string">"signType"</span>, <span class="string">"MD5"</span>);</div><div class="line">            pay.put(<span class="string">"packageStr"</span>, <span class="string">"prepay_id="</span> + prepay_id);</div><div class="line">            <span class="comment">// 生成支付签名</span></div><div class="line">            paySign.append(<span class="string">"appId="</span>).append(start.get(<span class="string">"appId"</span>));</div><div class="line">            paySign.append(<span class="string">"&amp;nonceStr="</span>).append(start.get(<span class="string">"nonceStr"</span>));</div><div class="line">            paySign.append(<span class="string">"&amp;package="</span>).append(pay.get(<span class="string">"packageStr"</span>));</div><div class="line">            paySign.append(<span class="string">"&amp;signType="</span>).append(pay.get(<span class="string">"signType"</span>));</div><div class="line">            paySign.append(<span class="string">"&amp;timeStamp="</span>).append(start.get(<span class="string">"timestamp"</span>));</div><div class="line">            paySign.append(<span class="string">"&amp;key="</span>).append(Global.getConfig(<span class="string">"payKey"</span>));</div><div class="line">            pay.put(<span class="string">"paySign"</span>, encoder.encode(paySign.toString()));</div><div class="line">            <span class="comment">// 将微信支参数放入 model 对象中以便前端使用</span></div><div class="line">            model.addAttribute(<span class="string">"start"</span>, start);</div><div class="line">            model.addAttribute(<span class="string">"pay"</span>, pay);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            LOGGER.error(<span class="keyword">new</span> String(PaymentKit.xmlToMap(res).get(<span class="string">"return_msg"</span>).getBytes(<span class="string">"iso8859-1"</span>)));</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        model.addAttribute(<span class="string">"wechatMessage"</span>, <span class="string">"微信授权失败!"</span>);</div><div class="line">        LOGGER.error(e.getMessage(), e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>2.支付</h3>
<p>支付页面源码：
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">page</span> <span class="attr">contentType</span>=<span class="string">"text/html;charset=UTF-8"</span> <span class="attr">language</span>=<span class="string">"java"</span> %&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">include</span> <span class="attr">file</span>=<span class="string">"/WEB-INF/views/include/taglib.jsp"</span> %&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=$&#123;ctxStatic&#125;edge"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">%@include</span> <span class="attr">file</span>=<span class="string">"/WEB-INF/views/include/css.jsp"</span> %&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>确认订单<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">ontouchstart</span>=<span class="string">""</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onclick</span>=<span class="string">"addOrder()"</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">class</span>=<span class="string">"weui_btn weui_btn_primary"</span> <span class="attr">style</span>=<span class="string">"margin: 0rem 1rem"</span>&gt;</span>支付<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%@include</span> <span class="attr">file</span>=<span class="string">"/WEB-INF/views/include/js.jsp"</span> %&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> <span class="attr">src</span>=<span class="string">"https://res.wx.qq.com/open/js/jweixin-1.0.0.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">addOrder</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> itemsId = <span class="string">'$&#123;items.id&#125;'</span>;</div><div class="line">        $.showLoading(<span class="string">"正在处理..."</span>);</div><div class="line">        $.post(<span class="string">"$&#123;ctx&#125;/order"</span>, &#123;<span class="attr">itemsId</span>: itemsId&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</div><div class="line">            $.hideLoading();</div><div class="line">            <span class="keyword">if</span> (result &amp;&amp; result.success) &#123;</div><div class="line">                $.hideLoading();</div><div class="line">                pay(result.data);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                $.toptip(result.message, <span class="string">'error'</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//微信支付</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">pay</span>(<span class="params">data</span>) </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">//config</span></div><div class="line">        <span class="keyword">var</span> appId = data.start.appId;</div><div class="line">        <span class="keyword">var</span> timeStamp = data.start.timestamp;</div><div class="line">        <span class="keyword">var</span> nonceStr = data.start.nonceStr;</div><div class="line">        <span class="keyword">var</span> signature = data.start.signature;</div><div class="line"></div><div class="line">        <span class="keyword">var</span> signType = data.pay.signType;</div><div class="line">        <span class="keyword">var</span> pk = data.pay.packageStr;</div><div class="line">        <span class="keyword">var</span> paySign = data.pay.paySign;</div><div class="line"></div><div class="line">        wx.config(&#123;</div><div class="line">            <span class="attr">debug</span>: <span class="literal">false</span>, <span class="comment">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</span></div><div class="line">            appId: appId, <span class="comment">// 必填，公众号的唯一标识</span></div><div class="line">            timestamp: timeStamp, <span class="comment">// 必填，生成签名的时间戳</span></div><div class="line">            nonceStr: nonceStr, <span class="comment">// 必填，生成签名的随机串</span></div><div class="line">            signature: signature,<span class="comment">// 必填，签名，见附录1</span></div><div class="line">            jsApiList: [<span class="string">'chooseWXPay'</span>] <span class="comment">// 必填，需要使用的JS接口列表，所有JS接口列表见附录2</span></div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        wx.ready(<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</div><div class="line">            <span class="comment">// config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。</span></div><div class="line">            wx.chooseWXPay(&#123;</div><div class="line">                <span class="attr">timestamp</span>: timeStamp, <span class="comment">// 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符</span></div><div class="line">                nonceStr: nonceStr, <span class="comment">// 支付签名随机串，不长于 32 位</span></div><div class="line">                package: pk, <span class="comment">// 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）</span></div><div class="line">                signType: signType, <span class="comment">// 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'</span></div><div class="line">                paySign: paySign, <span class="comment">// 支付签名</span></div><div class="line">                success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</div><div class="line">                    location.href = <span class="string">'http://'</span> + location.host + <span class="string">'/order'</span>;</div><div class="line">                &#125;,</div><div class="line">                <span class="attr">cancel</span>: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</div><div class="line">                &#125;,</div><div class="line">                <span class="attr">fail</span>: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</div><div class="line">                    $.toptip(<span class="string">'支付失败！'</span>, <span class="string">'error'</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        wx.error(<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</div><div class="line">            alert(<span class="string">"error:"</span> + <span class="built_in">JSON</span>.stringify(res));</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h3>3.支付回调</h3>
<p>在第一步时我们有配置了两个参数，其中：
PAY_RESULT_URL 为微信支付成功后跳转的页面URL
NOTIFY_URL 为支付成功后微信回调触发的接口，通过触发，完成服务器订单付款状态的更改</p>
<p>可能会对这个接口感到奇怪，我们明明没有在项目中调用过这个接口啊。
要理解这个接口就要理解回调的概念，这里就详细解释回调的含义的，只需明白，这个是专门提供给微信调用的就行了，发起支付时，是在微信上实现的，我们并不知道支付的结果，只能等微信主动通知我们。</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * 微信支付成功后的回调函数</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/notify"</span>, method = RequestMethod.POST)</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">wechatNotify</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</div><div class="line">        <span class="comment">// 从 request 对象中获取 WechatNotify 对象</span></div><div class="line">        WechatNotify notify = getNotifyBean(request);</div><div class="line">        <span class="comment">// 如果 notify 对象不为空 并且 result_code 和 return_code 都为 'SUCCESS' 则表示支付成功</span></div><div class="line">        <span class="keyword">if</span> (StringUtils.equals(notify.getResult_code(), <span class="string">"SUCCESS"</span>) &amp;&amp; StringUtils.equals(notify.getReturn_code(), <span class="string">"SUCCESS"</span>)) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                orderService.update(notify.getOut_trade_no(), notify.getTime_end());</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                logger.error(e.getMessage(), e);</div><div class="line">                <span class="keyword">return</span> <span class="string">"&lt;xml&gt;\n&lt;return_code&gt;&lt;![CDATA[FAIL]]&gt;&lt;/return_code&gt;\n&lt;return_msg&gt;&lt;![CDATA[ERROR]]&gt;&lt;/return_msg&gt;\n&lt;/xml&gt;"</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="string">"&lt;xml&gt;\n&lt;return_code&gt;&lt;![CDATA[SUCCESS]]&gt;&lt;/return_code&gt;\n&lt;return_msg&gt;&lt;![CDATA[OK]]&gt;&lt;/return_msg&gt;\n&lt;/xml&gt;"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="string">"&lt;xml&gt;\n&lt;return_code&gt;&lt;![CDATA[FAIL]]&gt;&lt;/return_code&gt;\n&lt;return_msg&gt;&lt;![CDATA[ERROR]]&gt;&lt;/return_msg&gt;\n&lt;/xml&gt;"</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h2>退款</h2>
<p>退款相对于付款就麻烦一点，因为给钱给微信与向微信拿钱肯定不一样。
首先就是证书的下载与放置到项目中，略。
剩下就是调用微信退款接口，部分代码如下：</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * 退款</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> order 订单</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refund</span><span class="params">(Order order)</span> </span>&#123;</div><div class="line">      <span class="comment">//1. 微信退款</span></div><div class="line">      <span class="keyword">boolean</span> refundResult = payService.refund(order.getId(), order.getId(), String.valueOf(order.getPayMoney()), String.valueOf(order.getPayMoney()));</div><div class="line">      <span class="keyword">if</span> (!refundResult) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> OrderException(<span class="string">"退款失败"</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//2.处理订单</span></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          order.setStatus(OrderStatus.REFUNDED.getCode());</div><div class="line">          order.setRefundTime(<span class="keyword">new</span> Date());</div><div class="line">          order.setRefundedTime(<span class="keyword">new</span> Date());</div><div class="line">          save(order);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">          LOGGER.error(e.getMessage(), e);</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> OrderException(<span class="string">"退款失败，请联系客服"</span>);</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  </div><div class="line">   <span class="comment">/**</span></div><div class="line">       * 退款</div><div class="line">       * <span class="doctag">@return</span></div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">refund</span><span class="params">(String out_refund_no,String out_trade_no,String refund_fee,String total_fee)</span> </span>&#123;</div><div class="line">          WechatRefundModel xml = <span class="keyword">new</span> WechatRefundModel();</div><div class="line">          xml.setAppid(Global.getConfig(<span class="string">"appid"</span>));</div><div class="line">          xml.setMch_id(Global.getConfig(<span class="string">"mchid"</span>));</div><div class="line">          xml.setNonce_str(encoder.createNonceStr());</div><div class="line">          xml.setOp_user_id(Global.getConfig(<span class="string">"mchid"</span>));</div><div class="line">          xml.setOut_refund_no(out_refund_no);</div><div class="line">          xml.setOut_trade_no(out_trade_no);</div><div class="line">          xml.setRefund_fee(refund_fee);</div><div class="line">          xml.setTotal_fee(total_fee);</div><div class="line">          xml.sign(encoder);</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              String result = doRefund(<span class="string">"https://api.mch.weixin.qq.com/secapi/pay/refund"</span>,xml.toString());</div><div class="line">              Map map = XmlHelper.of(result).toMap();</div><div class="line">              String returnCode = (String) map.get(<span class="string">"return_code"</span>);</div><div class="line">              <span class="keyword">if</span> (returnCode.equals(<span class="string">"SUCCESS"</span>))&#123;</div><div class="line">                  <span class="comment">//todo</span></div><div class="line">                  LOGGER.error(<span class="string">"============================="</span>+map.get(<span class="string">"return_msg"</span>)+ <span class="string">"===================================="</span>);</div><div class="line">                  <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">              &#125;<span class="keyword">else</span> &#123;</div><div class="line">                  LOGGER.error(<span class="string">"============================="</span>+map.get(<span class="string">"return_msg"</span>)+ <span class="string">"===================================="</span>);</div><div class="line">                  <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">              &#125;</div><div class="line">          &#125;<span class="keyword">catch</span> (Exception e)&#123;</div><div class="line">              LOGGER.error(e.getMessage(), e);</div><div class="line">              <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  </div><div class="line">      <span class="function"><span class="keyword">private</span>  String <span class="title">doRefund</span><span class="params">(String url,String data)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">          KeyStore keyStore  = KeyStore.getInstance(<span class="string">"PKCS12"</span>);</div><div class="line">          InputStream instream = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="string">"apiclient_cert.p12"</span>);<span class="comment">//P12文件目录</span></div><div class="line">          <span class="keyword">char</span>[] password = Global.getConfig(<span class="string">"mchid"</span>).toCharArray();</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              keyStore.load(instream, password);<span class="comment">//这里写密码..默认是你的MCHID</span></div><div class="line">          &#125; <span class="keyword">finally</span> &#123;</div><div class="line">              instream.close();</div><div class="line">          &#125;</div><div class="line">          SSLContext sslcontext = SSLContexts.custom()</div><div class="line">                  .loadKeyMaterial(keyStore, password)<span class="comment">//这里也是写密码的</span></div><div class="line">                  .build();</div><div class="line">          <span class="comment">// Allow TLSv1 protocol only</span></div><div class="line">          SSLConnectionSocketFactory sslsf = <span class="keyword">new</span> SSLConnectionSocketFactory(</div><div class="line">                  sslcontext,</div><div class="line">                  <span class="keyword">new</span> String[] &#123; <span class="string">"TLSv1"</span> &#125;,</div><div class="line">                  <span class="keyword">null</span>,</div><div class="line">                  SSLConnectionSocketFactory.BROWSER_COMPATIBLE_HOSTNAME_VERIFIER);</div><div class="line">          CloseableHttpClient httpclient = HttpClients.custom()</div><div class="line">                  .setSSLSocketFactory(sslsf)</div><div class="line">                  .build();</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              HttpPost httpost = <span class="keyword">new</span> HttpPost(url); <span class="comment">// 设置响应头信息</span></div><div class="line">              httpost.addHeader(<span class="string">"Connection"</span>, <span class="string">"keep-alive"</span>);</div><div class="line">              httpost.addHeader(<span class="string">"Accept"</span>, <span class="string">"*/*"</span>);</div><div class="line">              httpost.addHeader(<span class="string">"Content-Type"</span>, <span class="string">"application/x-www-form-urlencoded; charset=UTF-8"</span>);</div><div class="line">              httpost.addHeader(<span class="string">"Host"</span>, <span class="string">"api.mch.weixin.qq.com"</span>);</div><div class="line">              httpost.addHeader(<span class="string">"X-Requested-With"</span>, <span class="string">"XMLHttpRequest"</span>);</div><div class="line">              httpost.addHeader(<span class="string">"Cache-Control"</span>, <span class="string">"max-age=0"</span>);</div><div class="line">              httpost.addHeader(<span class="string">"User-Agent"</span>, <span class="string">"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0) "</span>);</div><div class="line">              httpost.setEntity(<span class="keyword">new</span> StringEntity(data, <span class="string">"UTF-8"</span>));</div><div class="line">              CloseableHttpResponse response = httpclient.execute(httpost);</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  HttpEntity entity = response.getEntity();</div><div class="line">  </div><div class="line">                  String jsonStr = EntityUtils.toString(response.getEntity(), <span class="string">"UTF-8"</span>);</div><div class="line">                  EntityUtils.consume(entity);</div><div class="line">                  <span class="keyword">return</span> jsonStr;</div><div class="line">              &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                  response.close();</div><div class="line">              &#125;</div><div class="line">          &#125; <span class="keyword">finally</span> &#123;</div><div class="line">              httpclient.close();</div><div class="line">          &#125;</div><div class="line">      &#125;</div></pre></td></tr></table></figure></p>
<h1>源码</h1>
<h2>PayController.java</h2>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> xyz.dongxiaoxia.weixin.pay;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.common.config.Global;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.common.controller.BaseController;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.common.utils.StringUtils;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.entity.Order;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.entity.User;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.service.OrderService;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.service.UserService;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.xml.bind.JAXBContext;</div><div class="line"><span class="keyword">import</span> javax.xml.bind.JAXBException;</div><div class="line"><span class="keyword">import</span> javax.xml.bind.Unmarshaller;</div><div class="line"><span class="keyword">import</span> java.io.DataInputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.StringReader;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by dongxiaoxia on 2016/12/29.</div><div class="line"> */</div><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"pay"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayController</span> <span class="keyword">extends</span> <span class="title">BaseController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(PayController.class);</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> PayService payService;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> OrderService orderService;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> UserService userService;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 支付完成页面</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> 跳转支付完成页面，由微信端支付完成后自动跳转</div><div class="line">     */</div><div class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"result"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">result</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"pay/result"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 微信支付成功后的回调函数</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/notify"</span>, method = RequestMethod.POST)</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">wechatNotify</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</div><div class="line">        <span class="comment">// 从 request 对象中获取 WechatNotify 对象</span></div><div class="line">        WechatNotify notify = getNotifyBean(request);</div><div class="line">        <span class="comment">// 如果 notify 对象不为空 并且 result_code 和 return_code 都为 'SUCCESS' 则表示支付成功</span></div><div class="line">        <span class="keyword">if</span> (StringUtils.equals(notify.getResult_code(), <span class="string">"SUCCESS"</span>) &amp;&amp; StringUtils.equals(notify.getReturn_code(), <span class="string">"SUCCESS"</span>)) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                orderService.update(notify.getOut_trade_no(), notify.getTime_end());</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                logger.error(e.getMessage(), e);</div><div class="line">                <span class="keyword">return</span> <span class="string">"&lt;xml&gt;\n&lt;return_code&gt;&lt;![CDATA[FAIL]]&gt;&lt;/return_code&gt;\n&lt;return_msg&gt;&lt;![CDATA[ERROR]]&gt;&lt;/return_msg&gt;\n&lt;/xml&gt;"</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="string">"&lt;xml&gt;\n&lt;return_code&gt;&lt;![CDATA[SUCCESS]]&gt;&lt;/return_code&gt;\n&lt;return_msg&gt;&lt;![CDATA[OK]]&gt;&lt;/return_msg&gt;\n&lt;/xml&gt;"</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="string">"&lt;xml&gt;\n&lt;return_code&gt;&lt;![CDATA[FAIL]]&gt;&lt;/return_code&gt;\n&lt;return_msg&gt;&lt;![CDATA[ERROR]]&gt;&lt;/return_msg&gt;\n&lt;/xml&gt;"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 微信回调成功后 将 xml 转换为  WechatNotify 对象</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request</div><div class="line">     * <span class="doctag">@return</span> WechatNotify 对象</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WechatNotify <span class="title">getNotifyBean</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            DataInputStream in = <span class="keyword">new</span> DataInputStream(request.getInputStream());</div><div class="line">            <span class="keyword">byte</span>[] dataOrigin = <span class="keyword">new</span> <span class="keyword">byte</span>[request.getContentLength()];</div><div class="line">            <span class="comment">// 根据长度，将消息实体的内容读入字节数组dataOrigin中</span></div><div class="line">            in.readFully(dataOrigin);</div><div class="line">            <span class="comment">// 关闭数据流</span></div><div class="line">            in.close();</div><div class="line">            <span class="comment">// 从字节数组中得到表示实体的字符串</span></div><div class="line">            String xml = <span class="keyword">new</span> String(dataOrigin);</div><div class="line">            <span class="comment">// 将 xml 转换为  WechatNotify 对象</span></div><div class="line">            Object object;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                JAXBContext jc = JAXBContext.newInstance(WechatNotify.class);</div><div class="line">                Unmarshaller us = jc.createUnmarshaller();</div><div class="line">                object = us.unmarshal(<span class="keyword">new</span> StringReader(xml));</div><div class="line">            &#125; <span class="keyword">catch</span> (JAXBException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">                object = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (object != <span class="keyword">null</span> &amp;&amp; object <span class="keyword">instanceof</span> WechatNotify) &#123;</div><div class="line">                WechatNotify notify = (WechatNotify) object;</div><div class="line">                <span class="keyword">return</span> notify;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>PayService.java 支付回调控制器</h2>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> xyz.dongxiaoxia.weixin.pay;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span> com.jfinal.weixin.sdk.kit.PaymentKit;</div><div class="line"><span class="keyword">import</span> com.jfinal.weixin.sdk.utils.XmlHelper;</div><div class="line"><span class="keyword">import</span> org.apache.http.HttpEntity;</div><div class="line"><span class="keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;</div><div class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpPost;</div><div class="line"><span class="keyword">import</span> org.apache.http.conn.ssl.SSLConnectionSocketFactory;</div><div class="line"><span class="keyword">import</span> org.apache.http.conn.ssl.SSLContexts;</div><div class="line"><span class="keyword">import</span> org.apache.http.entity.StringEntity;</div><div class="line"><span class="keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;</div><div class="line"><span class="keyword">import</span> org.apache.http.impl.client.HttpClients;</div><div class="line"><span class="keyword">import</span> org.apache.http.util.EntityUtils;</div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</div><div class="line"><span class="keyword">import</span> org.springframework.ui.Model;</div><div class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.common.config.Global;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.common.utils.StringUtils;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"><span class="keyword">import</span> java.security.KeyStore;</div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> dongxiaoxia</div><div class="line"> * <span class="doctag">@create</span> 2016-06-28 11:15</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(PayService.class);</div><div class="line"></div><div class="line">    SignMD5 encoder = <span class="keyword">new</span> SignMD5();</div><div class="line">    RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 微信支付统一下单接口</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> notifyUrl    支付成功后回调路径</div><div class="line">     * <span class="doctag">@param</span> openId       用户的 openId</div><div class="line">     * <span class="doctag">@param</span> body         商品描述</div><div class="line">     * <span class="doctag">@param</span> total        支付金额（单位分）</div><div class="line">     * <span class="doctag">@param</span> out_trade_no 订单唯一订单号</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">unifiedorder</span><span class="params">(String notifyUrl, String openId, String body, String total, String out_trade_no)</span> </span>&#123;</div><div class="line">        WechatPayModel xml = <span class="keyword">new</span> WechatPayModel();</div><div class="line">        xml.setAppid(Global.getConfig(<span class="string">"appid"</span>));</div><div class="line">        xml.setMch_id(Global.getConfig(<span class="string">"mchid"</span>));</div><div class="line">        xml.setNonce_str(encoder.createNonceStr());</div><div class="line">        xml.setBody(body);</div><div class="line">        xml.setOut_trade_no(out_trade_no);</div><div class="line">        xml.setTotal_fee(total);</div><div class="line">        xml.setSpbill_create_ip(<span class="string">"127.0.0.1"</span>);<span class="comment">//// <span class="doctag">TODO:</span> 2016/6/28</span></div><div class="line">        xml.setNotify_url(notifyUrl);</div><div class="line">        xml.setTrade_type(<span class="string">"JSAPI"</span>);</div><div class="line">        xml.setOpenid(openId);</div><div class="line">        xml.sign(encoder);</div><div class="line"></div><div class="line">        String result = restTemplate.postForObject(<span class="string">"https://api.mch.weixin.qq.com/pay/unifiedorder"</span>, xml, String.class);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 调起微信支付</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> model</div><div class="line">     * <span class="doctag">@param</span> res   预支付订单 字符串</div><div class="line">     * <span class="doctag">@param</span> url   微信支付 url</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">wechatPay</span><span class="params">(Model model, String res, String url)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Map&lt;String, String&gt; start = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">            StringBuilder startSign = <span class="keyword">new</span> StringBuilder();</div><div class="line">            Map&lt;String, String&gt; pay = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">            StringBuilder paySign = <span class="keyword">new</span> StringBuilder();</div><div class="line">            Map map = XmlHelper.of(res).toMap();</div><div class="line">            <span class="keyword">if</span> (StringUtils.equals((String) map.get(<span class="string">"return_code"</span>), <span class="string">"SUCCESS"</span>)) &#123;</div><div class="line">                <span class="comment">// 得到的预支付订单，重新生成微信支付参数</span></div><div class="line">                String prepay_id = (String) map.get(<span class="string">"prepay_id"</span>);</div><div class="line">                String jsapi_ticket = TicketManager.getDefaultTicket();</div><div class="line">                <span class="comment">// 生成 微信支付 config 参数</span></div><div class="line">                start.put(<span class="string">"appId"</span>, Global.getConfig(<span class="string">"appid"</span>));</div><div class="line">                start.put(<span class="string">"nonceStr"</span>, encoder.createNonceStr());</div><div class="line">                start.put(<span class="string">"timestamp"</span>, encoder.createTimeStamp());</div><div class="line">                <span class="comment">// 生成 config 签名</span></div><div class="line">                startSign.append(<span class="string">"jsapi_ticket="</span>).append(jsapi_ticket);</div><div class="line">                startSign.append(<span class="string">"&amp;noncestr="</span>).append(start.get(<span class="string">"nonceStr"</span>));</div><div class="line">                startSign.append(<span class="string">"&amp;timestamp="</span>).append(start.get(<span class="string">"timestamp"</span>));</div><div class="line">                startSign.append(<span class="string">"&amp;url="</span>).append(url);</div><div class="line">                start.put(<span class="string">"signature"</span>, encoder.encode(startSign.toString()));</div><div class="line"></div><div class="line">                <span class="comment">// config信息验证后会执行ready方法的参数</span></div><div class="line">                pay.put(<span class="string">"signType"</span>, <span class="string">"MD5"</span>);</div><div class="line">                pay.put(<span class="string">"packageStr"</span>, <span class="string">"prepay_id="</span> + prepay_id);</div><div class="line">                <span class="comment">// 生成支付签名</span></div><div class="line">                paySign.append(<span class="string">"appId="</span>).append(start.get(<span class="string">"appId"</span>));</div><div class="line">                paySign.append(<span class="string">"&amp;nonceStr="</span>).append(start.get(<span class="string">"nonceStr"</span>));</div><div class="line">                paySign.append(<span class="string">"&amp;package="</span>).append(pay.get(<span class="string">"packageStr"</span>));</div><div class="line">                paySign.append(<span class="string">"&amp;signType="</span>).append(pay.get(<span class="string">"signType"</span>));</div><div class="line">                paySign.append(<span class="string">"&amp;timeStamp="</span>).append(start.get(<span class="string">"timestamp"</span>));</div><div class="line">                paySign.append(<span class="string">"&amp;key="</span>).append(Global.getConfig(<span class="string">"payKey"</span>));</div><div class="line">                pay.put(<span class="string">"paySign"</span>, encoder.encode(paySign.toString()));</div><div class="line">                <span class="comment">// 将微信支参数放入 model 对象中以便前端使用</span></div><div class="line">                model.addAttribute(<span class="string">"start"</span>, start);</div><div class="line">                model.addAttribute(<span class="string">"pay"</span>, pay);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                LOGGER.error(<span class="keyword">new</span> String(PaymentKit.xmlToMap(res).get(<span class="string">"return_msg"</span>).getBytes(<span class="string">"iso8859-1"</span>)));</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            model.addAttribute(<span class="string">"wechatMessage"</span>, <span class="string">"微信授权失败!"</span>);</div><div class="line">            LOGGER.error(e.getMessage(), e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 调起微信支付</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> res 预支付订单 字符串</div><div class="line">     * <span class="doctag">@param</span> url 微信支付 url</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Map <span class="title">wechatPay</span><span class="params">(String res, String url)</span> </span>&#123;</div><div class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Map&lt;String, String&gt; start = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">            StringBuilder startSign = <span class="keyword">new</span> StringBuilder();</div><div class="line">            Map&lt;String, String&gt; pay = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">            StringBuilder paySign = <span class="keyword">new</span> StringBuilder();</div><div class="line">            Map map = XmlHelper.of(res).toMap();</div><div class="line">            <span class="keyword">if</span> (StringUtils.equals((String) map.get(<span class="string">"return_code"</span>), <span class="string">"SUCCESS"</span>)) &#123;</div><div class="line">                <span class="comment">// 得到的预支付订单，重新生成微信支付参数</span></div><div class="line">                String prepay_id = (String) map.get(<span class="string">"prepay_id"</span>);</div><div class="line">                String jsapi_ticket = TicketManager.getDefaultTicket();</div><div class="line">                <span class="comment">// 生成 微信支付 config 参数</span></div><div class="line">                start.put(<span class="string">"appId"</span>, Global.getConfig(<span class="string">"appid"</span>));</div><div class="line">                start.put(<span class="string">"nonceStr"</span>, encoder.createNonceStr());</div><div class="line">                start.put(<span class="string">"timestamp"</span>, encoder.createTimeStamp());</div><div class="line">                <span class="comment">// 生成 config 签名</span></div><div class="line">                startSign.append(<span class="string">"jsapi_ticket="</span>).append(jsapi_ticket);</div><div class="line">                startSign.append(<span class="string">"&amp;noncestr="</span>).append(start.get(<span class="string">"nonceStr"</span>));</div><div class="line">                startSign.append(<span class="string">"&amp;timestamp="</span>).append(start.get(<span class="string">"timestamp"</span>));</div><div class="line">                startSign.append(<span class="string">"&amp;url="</span>).append(url);</div><div class="line">                start.put(<span class="string">"signature"</span>, encoder.encode(startSign.toString()));</div><div class="line"></div><div class="line">                <span class="comment">// config信息验证后会执行ready方法的参数</span></div><div class="line">                pay.put(<span class="string">"signType"</span>, <span class="string">"MD5"</span>);</div><div class="line">                pay.put(<span class="string">"packageStr"</span>, <span class="string">"prepay_id="</span> + prepay_id);</div><div class="line">                <span class="comment">// 生成支付签名</span></div><div class="line">                paySign.append(<span class="string">"appId="</span>).append(start.get(<span class="string">"appId"</span>));</div><div class="line">                paySign.append(<span class="string">"&amp;nonceStr="</span>).append(start.get(<span class="string">"nonceStr"</span>));</div><div class="line">                paySign.append(<span class="string">"&amp;package="</span>).append(pay.get(<span class="string">"packageStr"</span>));</div><div class="line">                paySign.append(<span class="string">"&amp;signType="</span>).append(pay.get(<span class="string">"signType"</span>));</div><div class="line">                paySign.append(<span class="string">"&amp;timeStamp="</span>).append(start.get(<span class="string">"timestamp"</span>));</div><div class="line">                paySign.append(<span class="string">"&amp;key="</span>).append(Global.getConfig(<span class="string">"payKey"</span>));</div><div class="line">                pay.put(<span class="string">"paySign"</span>, encoder.encode(paySign.toString()));</div><div class="line">                <span class="comment">// 将微信支参数放入 result 对象中以便前端使用</span></div><div class="line">                result.put(<span class="string">"start"</span>, start);</div><div class="line">                result.put(<span class="string">"pay"</span>, pay);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                LOGGER.error(<span class="keyword">new</span> String(PaymentKit.xmlToMap(res).get(<span class="string">"return_msg"</span>).getBytes(<span class="string">"iso8859-1"</span>)));</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            result.put(<span class="string">"wechatMessage"</span>, <span class="string">"微信授权失败!"</span>);</div><div class="line">            LOGGER.error(e.getMessage(), e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 退款</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">refund</span><span class="params">(String out_refund_no,String out_trade_no,String refund_fee,String total_fee)</span> </span>&#123;</div><div class="line">        WechatRefundModel xml = <span class="keyword">new</span> WechatRefundModel();</div><div class="line">        xml.setAppid(Global.getConfig(<span class="string">"appid"</span>));</div><div class="line">        xml.setMch_id(Global.getConfig(<span class="string">"mchid"</span>));</div><div class="line">        xml.setNonce_str(encoder.createNonceStr());</div><div class="line">        xml.setOp_user_id(Global.getConfig(<span class="string">"mchid"</span>));</div><div class="line">        xml.setOut_refund_no(out_refund_no);</div><div class="line">        xml.setOut_trade_no(out_trade_no);</div><div class="line">        xml.setRefund_fee(refund_fee);</div><div class="line">        xml.setTotal_fee(total_fee);</div><div class="line">        xml.sign(encoder);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            String result = doRefund(<span class="string">"https://api.mch.weixin.qq.com/secapi/pay/refund"</span>,xml.toString());</div><div class="line">            Map map = XmlHelper.of(result).toMap();</div><div class="line">            String returnCode = (String) map.get(<span class="string">"return_code"</span>);</div><div class="line">            <span class="keyword">if</span> (returnCode.equals(<span class="string">"SUCCESS"</span>))&#123;</div><div class="line">                <span class="comment">//todo</span></div><div class="line">                LOGGER.error(<span class="string">"============================="</span>+map.get(<span class="string">"return_msg"</span>)+ <span class="string">"===================================="</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;<span class="keyword">else</span> &#123;</div><div class="line">                LOGGER.error(<span class="string">"============================="</span>+map.get(<span class="string">"return_msg"</span>)+ <span class="string">"===================================="</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</div><div class="line">            LOGGER.error(e.getMessage(), e);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span>  String <span class="title">doRefund</span><span class="params">(String url,String data)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        KeyStore keyStore  = KeyStore.getInstance(<span class="string">"PKCS12"</span>);</div><div class="line">        InputStream instream = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="string">"apiclient_cert.p12"</span>);<span class="comment">//P12文件目录</span></div><div class="line">        <span class="keyword">char</span>[] password = Global.getConfig(<span class="string">"mchid"</span>).toCharArray();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            keyStore.load(instream, password);<span class="comment">//这里写密码..默认是你的MCHID</span></div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            instream.close();</div><div class="line">        &#125;</div><div class="line">        SSLContext sslcontext = SSLContexts.custom()</div><div class="line">                .loadKeyMaterial(keyStore, password)<span class="comment">//这里也是写密码的</span></div><div class="line">                .build();</div><div class="line">        <span class="comment">// Allow TLSv1 protocol only</span></div><div class="line">        SSLConnectionSocketFactory sslsf = <span class="keyword">new</span> SSLConnectionSocketFactory(</div><div class="line">                sslcontext,</div><div class="line">                <span class="keyword">new</span> String[] &#123; <span class="string">"TLSv1"</span> &#125;,</div><div class="line">                <span class="keyword">null</span>,</div><div class="line">                SSLConnectionSocketFactory.BROWSER_COMPATIBLE_HOSTNAME_VERIFIER);</div><div class="line">        CloseableHttpClient httpclient = HttpClients.custom()</div><div class="line">                .setSSLSocketFactory(sslsf)</div><div class="line">                .build();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            HttpPost httpost = <span class="keyword">new</span> HttpPost(url); <span class="comment">// 设置响应头信息</span></div><div class="line">            httpost.addHeader(<span class="string">"Connection"</span>, <span class="string">"keep-alive"</span>);</div><div class="line">            httpost.addHeader(<span class="string">"Accept"</span>, <span class="string">"*/*"</span>);</div><div class="line">            httpost.addHeader(<span class="string">"Content-Type"</span>, <span class="string">"application/x-www-form-urlencoded; charset=UTF-8"</span>);</div><div class="line">            httpost.addHeader(<span class="string">"Host"</span>, <span class="string">"api.mch.weixin.qq.com"</span>);</div><div class="line">            httpost.addHeader(<span class="string">"X-Requested-With"</span>, <span class="string">"XMLHttpRequest"</span>);</div><div class="line">            httpost.addHeader(<span class="string">"Cache-Control"</span>, <span class="string">"max-age=0"</span>);</div><div class="line">            httpost.addHeader(<span class="string">"User-Agent"</span>, <span class="string">"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0) "</span>);</div><div class="line">            httpost.setEntity(<span class="keyword">new</span> StringEntity(data, <span class="string">"UTF-8"</span>));</div><div class="line">            CloseableHttpResponse response = httpclient.execute(httpost);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                HttpEntity entity = response.getEntity();</div><div class="line"></div><div class="line">                String jsonStr = EntityUtils.toString(response.getEntity(), <span class="string">"UTF-8"</span>);</div><div class="line">                EntityUtils.consume(entity);</div><div class="line">                <span class="keyword">return</span> jsonStr;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                response.close();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            httpclient.close();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>OrderController.java 订单控制器</h2>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> xyz.dongxiaoxia.modules.controller;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</div><div class="line"><span class="keyword">import</span> org.springframework.ui.Model;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.common.controller.BaseController;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.common.utils.DateUtils;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.entity.Clinic;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.entity.Items;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.entity.Order;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.entity.User;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.exception.OrderException;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.service.ItemsService;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.service.OrderService;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.vo.AjaxResult;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.vo.OrderStatus;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.Date;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by dongxiaoxia on 2016/12/30.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * 订单控制器</div><div class="line"> */</div><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"order"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> <span class="keyword">extends</span> <span class="title">BaseController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(OrderController.class);</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> OrderService orderService;</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> ItemsService itemsService;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 我的订单列表首页</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> 跳转订单首页</div><div class="line">     */</div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">""</span>, method = RequestMethod.GET)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">(HttpSession session, Model model)</span> </span>&#123;</div><div class="line">        User user = (User) session.getAttribute(<span class="string">"user"</span>);</div><div class="line">        Order order = <span class="keyword">new</span> Order();</div><div class="line">        order.setCreateBy(user);</div><div class="line">        <span class="comment">//查找出当前用户创建的订单列表</span></div><div class="line">        List&lt;Order&gt; orders = orderService.findList(order);</div><div class="line">        model.addAttribute(<span class="string">"orders"</span>, orders);</div><div class="line">        <span class="keyword">return</span> <span class="string">"order/index"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 订单详情</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> orderId 订单编号</div><div class="line">     * <span class="doctag">@return</span> 跳转订单详情页面</div><div class="line">     */</div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"&#123;orderId&#125;"</span>, method = RequestMethod.GET)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">detail</span><span class="params">(@PathVariable String orderId, Model model, HttpServletResponse response, HttpSession session)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        Order order = orderService.get(orderId);</div><div class="line">        User user = (User) session.getAttribute(<span class="string">"user"</span>);</div><div class="line">        <span class="keyword">if</span> (order == <span class="keyword">null</span> || !order.getCreateBy().getId().equals(user.getId())) &#123;</div><div class="line">            response.sendError(HttpServletResponse.SC_NOT_FOUND);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"><span class="comment">//        orderService.get() 查出来的order中clinic没有关联查询area，因此重新获取</span></div><div class="line">        Clinic clinic = clinicService.get(order.getClinic().getId());</div><div class="line">        order.setClinic(clinic);</div><div class="line">        model.addAttribute(<span class="string">"order"</span>, order);</div><div class="line">        <span class="keyword">return</span> <span class="string">"order/detail"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 退款</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> orderId 订单编号</div><div class="line">     * <span class="doctag">@return</span> 退款操作结果</div><div class="line">     */</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"refund/&#123;orderId&#125;"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> AjaxResult <span class="title">refund</span><span class="params">(@PathVariable String orderId, HttpSession session)</span> </span>&#123;</div><div class="line">        Order order = orderService.get(orderId);</div><div class="line">        <span class="keyword">if</span> (order == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> AjaxResult.fail(<span class="string">"订单不存在"</span>);</div><div class="line">        &#125;</div><div class="line">        User user = (User) session.getAttribute(<span class="string">"user"</span>);</div><div class="line">        <span class="keyword">if</span> (!order.getCreateBy().getId().equals(user.getId())) &#123;</div><div class="line">            <span class="keyword">return</span> AjaxResult.fail(<span class="string">"没有权限"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (OrderStatus.PAID.getCode() != order.getStatus()) &#123;</div><div class="line">            <span class="keyword">return</span> AjaxResult.fail(<span class="string">"不在退款范围"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            orderService.refund(order);</div><div class="line">            <span class="keyword">return</span> AjaxResult.success();</div><div class="line">        &#125;<span class="keyword">catch</span> (OrderException e)&#123;</div><div class="line">            LOGGER.error(e.getMessage(),e);</div><div class="line">            <span class="keyword">return</span> AjaxResult.fail(e.getMessage());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 下订单（未付款）</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> itemsId         服务项目编号</div><div class="line">     * <span class="doctag">@param</span> appointmentTime 预约时间</div><div class="line">     * <span class="doctag">@return</span> 下订单操作结果</div><div class="line">     */</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.POST)</div><div class="line">    <span class="function"><span class="keyword">public</span> AjaxResult <span class="title">add</span><span class="params">(HttpSession session, String itemsId, String appointmentTime)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(itemsId)) &#123;</div><div class="line">            <span class="keyword">return</span> AjaxResult.fail(<span class="string">"itemsId 不能为空"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(appointmentTime)) &#123;</div><div class="line">            <span class="keyword">return</span> AjaxResult.fail(<span class="string">"appointmentTime 不能为空"</span>);</div><div class="line">        &#125;</div><div class="line">        Items items = itemsService.get(itemsId);</div><div class="line">        <span class="keyword">if</span> (items == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> AjaxResult.fail(<span class="string">"该服务项目不存在"</span>);</div><div class="line">        &#125;</div><div class="line">        User user = (User) session.getAttribute(<span class="string">"user"</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Map result = orderService.add(items, appointmentTime,user); <span class="comment">//下订单</span></div><div class="line">            <span class="keyword">return</span> AjaxResult.success(result);</div><div class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</div><div class="line">            LOGGER.error(e.getMessage(),e);</div><div class="line">            <span class="keyword">return</span> AjaxResult.fail(<span class="string">"支付失败，请稍候再试"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 跳转确定订单支付页面</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> itemsId 服务项目编号</div><div class="line">     * <span class="doctag">@return</span> 支付页面</div><div class="line">     */</div><div class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"create/&#123;itemsId&#125;"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">create</span><span class="params">(@PathVariable String itemsId, Model model, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        Items items = itemsService.get(itemsId);</div><div class="line">        <span class="keyword">if</span> (items == <span class="keyword">null</span>) &#123;</div><div class="line">            response.sendError(HttpServletResponse.SC_NOT_FOUND);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        model.addAttribute(<span class="string">"items"</span>, items);</div><div class="line">        model.addAttribute(<span class="string">"dateStr"</span>, DateUtils.getDateStr(<span class="keyword">new</span> Date(), <span class="number">31</span>, <span class="string">"yyyy-MM-dd"</span>));<span class="comment">//预约日期范围（今天开始，默认一个月）</span></div><div class="line">        <span class="keyword">return</span> <span class="string">"order/create"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>OrderService.java 订单服务器</h2>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> xyz.dongxiaoxia.modules.service;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.slf4j.Logger;</div><div class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</div><div class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</div><div class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.common.config.Global;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.common.service.CrudService;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.common.utils.DateUtils;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.dao.OrderDao;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.entity.Items;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.entity.Order;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.entity.User;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.exception.OrderException;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.vo.OrderStatus;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.modules.vo.PayResult;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.weixin.TemplateMassageUtils;</div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.weixin.pay.PayService;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.text.ParseException;</div><div class="line"><span class="keyword">import</span> java.util.*;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by dongxiaoxia on 2016/12/30.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * 订单服务类</div><div class="line"> */</div><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"order"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> <span class="keyword">extends</span> <span class="title">CrudService</span>&lt;<span class="title">OrderDao</span>, <span class="title">Order</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(OrderService.class);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Timer TIMER = <span class="keyword">new</span> Timer();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_VALIDITY_TIME = Integer.valueOf(Global.getConfig(<span class="string">"payTime"</span>));<span class="comment">//默认2分钟</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String NOTIFY_URL = Global.getConfig(<span class="string">"domainName"</span>) + <span class="string">"/pay/notify"</span>;<span class="comment">//微信支付回调接口</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PAY_RESULT_URL = Global.getConfig(<span class="string">"domainName"</span>) + <span class="string">"/pay/result"</span>;<span class="comment">//微信支付结果页面接口</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PAY_BODY = <span class="string">"牙齐齐服务"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> PayService payService;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 下单（但付款）</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> items           订单对应项目</div><div class="line">     * <span class="doctag">@param</span> appointmentTime 预约时间</div><div class="line">     * <span class="doctag">@param</span> owner           订单拥有者</div><div class="line">     * <span class="doctag">@return</span> 微信支付下单结果信息集合</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Map <span class="title">add</span><span class="params">(Items items , User owner)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (items == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"items can not be null"</span>);</div><div class="line">        &#125;</div><div class="line">        Order order = <span class="keyword">new</span> Order();</div><div class="line">        order.setItems(items);</div><div class="line">        order.setPayMoney(items.getPrice());</div><div class="line">        order.setStatus(OrderStatus.NEED_PAY.getCode());</div><div class="line">        order.setPayResult(PayResult.NEED_PAY.getCode());</div><div class="line">        <span class="keyword">this</span>.save(order);</div><div class="line">        <span class="comment">//支付倒计时，定时删除未支付的订单</span></div><div class="line">        TIMER.schedule(<span class="keyword">new</span> TimeoutTask(order.getId()), DEFAULT_VALIDITY_TIME);</div><div class="line">        <span class="comment">//调用微信支付统一下单接口，获取微信支付统一订单号</span></div><div class="line">        String res = payService.unifiedorder(NOTIFY_URL, owner.getOpenId(), PAY_BODY, String.valueOf(order.getPayMoney()), order.getId());</div><div class="line">        <span class="comment">//调起微信支付，获取微信支付下单结果信息集合</span></div><div class="line">        <span class="keyword">return</span> payService.wechatPay(res, PAY_RESULT_URL);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 修改订单</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> orderId 订单编号</div><div class="line">     * <span class="doctag">@param</span> time 微信支付时间</div><div class="line">     */</div><div class="line">    <span class="meta">@Transactional</span>(readOnly = <span class="keyword">false</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(String orderId, String time)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Order order = dao.get(orderId);</div><div class="line">            <span class="keyword">if</span> (order != <span class="keyword">null</span> &amp;&amp; PayResult.SUCCESS.getCode() != order.getPayResult()) &#123;<span class="comment">//订单处于未支付成功状态</span></div><div class="line">                order.setPayResult(PayResult.SUCCESS.getCode());<span class="comment">//设置支付状态</span></div><div class="line">                order.setStatus(OrderStatus.PAID.getCode());<span class="comment">//设置订单状态</span></div><div class="line">                order.setVoucher(String.valueOf(<span class="number">10000000</span> + <span class="keyword">new</span> Random().nextInt(<span class="number">89999999</span>)));<span class="comment">//生成服务凭证，预测用户少，不会重复</span></div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    order.setCreateDate(<span class="keyword">new</span> Date(DateUtils.parseDate(time, <span class="string">"yyyyMMddHHmmss"</span>).getTime()));<span class="comment">//把订单生成时间设置为微信支付成功的时间</span></div><div class="line">                &#125; <span class="keyword">catch</span> (ParseException e) &#123;</div><div class="line">                    order.setCreateDate(<span class="keyword">new</span> Date(System.currentTimeMillis()));</div><div class="line">                &#125;</div><div class="line">                dao.update(order);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (OrderException e) &#123;</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OrderException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 退款</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> order 订单</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refund</span><span class="params">(Order order)</span> </span>&#123;</div><div class="line">        <span class="comment">//1. 微信退款</span></div><div class="line">        <span class="keyword">boolean</span> refundResult = payService.refund(order.getId(), order.getId(), String.valueOf(order.getPayMoney()), String.valueOf(order.getPayMoney()));</div><div class="line">        <span class="keyword">if</span> (!refundResult) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OrderException(<span class="string">"退款失败"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//2.处理订单</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            order.setStatus(OrderStatus.REFUNDED.getCode());</div><div class="line">            order.setRefundTime(<span class="keyword">new</span> Date());</div><div class="line">            order.setRefundedTime(<span class="keyword">new</span> Date());</div><div class="line">            save(order);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            LOGGER.error(e.getMessage(), e);</div><div class="line">            SmsUtils.notify(Global.getConfig(<span class="string">"adminMobile"</span>), order.getId(), <span class="string">"用户申请退款处理出现异常错误,请及时处理"</span>);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OrderException(<span class="string">"退款失败，请联系客服"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//3. 发消息模版给用户</span></div><div class="line">        TemplateMassageUtils.sendRefundOrderSuccessTemplateMessage(order.getCreateBy(), order);</div><div class="line">        <span class="comment">//4. 发消息模版给管理员</span></div><div class="line">        TemplateMassageUtils.sendRefundOrderSuccessTemplateMessageToAdmin(order);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 删除过期任务</div><div class="line">     */</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TimeoutTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> String orderId;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TimeoutTask</span><span class="params">(String orderId)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.orderId = orderId;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * The action to be performed by this timer task.</div><div class="line">         */</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">//删除未支付的订单</span></div><div class="line">            Order order = dao.get(orderId);</div><div class="line">            <span class="keyword">if</span> (order == <span class="keyword">null</span> || PayResult.SUCCESS.getCode() == order.getPayResult()) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            order.setId(orderId);</div><div class="line">            dao.delete(order);</div><div class="line">            LOGGER.info(<span class="string">"========================删除orderID:"</span> + orderId + <span class="string">" 订单成功！================================"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>Order.java 订单类</h2>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 实体类-订单</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">596545820416981026L</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Items items;            <span class="comment">//服务项目</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> payResult;       <span class="comment">//支付结果 (-1,"待付款"),(0, "支付成功"),(1,"支付失败")</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> payMoney;         <span class="comment">//支付金额,单位（分）</span></div><div class="line">    <span class="keyword">private</span> String voucher;         <span class="comment">//服务凭证</span></div><div class="line">    <span class="keyword">private</span> String appointmentTime; <span class="comment">//预约时段</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> status;          <span class="comment">//服务状态（-1预定，代付款 0已付款，1申请退款，2已退款，9已完成）</span></div><div class="line">    <span class="keyword">private</span> Date refundTime;        <span class="comment">//请求退款时间</span></div><div class="line">    <span class="keyword">private</span> Date refundedTime;      <span class="comment">//退款完成时间</span></div><div class="line">    <span class="keyword">private</span> Date finishTime;        <span class="comment">//服务完成时间</span></div><div class="line">    </div><div class="line">    <span class="comment">//getter and setter</span></div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h2>SignMD5.java 签名工具类</h2>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> xyz.dongxiaoxia.weixin.pay;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</div><div class="line"><span class="keyword">import</span> java.security.MessageDigest;</div><div class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</div><div class="line"><span class="keyword">import</span> java.util.Formatter;</div><div class="line"><span class="keyword">import</span> java.util.UUID;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> dongxiaoxia</div><div class="line"> * <span class="doctag">@create</span> 2016-06-28 11:08</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SignMD5</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">byteToHex</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] hash)</span> </span>&#123;</div><div class="line">        Formatter formatter = <span class="keyword">new</span> Formatter();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">byte</span> b : hash) &#123;</div><div class="line">            formatter.format(<span class="string">"%02x"</span>, b);</div><div class="line">        &#125;</div><div class="line">        String result = formatter.toString();</div><div class="line">        formatter.close();</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(CharSequence charSequence)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            MessageDigest crypt = MessageDigest.getInstance(<span class="string">"MD5"</span>);</div><div class="line">            crypt.reset();</div><div class="line">            crypt.update(charSequence.toString().getBytes(<span class="string">"UTF-8"</span>));</div><div class="line">            <span class="keyword">return</span> byteToHex(crypt.digest());</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence charSequence, String encodedPassword)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> encode(charSequence).equals(encodedPassword);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">createNonceStr</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> UUID.randomUUID().toString().replaceAll(<span class="string">"-"</span>,<span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">createTimeStamp</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Long.toString(System.currentTimeMillis() / <span class="number">1000</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>WechatNotify.java 微信支付回调结果封装</h2>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> xyz.dongxiaoxia.weixin.pay;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.xml.bind.annotation.XmlRootElement;</div><div class="line"><span class="keyword">import</span> java.io.Serializable;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> dongxiaoxia</div><div class="line"> * <span class="doctag">@create</span> 2016-06-28 11:10</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="meta">@XmlRootElement</span>(name=<span class="string">"xml"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WechatNotify</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">8047707600433551023L</span>;</div><div class="line">    <span class="keyword">private</span> String appid;</div><div class="line">    <span class="keyword">private</span> String attach;</div><div class="line">    <span class="keyword">private</span> String bank_type;</div><div class="line">    <span class="keyword">private</span> String fee_type;</div><div class="line">    <span class="keyword">private</span> String is_subscribe;</div><div class="line">    <span class="keyword">private</span> String mch_id;</div><div class="line">    <span class="keyword">private</span> String nonce_str;</div><div class="line">    <span class="keyword">private</span> String openid;</div><div class="line">    <span class="keyword">private</span> String out_trade_no;</div><div class="line">    <span class="keyword">private</span> String result_code;</div><div class="line">    <span class="keyword">private</span> String return_code;</div><div class="line">    <span class="keyword">private</span> String sign;</div><div class="line">    <span class="keyword">private</span> String sub_mch_id;</div><div class="line">    <span class="keyword">private</span> String time_end;</div><div class="line">    <span class="keyword">private</span> String total_fee;</div><div class="line">    <span class="keyword">private</span> String trade_type;</div><div class="line">    <span class="keyword">private</span> String transaction_id;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAppid</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> appid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAppid</span><span class="params">(String appid)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.appid = appid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAttach</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> attach;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAttach</span><span class="params">(String attach)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.attach = attach;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBank_type</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> bank_type;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBank_type</span><span class="params">(String bank_type)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.bank_type = bank_type;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFee_type</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> fee_type;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFee_type</span><span class="params">(String fee_type)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.fee_type = fee_type;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIs_subscribe</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> is_subscribe;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIs_subscribe</span><span class="params">(String is_subscribe)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.is_subscribe = is_subscribe;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMch_id</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mch_id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMch_id</span><span class="params">(String mch_id)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mch_id = mch_id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNonce_str</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> nonce_str;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNonce_str</span><span class="params">(String nonce_str)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.nonce_str = nonce_str;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOpenid</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> openid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOpenid</span><span class="params">(String openid)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.openid = openid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOut_trade_no</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> out_trade_no;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOut_trade_no</span><span class="params">(String out_trade_no)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.out_trade_no = out_trade_no;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getResult_code</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> result_code;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResult_code</span><span class="params">(String result_code)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.result_code = result_code;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getReturn_code</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> return_code;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReturn_code</span><span class="params">(String return_code)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.return_code = return_code;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSign</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sign;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSign</span><span class="params">(String sign)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.sign = sign;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSub_mch_id</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sub_mch_id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSub_mch_id</span><span class="params">(String sub_mch_id)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.sub_mch_id = sub_mch_id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTime_end</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> time_end;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTime_end</span><span class="params">(String time_end)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.time_end = time_end;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTotal_fee</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> total_fee;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTotal_fee</span><span class="params">(String total_fee)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.total_fee = total_fee;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTrade_type</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> trade_type;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTrade_type</span><span class="params">(String trade_type)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.trade_type = trade_type;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTransaction_id</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> transaction_id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTransaction_id</span><span class="params">(String transaction_id)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.transaction_id = transaction_id;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>WechatPayModel.java 微信支付统一订单接口参数封装模型</h2>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> xyz.dongxiaoxia.weixin.pay;</div><div class="line"></div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.common.config.Global;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.xml.bind.annotation.XmlRootElement;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> dongxiaoxia</div><div class="line"> * <span class="doctag">@create</span> 2016-06-28 11:11</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="meta">@XmlRootElement</span>(name = <span class="string">"XML"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WechatPayModel</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String appid;</div><div class="line">    <span class="keyword">private</span> String mch_id;</div><div class="line">    <span class="keyword">private</span> String nonce_str;</div><div class="line">    <span class="keyword">private</span> String body;</div><div class="line">    <span class="keyword">private</span> String out_trade_no;</div><div class="line">    <span class="keyword">private</span> String total_fee;</div><div class="line">    <span class="keyword">private</span> String spbill_create_ip;</div><div class="line">    <span class="keyword">private</span> String notify_url;</div><div class="line">    <span class="keyword">private</span> String trade_type;</div><div class="line">    <span class="keyword">private</span> String openid;</div><div class="line">    <span class="keyword">private</span> String sign;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAppid</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> appid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAppid</span><span class="params">(String appid)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.appid = appid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMch_id</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mch_id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMch_id</span><span class="params">(String mch_id)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mch_id = mch_id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNonce_str</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> nonce_str;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNonce_str</span><span class="params">(String nonce_str)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.nonce_str = nonce_str;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOut_trade_no</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> out_trade_no;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOut_trade_no</span><span class="params">(String out_trade_no)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.out_trade_no = out_trade_no;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTotal_fee</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> total_fee;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTotal_fee</span><span class="params">(String total_fee)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.total_fee = total_fee;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSpbill_create_ip</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> spbill_create_ip;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSpbill_create_ip</span><span class="params">(String spbill_create_ip)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.spbill_create_ip = spbill_create_ip;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNotify_url</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> notify_url;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNotify_url</span><span class="params">(String notify_url)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.notify_url = notify_url;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTrade_type</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> trade_type;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTrade_type</span><span class="params">(String trade_type)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.trade_type = trade_type;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBody</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> body;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBody</span><span class="params">(String body)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.body = body;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSign</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sign;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSign</span><span class="params">(String sign)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.sign = sign;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOpenid</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> openid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOpenid</span><span class="params">(String openid)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.openid = openid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sign</span><span class="params">(SignMD5 encoder)</span> </span>&#123;</div><div class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">        stringBuilder.append(<span class="string">"appid="</span>).append(getAppid());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;body="</span>).append(getBody());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;mch_id="</span>).append(getMch_id());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;nonce_str="</span>).append(getNonce_str());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;notify_url="</span>).append(getNotify_url());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;openid="</span>).append(getOpenid());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;out_trade_no="</span>).append(getOut_trade_no());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;spbill_create_ip="</span>).append(getSpbill_create_ip());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;total_fee="</span>).append(getTotal_fee());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;trade_type="</span>).append(getTrade_type());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;key="</span>).append(Global.getConfig(<span class="string">"payKey"</span>));</div><div class="line">        <span class="keyword">this</span>.sign = encoder.encode(stringBuilder.toString());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"&lt;xml&gt;"</span> +</div><div class="line">                <span class="string">"&lt;appid&gt;&lt;![CDATA["</span> + appid + <span class="string">"]]&gt;&lt;/appid&gt;"</span> +</div><div class="line">                <span class="string">"&lt;body&gt;&lt;![CDATA["</span> + body + <span class="string">"]]&gt;&lt;/body&gt;"</span> +</div><div class="line">                <span class="string">"&lt;mch_id&gt;&lt;![CDATA["</span> + mch_id + <span class="string">"]]&gt;&lt;/mch_id&gt;"</span> +</div><div class="line">                <span class="string">"&lt;nonce_str&gt;&lt;![CDATA["</span> + nonce_str + <span class="string">"]]&gt;&lt;/nonce_str&gt;"</span> +</div><div class="line">                <span class="string">"&lt;notify_url&gt;&lt;![CDATA["</span> + notify_url + <span class="string">"]]&gt;&lt;/notify_url&gt;"</span> +</div><div class="line">                <span class="string">"&lt;openid&gt;&lt;![CDATA["</span> + openid + <span class="string">"]]&gt;&lt;/openid&gt;"</span> +</div><div class="line">                <span class="string">"&lt;out_trade_no&gt;&lt;![CDATA["</span> + out_trade_no + <span class="string">"]]&gt;&lt;/out_trade_no&gt;"</span> +</div><div class="line">                <span class="string">"&lt;spbill_create_ip&gt;&lt;![CDATA["</span> + spbill_create_ip + <span class="string">"]]&gt;&lt;/spbill_create_ip&gt;"</span> +</div><div class="line">                <span class="string">"&lt;trade_type&gt;&lt;![CDATA["</span> + trade_type + <span class="string">"]]&gt;&lt;/trade_type&gt;"</span> +</div><div class="line">                <span class="string">"&lt;total_fee&gt;&lt;![CDATA["</span> + total_fee + <span class="string">"]]&gt;&lt;/total_fee&gt;"</span> +</div><div class="line">                <span class="string">"&lt;sign&gt;&lt;![CDATA["</span> + sign + <span class="string">"]]&gt;&lt;/sign&gt;"</span> +</div><div class="line">                <span class="string">"&lt;/xml&gt;"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>WechatRefundModel.java 微信退款接口参数封装模型</h2>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> xyz.dongxiaoxia.weixin.pay;</div><div class="line"></div><div class="line"><span class="keyword">import</span> xyz.dongxiaoxia.common.config.Global;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.xml.bind.annotation.XmlRootElement;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> dongxiaoxia</div><div class="line"> * <span class="doctag">@create</span> 2017-01-03 20:30</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="meta">@XmlRootElement</span>(name = <span class="string">"XML"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WechatRefundModel</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String appid;</div><div class="line">    <span class="keyword">private</span> String mch_id;</div><div class="line">    <span class="keyword">private</span> String nonce_str;</div><div class="line">    <span class="keyword">private</span> String op_user_id;</div><div class="line">    <span class="keyword">private</span> String out_refund_no;</div><div class="line">    <span class="keyword">private</span> String out_trade_no;</div><div class="line">    <span class="keyword">private</span> String refund_fee;</div><div class="line">    <span class="keyword">private</span> String sign;</div><div class="line">    <span class="keyword">private</span> String total_fee;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAppid</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> appid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAppid</span><span class="params">(String appid)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.appid = appid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMch_id</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mch_id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMch_id</span><span class="params">(String mch_id)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mch_id = mch_id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNonce_str</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> nonce_str;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNonce_str</span><span class="params">(String nonce_str)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.nonce_str = nonce_str;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOp_user_id</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> op_user_id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOp_user_id</span><span class="params">(String op_user_id)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.op_user_id = op_user_id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOut_refund_no</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> out_refund_no;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOut_refund_no</span><span class="params">(String out_refund_no)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.out_refund_no = out_refund_no;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOut_trade_no</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> out_trade_no;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOut_trade_no</span><span class="params">(String out_trade_no)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.out_trade_no = out_trade_no;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRefund_fee</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> refund_fee;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRefund_fee</span><span class="params">(String refund_fee)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.refund_fee = refund_fee;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTotal_fee</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> total_fee;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTotal_fee</span><span class="params">(String total_fee)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.total_fee = total_fee;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSign</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sign;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSign</span><span class="params">(String sign)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.sign = sign;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sign</span><span class="params">(SignMD5 encoder)</span> </span>&#123;</div><div class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">        stringBuilder.append(<span class="string">"appid="</span>).append(getAppid());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;mch_id="</span>).append(getMch_id());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;nonce_str="</span>).append(getNonce_str());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;op_user_id="</span>).append(getOp_user_id());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;out_refund_no="</span>).append(getOut_refund_no());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;out_trade_no="</span>).append(getOut_trade_no());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;refund_fee="</span>).append(getRefund_fee());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;total_fee="</span>).append(getTotal_fee());</div><div class="line">        stringBuilder.append(<span class="string">"&amp;key="</span>).append(Global.getConfig(<span class="string">"payKey"</span>));</div><div class="line">        <span class="keyword">this</span>.sign = encoder.encode(stringBuilder.toString());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"&lt;xml&gt;"</span> +</div><div class="line">                <span class="string">"&lt;appid&gt;&lt;![CDATA["</span> + appid + <span class="string">"]]&gt;&lt;/appid&gt;"</span> +</div><div class="line">                <span class="string">"&lt;mch_id&gt;&lt;![CDATA["</span> + mch_id + <span class="string">"]]&gt;&lt;/mch_id&gt;"</span> +</div><div class="line">                <span class="string">"&lt;nonce_str&gt;&lt;![CDATA["</span> + nonce_str + <span class="string">"]]&gt;&lt;/nonce_str&gt;"</span> +</div><div class="line">                <span class="string">"&lt;op_user_id&gt;&lt;![CDATA["</span> + op_user_id + <span class="string">"]]&gt;&lt;/op_user_id&gt;"</span> +</div><div class="line">                <span class="string">"&lt;out_refund_no&gt;&lt;![CDATA["</span> + out_refund_no + <span class="string">"]]&gt;&lt;/out_refund_no&gt;"</span> +</div><div class="line">                <span class="string">"&lt;out_trade_no&gt;&lt;![CDATA["</span> + out_trade_no + <span class="string">"]]&gt;&lt;/out_trade_no&gt;"</span> +</div><div class="line">                <span class="string">"&lt;refund_fee&gt;&lt;![CDATA["</span> + refund_fee + <span class="string">"]]&gt;&lt;/refund_fee&gt;"</span> +</div><div class="line">                <span class="string">"&lt;total_fee&gt;&lt;![CDATA["</span> + total_fee + <span class="string">"]]&gt;&lt;/total_fee&gt;"</span> +</div><div class="line">                <span class="string">"&lt;sign&gt;&lt;![CDATA["</span> + sign + <span class="string">"]]&gt;&lt;/sign&gt;"</span> +</div><div class="line">                <span class="string">"&lt;/xml&gt;"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

    

    
</div>


                

                <!-- Post Comments -->
                
                    







                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/01/16/2017-01-16-DIY-a-simple-two-way-list/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/01/19/expenses-analysis-2016/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="John Doe's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        youremail@email.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/04/">四月 2017<span class="sidebar_archives-count">28</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">三月 2017<span class="sidebar_archives-count">37</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">二月 2017<span class="sidebar_archives-count">12</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/01/">一月 2017<span class="sidebar_archives-count">12</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">十二月 2016<span class="sidebar_archives-count">18</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">24</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">39</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">32</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/08/">八月 2016<span class="sidebar_archives-count">32</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">七月 2016<span class="sidebar_archives-count">21</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/06/">六月 2016<span class="sidebar_archives-count">33</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/05/">五月 2016<span class="sidebar_archives-count">20</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/04/">四月 2016<span class="sidebar_archives-count">15</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/03/">三月 2016<span class="sidebar_archives-count">19</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/02/">二月 2016<span class="sidebar_archives-count">16</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/01/">一月 2016<span class="sidebar_archives-count">19</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/12/">十二月 2015<span class="sidebar_archives-count">20</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/11/">十一月 2015<span class="sidebar_archives-count">30</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/10/">十月 2015<span class="sidebar_archives-count">30</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/09/">九月 2015<span class="sidebar_archives-count">27</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/08/">八月 2015<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/07/">七月 2015<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/06/">六月 2015<span class="sidebar_archives-count">10</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/05/">五月 2015<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/04/">四月 2015<span class="sidebar_archives-count">11</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/03/">三月 2015<span class="sidebar_archives-count">10</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/02/">二月 2015<span class="sidebar_archives-count">14</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/01/">一月 2015<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/12/">十二月 2014<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/11/">十一月 2014<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/10/">十月 2014<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/09/">九月 2014<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/08/">八月 2014<span class="sidebar_archives-count">9</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/07/">七月 2014<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/06/">六月 2014<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/05/">五月 2014<span class="sidebar_archives-count">11</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/04/">四月 2014<span class="sidebar_archives-count">32</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/03/">三月 2014<span class="sidebar_archives-count">34</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/02/">二月 2014<span class="sidebar_archives-count">14</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/01/">一月 2014<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/12/">十二月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/07/">七月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/06/">六月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/04/">四月 2013<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/03/">三月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/02/">二月 2013<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/01/">一月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/12/">十二月 2012<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/10/">十月 2012<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/09/">九月 2012<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/07/">七月 2012<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/06/">六月 2012<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/05/">五月 2012<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/08/">八月 2011<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/07/">七月 2011<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/06/">六月 2011<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/05/">五月 2011<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/04/">四月 2011<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/03/">三月 2011<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/02/">二月 2011<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/12/">十二月 2010<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/11/">十一月 2010<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/09/">九月 2010<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/07/">七月 2010<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/06/">六月 2010<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/02/">二月 2010<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/01/">一月 2010<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/09/">九月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/07/">七月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/05/">五月 2009<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/04/">四月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/03/">三月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/02/">二月 2009<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2008/07/">七月 2008<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2008/06/">六月 2008<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-twitter.svg);">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-facebook.svg);">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-gplus.svg);">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;Hexo
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->

    <script src="/js/lazyload.min.js"></script>
    <script src="/js/js.min.js"></script>



    <script src="/js/nprogress.js"></script>


<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>
















<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script>
    <!-- Offer LazyLoad -->
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    <!-- Start Queue -->
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

                </main>
            </div>
        </body>
    
</html>
