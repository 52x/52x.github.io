<!DOCTYPE html>
<html lang="zh">
    <head>
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.4 -->

    <!-- Title -->
    
    <title>
        
            自制一款强大的 ActionSheet | 
        
        Hexo
    </title>

    <!-- Meta & Info -->
    <meta charset="utf-8">

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    

    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="John Doe">
    <meta name="description" content="null">
    <meta name="keywords" content="null,iOS">

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Hexo">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="自制一款强大的 ActionSheet | Hexo">
    <meta property="og:description" content="null">
    <meta property="og:article:tag" content="iOS"> 

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS & jQuery -->
    
        <link rel="stylesheet" href="/css/material.min.css">
        <link rel="stylesheet" href="/css/style.min.css">
        <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


        <script src="/js/jquery.min.js"></script>
        <script src="/js/queue.js"></script>
    

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    


    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">1.</span> <span class="post-toc-text">为何要造这个轮子</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">2.</span> <span class="post-toc-text">界面组成</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">背景</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">容器</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">标题&消息</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">自定义视图</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">2.5.</span> <span class="post-toc-text">按钮</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.</span> <span class="post-toc-text">接口实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">初始化</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">添加按钮</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">show</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.3.1.</span> <span class="post-toc-text">setupNewWindow</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.3.1.1.</span> <span class="post-toc-text">Autorotation</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.3.1.2.</span> <span class="post-toc-text">interruptGesture</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.3.1.3.</span> <span class="post-toc-text">TBActionSheetController</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.3.2.</span> <span class="post-toc-text">setupLayout</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.3.3.</span> <span class="post-toc-text">setupStyle</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.3.3.1.</span> <span class="post-toc-text">BlurEffect & Separator</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.3.3.1.1.</span> <span class="post-toc-text">截屏</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.3.3.1.2.</span> <span class="post-toc-text">ambientColor</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.3.3.1.3.</span> <span class="post-toc-text">Separator</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.3.3.2.</span> <span class="post-toc-text">RectCorner</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.3.3.3.</span> <span class="post-toc-text">setupContainerFrame</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.3.4.</span> <span class="post-toc-text">动画</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">close & buttonTapped</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.</span> <span class="post-toc-text">一些细节</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">Marco</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.1.1.</span> <span class="post-toc-text">UI_APPEARANCE_SELECTOR</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.1.2.</span> <span class="post-toc-text">NS_UNAVAILABLE</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.1.3.</span> <span class="post-toc-text">NS_ASSUME_NONNULL_BEGIN（_END）</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">动态配置</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.</span> <span class="post-toc-text">属性</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">尺寸</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">样式</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.3.</span> <span class="post-toc-text">状态</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.4.</span> <span class="post-toc-text">内容</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.5.</span> <span class="post-toc-text">标记</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.6.</span> <span class="post-toc-text">动画&朝向</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.7.</span> <span class="post-toc-text">属性存取器</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">6.</span> <span class="post-toc-text">后记</span></a></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                自制一款强大的 ActionSheet
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>John Doe</strong>
        <span>7月 18, 2016</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/iOS/">iOS</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=自制一款强大的 ActionSheet&url=http://yoursite.com//2016/07/18/2016-07-18-TBActionSheet/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=自制一款强大的 ActionSheet&url=http://yoursite.com//2016/07/18/2016-07-18-TBActionSheet/index.html&via=John Doe" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com//2016/07/18/2016-07-18-TBActionSheet/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com//2016/07/18/2016-07-18-TBActionSheet/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <p>iOS 系统自带的 <code>UIActionSheet</code> 无法满足开发中高度个性化的 UI 风格和代码风格，所以我决定自己动手丰衣足食，于是 <a href="https://github.com/yulingtianxia/TBActionSheet" target="_blank" rel="external"><code>TBActionSheet</code></a> 诞生了：</p>
<p>&lt;img src=&quot;https://github.com/yulingtianxia/TBActionSheet/blob/master/images/demo.gif?raw=true&quot; width=&quot;50%&quot; height=&quot;50%&quot;&gt;</p>
<p>Github：https://github.com/yulingtianxia/TBActionSheet</p>
<p><a href="https://github.com/yulingtianxia/TBActionSheet" target="_blank" rel="external"><code>TBActionSheet</code></a> 不仅还原了 <code>UIActionSheet</code> 的几乎所有功能和 API，还在此基础上支持如下功能：</p>
<ol>
<li>block 语法</li>
<li>插入自定义的 Header 视图</li>
<li>自定义字体、颜色、尺寸、圆角等</li>
<li>将毛玻璃效果支持到了 iOS7，且可以定义颜色</li>
<li>支持 Cocoapods 和 Carthage</li>
<li>支持在 Title 下面设置 Message</li>
<li>支持点击背景关闭</li>
<li>可以在显示后动态更新 UI</li>
</ol>
<p>&lt;!--more--&gt;</p>
<h1>为何要造这个轮子</h1>
<p>可能上午视觉同学要求所有系统版本的 ActionSheet 都要做成 iOS9 的圆角样式，下午就推翻做成跟微信一模一样，晚上又觉得微信的好丑风格不搭。。。如何以不变应万变？自己造个万能轮子！</p>
<p>其实有一些开源的 ActionSheet，但都不满足我的要求：<strong>高度个性化，私人定制</strong>，而且<strong>几乎其他开源的 ActionSheet 都不支持自动旋转，只支持竖屏不能横屏</strong>。而系统的 <code>UIActionSheet</code> 是支持这个功能的。<a href="https://github.com/yulingtianxia/TBActionSheet" target="_blank" rel="external"><code>TBActionSheet</code></a> 做到在 iOS8+ 上的旋转屏幕适配，之所以不兼容 iOS7+ 是因为 iOS7 和 iOS8+ 的旋转机制和坐标体系有较大差别，总结为一个字：<strong>懒</strong>！</p>
<p>其实造这个轮子的原因还真就是因为<strong>懒</strong>！因为视觉同学经常会调整风格，改来改去真的会产生大量废弃的冗余代码，因为怕未来某个时间点又被改回去，所以不敢删代码只好注释掉。<strong>我就是要做个高度个性化的组件，每次修改 UI 只需要修改几个属性就可以</strong>。</p>
<p>针对上面功能列表列出的第 1 条和第 6 条，系统的 <code>UIAlertController</code> 也可以办得到，但缺点是只能在 iOS8+ 使用。而 <code>UIActionSheet</code> 和 <code>UIAlertView</code> 却在 iOS8.3 被废弃，这是个青黄不接的年代，为此我曾经开发了 <code>TBAlertController</code> 来兼容高低各种版本的系统，实现原理在 <a href="http://yulingtianxia.com/blog/2015/11/13/Summary-of-the-first-month-in-the-internship-of-Tencent/" target="_blank" rel="external">腾讯实习第一个月工作总结</a> 有详细讲解。<code>TBAlertController</code> 使用的都是系统控件，不可定制，但也被我集成到了 <a href="https://github.com/yulingtianxia/TBActionSheet" target="_blank" rel="external"><code>TBActionSheet</code></a> 项目中。</p>
<p>在做到功能强大高度个性化的同时也要注重对系统控件原有 API 的最大还原，在绝大多数情况下只需要将代码中的 <code>UI</code> 替换成 <code>TB</code> 即可，降低改动成本。</p>
<h1>界面组成</h1>
<p>从 UI 上大致划分成几个区域，它们都在 <code>TBActionSheet</code> 的视图层级树中：</p>
<ol>
<li><code>TBActionBackground</code> 为半透明背景</li>
<li><code>TBActionContainer</code> 是容纳 Sheet 视图的容器</li>
<li><code>titleLabel</code> 和 <code>messageLabel</code> 属性是标题和消息，类型为 <code>UILabel</code></li>
<li><code>customView</code> 属性是个普通的 <code>UIView</code>，供使用者传入自定义视图</li>
<li><code>TBActionButton</code> 是对应着每个 Action 的按钮</li>
</ol>
<p><img src="http://7ni3rk.com1.z0.glb.clouddn.com/TBActionSheet/overview.jpg" alt="视图层级"></p>
<p>所有的坐标和尺寸都是代码计算出来的，没有用自动布局，容器的大小是根据其子视图的 frame 决定的，这其中包含很多计算。</p>
<p>在实际使用时只需使用 <code>TBActionSheet</code> 就可以了，所以上面提到的类都是幕后工作者。我将会讲述每部分具体实现和一些功能点的实现。</p>
<h2>背景</h2>
<p>背景是 <code>TBActionSheet</code> 的子视图中最底层的视图。</p>
<p><code>TBActionBackground</code> 继承于 <code>UIImageView</code>，虽然目前只是个拥有半透明黑色的可相应点击事件的视图，但是考虑到拓展性，允许使用者在背景上设置图片。</p>
<p>点击背景后会调用父视图 <code>TBActionSheet</code> 的 <code>close</code> 方法关闭，后续会有详述。</p>
<h2>容器</h2>
<p>我在实现的时候没有使用自动布局，而是自己计算 frame。容器的作用是把一系列内容包装起来，方便计算 frame。<code>TBActionContainer</code> 容纳了整个 ActionSheet 的主体功能视图，系统的毛玻璃效果也是在这添加的。</p>
<p><code>TBActionSheet</code> 中好多属性其实并不是作为 <code>TBActionSheet</code> 的子视图，而是 <code>TBActionContainer</code> 的子视图，比如：<code>titleLabel</code>、<code>messageLabel</code>、<code>customView</code> 以及<code>buttons</code> 数组中的 <code>TBActionButton</code> 对象。既然这些视图都是容器的子视图，为何不在容器中声明对应的属性呢？目的是尽量将视图暴露给 <code>TBActionSheet</code> 上集中处理，也方便对外集中提供属性和接口。</p>
<p><code>TBActionContainer</code> 中有对 <code>TBActionSheet</code> 的弱引用，目的是便于获取一些属性值。</p>
<p>容器从上到下依次为 <code>header</code>，<code>custom</code>，<code>footer</code> 以及 <code>buttons</code> 和 <code>separators</code> 数组。Separator 指的是按钮之间的空隙，可以设置背景颜色。也就是说容器下面还有几个小容器，比如 <code>header</code> 容纳标题和消息，<code>custom</code> 容纳自定义视图，而 <code>footer</code> 目前是空的，仅作为拓展。</p>
<p><code>TBActionContainer</code> 继承于 <code>UIImageView</code>，<code>header</code>，<code>custom</code>，<code>footer</code> 类型也都是 <code>UIImageView</code>。这是为了实现毛玻璃效果，后续会有详述。</p>
<h2>标题&amp;消息</h2>
<p>系统的 <code>UIActionSheet</code> 只支持标题没有消息，但可以通过换行的方式伪装下标题和消息。我这里当然是用两个 <code>UILabel</code> 来实现标题和消息的啦，字体颜色也尽量还原 <code>UIAlertController</code> 的样式。</p>
<p><code>TBActionSheet</code> 的 <code>titleLabel</code> 和 <code>messageLabel</code> 属性是 <code>readonly</code> 的，它们都是 <code>TBActionContainer</code> 的 <code>header</code> 属性的子视图。</p>
<h2>自定义视图</h2>
<p><code>TBActionSheet</code> 的 <code>customView</code> 属性可供使用者传入一个 <code>UIView</code> 对象，它是 <code>TBActionContainer</code> 的 <code>custom</code> 属性的子视图。自定义视图能够接收到触摸事件。</p>
<h2>按钮</h2>
<p>所有的按钮都存储于 <code>TBActionSheet</code> 的 <code>buttons</code> 数组中，类型为 <code>TBActionButton</code>。</p>
<p><code>TBActionButton</code> 继承于 <code>UIButton</code>，有三种 <code>style</code>：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">typedef NS_ENUM(NSInteger, TBActionButtonStyle) &#123;</div><div class="line">    TBActionButtonStyleDefault = 0,</div><div class="line">    TBActionButtonStyleCancel,</div><div class="line">    TBActionButtonStyleDestructive</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p><code>TBActionButton</code> 还提供了 <code>normalColor</code> 和 <code>highlightedColor</code> 属性，用于设置按钮不同状态下的颜色。如果开启了毛玻璃效果且让 Container 的背景透明，那就需要为容器中每个单独的视图添加毛玻璃效果，所以每个按钮背后都需要分别放置一个同等大小的视图用于毛玻璃效果和变换颜色。<code>behindColorView</code> 属性就是设置颜色的视图。在按钮高亮时它的 <code>alpha</code> 会被设成 0.5。有关毛玻璃效果具体实现细节后续会详述。</p>
<p>为了支持 block 语法，<code>TBActionButton</code> 内部保留了一个只读的 block 属性 <code>handler</code>，而设置 block 只能通过它的工厂方法，实现如下：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)buttonWithTitle:(NSString *)title style:(TBActionButtonStyle)style handler:(void (^ __nullable)( TBActionButton * _Nonnull button))handler</div><div class="line">&#123;</div><div class="line">    TBActionButton *button = [TBActionButton buttonWithType:UIButtonTypeCustom];</div><div class="line">    button.style = style;</div><div class="line">    button.handler = handler;</div><div class="line">    button.clipsToBounds = YES;</div><div class="line">    [button setTitle:title forState:UIControlStateNormal];</div><div class="line">    [button setBackgroundColor:[UIColor clearColor]];</div><div class="line">    [button.titleLabel setFont:[UIFont systemFontOfSize:20]];</div><div class="line">    return button;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>除了这个版本的工厂方法，还有个不提供 <code>handler</code> 参数的版本：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)buttonWithTitle:(NSString *)title style:(TBActionButtonStyle)style;</div></pre></td></tr></table></figure></p>
<p>至于 block 的属性内存管理语义是用 <code>strong</code> 还是 <code>copy</code>，其实这是个历史问题，在 MRC 时代是需要用 <code>copy</code> 的，因为 ARC 会自动帮我们进行 <code>copy</code>，所以这里用 <code>strong</code> 也可以。苹果官方的态度比较换旧，建议仍然使用 <code>copy</code>，虽然这并没什么乱用。</p>
<p>因为按钮的数量毕竟有限，对于按钮圆角的实现就不需要考虑性能问题了。有关圆角的这部分后续会有专门一节叙述。</p>
<h1>接口实现</h1>
<p><code>TBActionSheet</code> 具有 <code>UIActionSheet</code> 的<strong>几乎</strong>所有接口和属性，可以说前者是后者的超集。之所以说『几乎』，是因为我在 <code>UIWindow</code> 上模态显示 ActionSheet，相当于 <code>UIAlertController</code> 的做法，于是以下 <code>UIActionSheet</code> 的接口我目前并没有实现：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (void)showFromToolbar:(UIToolbar *)view;</div><div class="line">- (void)showFromTabBar:(UITabBar *)view;</div><div class="line">- (void)showFromBarButtonItem:(UIBarButtonItem *)item animated:(BOOL)animated ;</div><div class="line">- (void)showFromRect:(CGRect)rect inView:(UIView *)view animated:(BOOL)animated;</div><div class="line">- (void)showInView:(UIView *)view;</div></pre></td></tr></table></figure></p>
<p>除此之外 <code>UIActionSheet</code> 的属性和接口在 <code>TBActionSheet</code> 都有山寨，只是把 <code>UI</code> 换成了 <code>TB</code>，比如 <code>delegate</code></p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property(nullable,nonatomic,weak) id&lt;TBActionSheetDelegate&gt; delegate;</div></pre></td></tr></table></figure></p>
<p><code>TBActionSheetDelegate</code> 中的方法跟 <code>UIActionSheetDelegate</code> 中的方法 selector 完全一样。</p>
<h2>初始化</h2>
<p>初始化方法的设计延续了 <code>UIActionSheet</code> 的接口，在此基础上还加了个带有 <code>message</code> 参数的方法。<strong>为了减少冗余代码，实现高内聚低耦合的设计模式，一般会写一个参数最多功能最全的方法，其他参数少的方法去调用前者</strong>。这种层层 Forward 参数的方式在 API 设计中很常见。由于这两个方法都带有可变参数，且<strong>不能在一个带有可变参数的方法中直接调用另一个带有可变参数的方法</strong>。因为函数参数入栈或者存入寄存器的方式都是有规可循的，我也曾尝试过在 x86-64 下找出指针固定的偏移量，遵循 x86-64 calling convention 下的可变参数调用从而修正 <code>va_list</code> 结构体的值。x86 下 <code>va_list</code> 是个 <code>char *</code>，而 x86-64 架构下 <code>va_list</code> 是个结构体：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">typedef struct &#123;</div><div class="line">   unsigned int gp_offset;</div><div class="line">   unsigned int fp_offset;</div><div class="line">   void *overflow_arg_area;</div><div class="line">   void *reg_save_area;</div><div class="line">&#125; va_list[1];</div></pre></td></tr></table></figure></p>
<p>我当时正是给结构体中的数据加上一段位移，使其在可变参数函数之间调用时不 crash，但这样意义不大。关于 <code>va_list</code> 与 calling convention 的细节可以参考 <a href="http://blog.csdn.net/videosender/article/details/6425671" target="_blank" rel="external">c/c++ 里面的变长参数的实现</a> 和 <a href="http://stackoverflow.com/questions/4958384/what-is-the-format-of-the-x86-64-va-list-structure" target="_blank" rel="external">System V Application Binary Interface</a> 第52页，这里不再做延伸。</p>
<p>简单的做法是写一个方法接受参数类型为 <code>va_list</code>，将大部分公共逻辑写在里面。这些公共逻辑包括调用 <code>init</code>，给 <code>title</code>、<code>message</code> 和 <code>delegate</code>属性赋值，添加 Cancel 和 Destructive 按钮，遍历 <code>va_list</code> 添加按钮：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">- (instancetype)initWithTitle:(NSString *)title message:(nullable NSString *)message delegate:(id&lt;TBActionSheetDelegate&gt;)delegate cancelButtonTitle:(nullable NSString *)cancelButtonTitle destructiveButtonTitle:(nullable NSString *)destructiveButtonTitle firstOtherButtonTitle:(NSString *)firstOtherButtonTitle titleList:(va_list)argList</div><div class="line">&#123;</div><div class="line">    self = [self init];</div><div class="line">    if (self) &#123;</div><div class="line">        _title = title;</div><div class="line">        _message = message;</div><div class="line">        _delegate = delegate;</div><div class="line">        </div><div class="line">        if (destructiveButtonTitle) &#123;</div><div class="line">            _destructiveButtonIndex = [self addButtonWithTitle:destructiveButtonTitle style:TBActionButtonStyleDestructive];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        if (firstOtherButtonTitle) &#123;// 第一个参数 firstOtherButtonTitle 是不属于参数列表的,</div><div class="line">            [self addButtonWithTitle:firstOtherButtonTitle style:TBActionButtonStyleDefault];</div><div class="line">            NSString* eachArg;</div><div class="line">            while ((eachArg = va_arg(argList, NSString*))) &#123;// 从 args 中遍历出参数，NSString* 指明类型</div><div class="line">                [self addButtonWithTitle:eachArg style:TBActionButtonStyleDefault];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        if (cancelButtonTitle) &#123;</div><div class="line">            _cancelButtonIndex = [self addButtonWithTitle:cancelButtonTitle style:TBActionButtonStyleCancel];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>因为第一个参数不包含在 <code>va_list</code> 中，所以也需要把第一个参数传入。<code>va_arg (va_list ap, type)</code> 像个迭代器一样每次根据 <code>type</code> 计算位移获取参数并更新 <code>va_list</code>。 <code>va_list</code> 的初始化是用 <code>va_start</code> 宏初始化的，并以 <code>va_end</code> 宏结束。有关这些宏的定义，详见 <a href="http://www.cplusplus.com/reference/cstdarg/" target="_blank" rel="external">stdarg.h</a> 和 <a href="http://blog.csdn.net/edonlii/article/details/8497704" target="_blank" rel="external">这篇文章</a>。</p>
<p>于是那两个可变参数的初始化方法代码大大减少，调用上面的方法就可以。这样先将可变参数内容初始化到 <code>va_list</code> 中再传参调动的方式避免了 calling convention 的问题：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">- (instancetype)initWithTitle:(NSString *)title delegate:(id&lt;TBActionSheetDelegate&gt;)delegate cancelButtonTitle:(nullable NSString *)cancelButtonTitle destructiveButtonTitle:(nullable NSString *)destructiveButtonTitle otherButtonTitles:(nullable NSString *)otherButtonTitles, ... NS_REQUIRES_NIL_TERMINATION</div><div class="line">&#123;</div><div class="line">    va_list argList;</div><div class="line">    // 从 otherButtonTitles 开始遍历参数，不包括 otherButtonTitles 本身.</div><div class="line">    va_start(argList, otherButtonTitles);</div><div class="line">    self = [self initWithTitle:title message:nil delegate:delegate cancelButtonTitle:cancelButtonTitle destructiveButtonTitle:destructiveButtonTitle firstOtherButtonTitle:otherButtonTitles titleList:argList];</div><div class="line">    va_end(argList);</div><div class="line">    return self;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (instancetype)initWithTitle:(NSString *)title message:(nullable NSString *)message delegate:(id&lt;TBActionSheetDelegate&gt;)delegate cancelButtonTitle:(nullable NSString *)cancelButtonTitle destructiveButtonTitle:(nullable NSString *)destructiveButtonTitle otherButtonTitles:(nullable NSString *)otherButtonTitles, ... NS_REQUIRES_NIL_TERMINATION</div><div class="line">&#123;</div><div class="line">    va_list argList;</div><div class="line">    // 从 otherButtonTitles 开始遍历参数，不包括 otherButtonTitles 本身.</div><div class="line">    va_start(argList, otherButtonTitles);</div><div class="line">    self = [self initWithTitle:title message:message delegate:delegate cancelButtonTitle:cancelButtonTitle destructiveButtonTitle:destructiveButtonTitle firstOtherButtonTitle:otherButtonTitles titleList:argList];</div><div class="line">    va_end(argList);</div><div class="line">    return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为了减少冗余代码我也是拼了。。。下面继续说 <code>init</code> 方法。主要工作是对一些属性的初始化工作，并将背景和容器依次添加为子视图，还有监听状态栏朝向变化的通知：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">- (instancetype)init</div><div class="line">&#123;</div><div class="line">    self = [super initWithFrame:[UIScreen mainScreen].bounds];</div><div class="line">    if (self) &#123;</div><div class="line">        self.backgroundColor = [UIColor clearColor];</div><div class="line">        _background = [[TBActionBackground alloc] initWithFrame:self.bounds];</div><div class="line">        [self addSubview:_background];</div><div class="line">        _actionContainer = [[TBActionContainer alloc] initWithSheet:self];</div><div class="line">        [self addSubview:_actionContainer];</div><div class="line">        _buttons = [NSMutableArray array];</div><div class="line">        _separators = [NSMutableArray array];</div><div class="line">        //set default values</div><div class="line">        _cancelButtonIndex = -1;</div><div class="line">        _destructiveButtonIndex = -1;</div><div class="line">        </div><div class="line">        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(statusBarDidChangeOrientation:) name:UIApplicationDidChangeStatusBarOrientationNotification object:nil];</div><div class="line">    &#125;</div><div class="line">    return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2>添加按钮</h2>
<p>添加按钮的实现就是调用 <code>TBActionButton</code> 的工厂方法新建一个按钮，然后将其设置好点击事件处理的方法后，将按钮实例添加到 <code>buttons</code> 数组中。针对按钮不同的风格，会更新 <code>cancelButtonIndex</code> 和 <code>destructiveButtonIndex</code>，这里做了个兼容性的妥协：<code>UIActionSheet</code> 提供的接口只能至多有一个 <code>cancelButtonTitle</code> 或 <code>destructiveButtonTitle</code>，而 <code>UIAlertController</code> 的接口却支持多个。<code>TBActionSheet</code> 支持多个 <code>cancelButtonTitle</code> 或 <code>destructiveButtonTitle</code>，但 <code>cancelButtonIndex</code> 和 <code>destructiveButtonIndex</code> 总是被更新为最后一个添加的对应风格按钮的 Index：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">- (NSInteger)addButtonWithTitle:(nullable NSString *)title style:(TBActionButtonStyle)style handler:(void (^ __nullable)( TBActionButton * _Nonnull button))handler</div><div class="line">&#123;</div><div class="line">    TBActionButton *button = [TBActionButton buttonWithTitle:title style:style handler:handler];</div><div class="line">    [button addTarget:self action:@selector(buttonTapped:) forControlEvents:UIControlEventTouchUpInside];</div><div class="line">    [self.buttons addObject:button];</div><div class="line">    NSInteger index = self.buttons.count - 1;</div><div class="line">    switch (style) &#123;</div><div class="line">        case TBActionButtonStyleDefault: &#123;</div><div class="line">            ;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">        case TBActionButtonStyleCancel: &#123;</div><div class="line">            self.cancelButtonIndex = index;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">        case TBActionButtonStyleDestructive: &#123;</div><div class="line">            self.destructiveButtonIndex = index;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">        default: &#123;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return index;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>添加按钮时把传入的 <code>style</code> 和 <code>handler</code> 再次传给了 <code>TBActionButton</code> 的工厂方法。此外还有两个参数更简洁的方法可供选择，实现如下：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (NSInteger)addButtonWithTitle:(NSString *)title</div><div class="line">&#123;</div><div class="line">    return [self addButtonWithTitle:title style:TBActionButtonStyleDefault];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSInteger)addButtonWithTitle:(NSString *)title style:(TBActionButtonStyle)style</div><div class="line">&#123;</div><div class="line">    return [self addButtonWithTitle:title style:style handler:nil];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这也是顺应了之前的设计，减少冗余代码。</p>
<h2>show</h2>
<p>在调用 <code>show</code> 方法之前，使用者可能会修改一些属性的值，所以大量的绘制和计算都是在 <code>show</code> 方法调用时执行的。在显示 ActionSheet 的时候需要有一组动画效果：将背景颜色由透明设成半透明黑色，并将容器从屏幕外由下至上平移至屏幕底部。</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">- (void)show</div><div class="line">&#123;</div><div class="line">    if ([self.delegate respondsToSelector:@selector(willPresentAlertView:)]) &#123;</div><div class="line">        [self.delegate willPresentActionSheet:self];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    [self setupNewWindow];</div><div class="line">    </div><div class="line">    [self setupLayout];</div><div class="line">    </div><div class="line">    [self setupStyle];</div><div class="line">    </div><div class="line">    //弹出 ActionSheet 动画</div><div class="line">    void(^animations)(void) = ^() &#123;</div><div class="line">        self.background.backgroundColor = [UIColor colorWithWhite:0 alpha:0.5];</div><div class="line">        [self setupContainerFrame];</div><div class="line">    &#125;;</div><div class="line">    void(^completion)(BOOL finished) = ^(BOOL finished) &#123;</div><div class="line">        if ([self.delegate respondsToSelector:@selector(didPresentActionSheet:)]) &#123;</div><div class="line">            [self.delegate didPresentActionSheet:self];</div><div class="line">        &#125;</div><div class="line">        self.visible = YES;</div><div class="line">    &#125;;</div><div class="line">    if (kiOS7Later) &#123;</div><div class="line">        [UIView animateWithDuration:self.animationDuration delay:0 usingSpringWithDamping:self.animationDampingRatio initialSpringVelocity:self.animationVelocity options:UIViewAnimationOptionCurveEaseInOut animations:animations completion:completion];</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        [UIView animateWithDuration:self.animationDuration delay:0 options:UIViewAnimationOptionCurveEaseInOut animations:animations completion:completion];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在动画开始之前最关键的三个步骤是：</p>
<ol>
<li>设置新的 <code>UIWindow</code>：<code>setupNewWindow</code></li>
<li>设置布局：<code>setupLayout</code></li>
<li>设置毛玻璃效果、圆角、背景颜色等风格：<code>setupStyle</code></li>
</ol>
<h3>setupNewWindow</h3>
<p><code>setupNewWindow</code> 的具体实现如下：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">- (void)setupNewWindow</div><div class="line">&#123;</div><div class="line">    if ([self isVisible]) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    self.previousKeyWindow = [UIApplication sharedApplication].keyWindow;</div><div class="line">    [self.previousKeyWindow interruptGesture];</div><div class="line">    TBActionSheetController *actionSheetVC = [[TBActionSheetController alloc] initWithNibName:nil bundle:nil];</div><div class="line">    actionSheetVC.actionSheet = self;</div><div class="line">    </div><div class="line">    self.window = [[UIWindow alloc] initWithFrame:[UIScreen mainScreen].bounds];</div><div class="line">    self.window.autoresizingMask = UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleHeight;</div><div class="line">    self.window.opaque = NO;</div><div class="line">    self.window.rootViewController = actionSheetVC;</div><div class="line">    [self.window makeKeyAndVisible];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在把新的 <code>UIWindow</code> 搬到屏幕上之前先用 <code>previousKeyWindow</code> 属性记录下当前的 <code>keyWindow</code>，因为以后会经常用到它。下面会详细展开讲述 <code>setupNewWindow</code> 方法都干了啥。</p>
<h4>Autorotation</h4>
<p>之前说过 <code>TBActionSheet</code> 是在 <code>UIWindow</code> 上模态展示，其实这么做的另一个原因是为了更方便地实现自动旋转。旋转事件的传递路径为：<code>UIApplication</code> -&gt; <code>UIWindow</code> -&gt; <code>rootViewController</code> -&gt; <code>rootViewController.view</code>。所以需要将 <code>TBActionSheet</code> 作为 <code>rootViewController.view</code> 的子视图，这样让其跟着屏幕一起旋转。而在 iOS7 时代，<code>UIWindow</code> 是不会跟着一起旋转的，其 <code>bounds</code> 是不变的，坐标系计算跟 iOS8 之后的不同，所以 <code>TBActionSheet</code> 自动旋转目前仅支持 iOS8+。为了方便在控制器中处理旋转事件，我写了个 <code>TBActionSheetController</code>，它对 <code>TBActionSheet</code> 有一个弱引用，只是为了方便一些操作。</p>
<p>实现自动旋转的主要流程是：</p>
<ol>
<li>新建一个 <code>TBActionSheetController</code> 实例 <code>actionSheetVC</code></li>
<li>新建一个 <code>UIWindow</code> 实例 <code>window</code> 并赋值给 <code>window</code> 属性</li>
<li><code>window.rootViewController = actionSheetVC</code></li>
<li><code>[actionSheetVC.view addSubview: YOUR_VIEW]</code></li>
</ol>
<p><code>YOUR_VIEW</code> 就是想要自动旋转的视图，在这里就是 <code>TBActionSheet</code> 实例啦。</p>
<p>完成了以上流程后，还需要在 <code>TBActionSheet</code> 接受到朝向变化的通知后手动更新 <code>frame</code> 和 <code>bounds</code>。PS：因为我们没使用自动布局，而是手动调整 <code>frame</code>。</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (void)statusBarDidChangeOrientation:(NSNotification *)notification &#123;</div><div class="line">    self.bounds = [UIScreen mainScreen].bounds;</div><div class="line">    self.background.frame = self.bounds;</div><div class="line">    [self setupContainerFrame];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>setupContainerFrame</code> 方法在后面会讲到。</p>
<h4>interruptGesture</h4>
<p>如果作用于 <code>previousKeyWindow</code> 上的手势触发了 ActionSheet 的显示，但此时这个手势没有终止（比如 Pan 手势一直在捕获），这时就会引发一系列问题（测试的同学功不可没），必须中断其他窗口正在捕获的手势。思路是递归遍历子视图树中的所有手势对象，针对 Tap 和 Pan 这两种手势做中断处理。中断的方法就是将 <code>enabled</code> 设为 <code>NO</code> 再设为 <code>YES</code>：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (void)interruptGesture</div><div class="line">&#123;</div><div class="line">    for (UIGestureRecognizer *gesture in self.gestureRecognizers) &#123;</div><div class="line">        if (([gesture isKindOfClass:[UITapGestureRecognizer class]] || [gesture isKindOfClass:[UIPanGestureRecognizer class]]) &amp;&amp; gesture.enabled == YES) &#123;</div><div class="line">            gesture.enabled = NO;</div><div class="line">            gesture.enabled = YES;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    for (UIView *subview in self.subviews) &#123;</div><div class="line">        [subview interruptGesture];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4>TBActionSheetController</h4>
<p>为了让 ActionSheet 自动旋转，还需要覆写 <code>TBActionSheetController</code> 的 <code>shouldAutorotate</code> 方法并返回 <code>YES</code>，以及在 <code>supportedInterfaceOrientations</code> 方法中返回想要旋转的朝向 Mask。为了让 <code>TBActionSheetController</code> 的状态栏风格和 Hidden 状态与 ActionSheet 展现之前相同，还需要覆写 <code>preferredStatusBarStyle</code> 和 <code>prefersStatusBarHidden</code> 这两个方法。通过 <code>previousKeyWindow</code> 可以递归找到最顶层的控制器，并递归调用 <code>childViewControllerForStatusBarXXX</code> 方法向其获取可以代表状态栏风格或 Hidden 的控制器。这里用到了一些关于 <code>UIWindow</code> 的辅助方法，具体实现在 <code>UIWindow (TBAdditions)</code> 类别中。</p>
<h3>setupLayout</h3>
<p>因为没有用自动布局，所以需要在容器中从上到下依次排列视图，宽度由 <code>sheetWidth</code> 属性得知，只需计算好当前的纵坐标。纵坐标是根据各组件高度累加计算的，所以本质上还是对高度的计算。<code>titleLabel</code> 和 <code>messageLabel</code> 的高度可根据字体和文字内容计算出来。<code>customView</code> 是由调用方提供，高度也可以获得。按钮的高度由 <code>buttonHeight</code> 属性决定。除此之外还有视图之间的空隙，大部分都是小的空隙，Cancel 按钮上下都是大空隙。我将大小空隙的高度分别『钦定』为 8point 和 0.5point，并没提供属性用于个性化。其实这里叫『空隙』不准确，应该是『隔板（Separator）』，因为我在控件之间加了透明的 <code>UIView</code>，它可以根据需求变换背景颜色。</p>
<p><code>setupLayout</code> 方法的主要流程如下（忽略创建和添加 Separator）：</p>
<ol>
<li>根据 <code>title</code> 和 <code>message</code> 属性依次为 <code>titleLabel</code> 和 <code>messageLabel</code> 创建实例，并添加到容器中（<code>actionContainer.header</code>），计算 <code>frame</code>。</li>
<li>处理调用者传入的 <code>customView</code>，添加到容器中（<code>actionContainer.custom</code>），计算 <code>customView</code> 的 <code>frame</code>。</li>
<li>遍历 <code>buttons</code> 数组向容器中（<code>actionContainer</code>）添加按钮，计算按钮的 <code>frame</code>，并根据按钮样式调整文字颜色和 Separator 高度。</li>
<li>根据 <code>offsetY</code> 属性计算容器下方需要『空』出来的高度。<code>offsetY</code> 为 ActionSheet 下方的 y 轴位移，向下为正，非负值无效，默认值为 -8。最后计算容器的 <code>frame</code>。</li>
</ol>
<p>这部分的计算略复杂，只是阐述下思想。但这还不是最复杂的部分。</p>
<h3>setupStyle</h3>
<p>此方法主要是设置风格，比如毛玻璃效果、圆角和颜色等，依赖于 <code>setupLayout</code> 的结果。</p>
<p>微信的样式是整个容器背景全带毛玻璃效果，且没有圆角；系统样式中 iOS9 和 iOS8 只有按钮和标题部分带毛玻璃效果，其余地方镂空透明的，且 iOS9 的圆角更大些。iOS7 没有毛玻璃效果。<code>TBActionSheet</code> 有几个属性用来调节这些参数：</p>
<ul>
<li><code>backgroundTransparentEnabled</code> 是否让 ActionSheet 背景透明（镂空）</li>
<li><code>blurEffectEnabled</code> 是否启用毛玻璃效果</li>
<li><code>rectCornerRadius</code> 矩形圆角半径</li>
<li><code>ambientColor</code> ActionSheet 的环境色</li>
</ul>
<h4>BlurEffect &amp; Separator</h4>
<p><code>UIVisualEffectView</code> 只支持 iOS8+，为了兼容 iOS7 及更低版本，我的策略是将屏幕上容器区域矩形进行截图，并做三次 Box 模糊处理，并将图片设置为容器的图片（但愿你还记得它们都是 <code>UIImageView</code>），模拟毛玻璃效果。苹果在 WWDC2013 给出了开源实现，使用的是 CI 框架的 Box 模糊函数，效率比高斯模糊要高：<a href="https://developer.apple.com/downloads/download.action?path=wwdc_2013/wwdc_2013_sample_code/ios_uiimageeffects.zip" target="_blank" rel="external">ios_uiimageeffects.zip</a>。针对容器镂空的情况，不能将容器矩形整体截图，需要将非镂空控件的每一部分单独截图并做模糊处理，然后将处理好的图片设置为控件的图片（因为容器中的控件都是 <code>UIImageView</code> 或 <code>UIButton</code>，不包含 Separator）。而使用 <code>UIVisualEffectView</code> 的时候也同样遵循这个道理。 <code>UIVisualEffectView</code> 的优点是针对变化的背景可以实时渲染出毛玻璃效果，而截图手动 Box 模糊就做不到这点；缺点是除非使用 <code>UIVisualEffectView</code> 的私有接口否则不能调节模糊半径，而 CI 框架提供的函数可以做到。</p>
<p>也就是说这里需要做两个判断：</p>
<ol>
<li>毛玻璃效果策略：iOS8+ 用 <code>UIVisualEffectView</code>；否则用截图和 Box 模糊；如果不开启毛玻璃效果则使用半透明（alpha=0.5）的背景色（<code>ambientColor</code>）</li>
<li>ActionSheet 背景是否镂空：不镂空则对容器矩形整体截图，镂空则只对容器内的控件（<code>header</code>,<code>custom</code> 和按钮）矩形截图。</li>
</ol>
<p>因为 iOS7 下的毛玻璃效果使用的是截图，所以需要在设备屏幕旋转时刷新下 UI，再次调用 <code>setupStyle</code> 方法。需要覆写 <code>TBActionSheetController</code> 中下面的方法：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (void)didRotateFromInterfaceOrientation:(UIInterfaceOrientation)fromInterfaceOrientation</div><div class="line">&#123;</div><div class="line">    if (self.actionSheet.blurEffectEnabled &amp;&amp; !kiOS8Later) &#123;</div><div class="line">        [self.actionSheet setupStyle];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5>截屏</h5>
<p>截屏就是在屏幕上的进行截图，表面上看上去很简单，但实践的时候也会碰到坑。首先我要截取的肯定是 ActionSheet 出现之前的屏幕，所以之前提到过的 <code>previousKeyWindow</code> 属性就又派上用场了，它是 ActionSheet 展现前的窗口，通过它可以获取到最顶层的控制器，然后获取控制器管理的 <code>view</code>，接着就是用 UIKit 那套函数截图。这里需要区分下 iOS6 和 iOS7+ 渲染视图层级要调用不同的接口，并注意一个仅仅发生在 iOS7 上的 crash：<strong>如果截屏区域的长或宽过小时将会引发 crash，这是 iOS7 系统的 bug</strong>。</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> *  从区域截屏</div><div class="line"> *</div><div class="line"> *  @param aRect 区域</div><div class="line"> *  @param view  截取的 view</div><div class="line"> *</div><div class="line"> *  @return  截取的图片</div><div class="line"> */</div><div class="line">- (UIImage *)screenShotRect:(CGRect)aRect</div><div class="line">&#123;</div><div class="line">    // 获取最上层的 UIViewController</div><div class="line">    UIViewController *topController = [self.previousKeyWindow currentViewController];</div><div class="line">    UIView *view = topController.view;</div><div class="line">    </div><div class="line">    UIGraphicsBeginImageContext(view.bounds.size);</div><div class="line">    if ([view respondsToSelector:@selector(drawViewHierarchyInRect:afterScreenUpdates:)]) &#123;</div><div class="line">        const CGFloat crashMagicNumber = 0.3;// size 小于0.3 在 iOS7 上会导致 crash</div><div class="line">        if (view.frame.size.width &gt;= crashMagicNumber &amp;&amp; view.frame.size.height &gt;= crashMagicNumber ) &#123; // resolve iOS7 size crash</div><div class="line">            [view drawViewHierarchyInRect:self.bounds afterScreenUpdates:YES];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    else &#123;/* iOS 6 */</div><div class="line">        [view.layer renderInContext:UIGraphicsGetCurrentContext()];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    UIImage *screenshotimage = UIGraphicsGetImageFromCurrentImageContext();</div><div class="line">    UIGraphicsEndImageContext();</div><div class="line">    </div><div class="line">    return [self cutFromImage:screenshotimage inRect:aRect];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在图片中截取图片时需要注意 Retina 屏幕的 <code>scale</code> 问题，区分『坐标点』与『像素点』就好。还有要注意如果截图矩形 <code>rect</code> 如果超出了图片 <code>image</code> 范围，超出的那部分会是透明的。</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> *  从图片中切图</div><div class="line"> *</div><div class="line"> *  @param image 要被切的图片</div><div class="line"> *  @param rect  这里可以设置想要截图的区域</div><div class="line"> *</div><div class="line"> *  @return 截图</div><div class="line"> */</div><div class="line">- (UIImage *)cutFromImage:(UIImage *)image inRect:(CGRect) rect</div><div class="line">&#123;</div><div class="line">    CGImageRef imageRef = image.CGImage;</div><div class="line">    CGRect transRect = CGRectMake(rect.origin.x*image.scale, rect.origin.y*image.scale, rect.size.width*image.scale, rect.size.height*image.scale);</div><div class="line">    CGImageRef imageRefRect =CGImageCreateWithImageInRect(imageRef, transRect);</div><div class="line">    UIImage *sendImage = [[UIImage alloc] initWithCGImage:imageRefRect scale:image.scale orientation:UIImageOrientationUp];</div><div class="line">    NSData *imageViewData = UIImagePNGRepresentation(sendImage);</div><div class="line">    CGImageRelease(imageRefRect);</div><div class="line">    return [UIImage imageWithData:imageViewData];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5>ambientColor</h5>
<p>环境色其实就是容器的背景颜色，但不能叫 <code>backgroundColor</code>，因为 <code>UIView</code> 中已经有个 <code>backgroundColor</code> 属性了，如果我们自己强制声明重名的属性会导致奇怪的问题。比如设置好的背景色在程序运行中自动被设成其他颜色（一般是黑色），而且是随机出现的，而且一旦出现就会一直复现，除非杀进程。PS：别问我为啥知道这么多，都是泪啊！用在公司项目中被测试同学提过好多次 bug！</p>
<p>回归正题！如何将环境色加入到容器中呢？毕竟有多种情况，但其思想跟毛玻璃模糊的思路差不多：</p>
<p><img src="http://7ni3rk.com1.z0.glb.clouddn.com/TBActionSheet/ambientColor.png" alt="环境色设置策略"></p>
<p>值得一提的是在倒数第二个分支『在 <code>UIVisualEffectView</code> 后插入环境色视图』。是在控件的后面插入
<code>UIVisualEffectView</code> 后再插入一层背景颜色为 <code>ambientColor</code> 的 <code>UIView</code>。如果控件类型为 <code>TBActionButton</code>，那么需要将其 <code>behindColorView</code> 属性设为背景色为 <code>ambientColor</code> 的 <code>UIView</code> 对象。原因是按钮此时无背景色，高亮状态需要调节 <code>behindColorView</code> 的 <code>alpha</code>。</p>
<p>这部分的代码逻辑其实略复杂，但还不是最烧脑的。</p>
<h5>Separator</h5>
<p>在 <code>setupLayout</code> 中创建的 Separator 都会添加到 <code>separators</code> 数组中，并作为容器的子视图参与 UI 绘制：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)addSeparatorLineAt:(CGPoint) point isBigFragment:(BOOL) isBigFragment</div><div class="line">&#123;</div><div class="line">    UIView *separatorLine = [[UIView alloc] initWithFrame:CGRectMake(point.x, point.y, self.sheetWidth, isBigFragment?bigFragment:smallFragment)];</div><div class="line">    separatorLine.backgroundColor = self.separatorColor;</div><div class="line">    [self.actionContainer addSubview:separatorLine];</div><div class="line">    [self.separators addObject:separatorLine];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Separator 只是个普通的 <code>UIView</code>，可以透明也可以有颜色，这取决于调用者的口味。微信样式中按钮之间是有些深色的，可以通过 <code>separatorColor</code> 属性来设置这个颜色。Separator 的两种尺寸之前提到过，BigFragment 为 8point，位于 Cancel 按钮上下，即使 Cancel 按钮在中间，也可以应付自如。</p>
<h4>RectCorner</h4>
<p>圆角的实现不复杂，但是判断哪里需要处理成圆角很复杂：<strong>哪个 <code>UIView</code> 的哪个角需要处理成圆角</strong></p>
<p>我写了个 <code>UIView (TBRectCorner)</code> 类别方便加圆角，原理是用贝塞尔曲线的 <code>bezierPathWithRoundedRect:byRoundingCorners:cornerRadii:</code> 方法绘制圆角矩形路径 <code>maskPath</code>，然后将其 <code>CGPath</code> 作为 <code>layer.mask</code> 的路径。用贝塞尔曲线的优点就是可以针对矩形某个单独的角做圆角，而这正是我需要的。我在 <code>UIView (TBRectCorner)</code> 中以<a href="http://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/#Objective-C-Associated-Objects" target="_blank" rel="external">关联对象</a>的方式加了个 <code>tbRectCorner</code> 属性，用于标记圆角类型（<code>TBRectCorner</code>）。ActionSheet 中的控件一共有四种圆角类型：顶部圆角、底部圆角、全圆角和无圆角。</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">typedef NS_OPTIONS(NSUInteger, TBRectCorner) &#123;</div><div class="line">    TBRectCornerTop = 1 &lt;&lt; 0,</div><div class="line">    TBRectCornerBottom = 1 &lt;&lt; 1,</div><div class="line">    TBRectCornerNone = 0,</div><div class="line">    TBRectCornerAll = TBRectCornerTop|TBRectCornerBottom,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">@interface UIView (TBRectCorner)</div><div class="line">@property (nonatomic,assign) TBRectCorner tbRectCorner;</div><div class="line">- (void)setCornerRadius:(CGFloat) radius;</div><div class="line">@end</div></pre></td></tr></table></figure></p>
<p>而判断哪里需要圆角的过程就复杂了，用到了大量的 if-else 判断来修改 <code>tbRectCorner</code> 属性。这项工作复杂的原因就在于其布局不确定性，加圆角的规则如下：</p>
<ol>
<li>整个容器的边缘都有圆角。容器内部 Separator 为 BigFragment 的上下边缘都有圆角。（Cancel 按钮上下的 Separator 都为 BigFragment）</li>
<li><code>title</code> 和 <code>message</code> 如果都为 <code>nil</code>，也就是容器的 <code>header</code> 无内容，则容器顶部圆角加在 <code>custom</code> 顶部。</li>
<li>如果传入的 <code>customView</code> 为 <code>nil</code>，则容器的 <code>custom</code> 无内容，则容器顶部圆角加在第一个按钮顶部。</li>
<li>容器底部圆角加在最后一个按钮底部。</li>
</ol>
<p>具体实现代码就不贴了，分散在 <code>setupStyle</code> 方法的多个位置。</p>
<h4>setupContainerFrame</h4>
<p><code>show</code> 方法中的动画会将整个容器从屏幕外右下至上滑动至屏幕底部，动画的终点就是容器最终的 <code>frame</code>。在计算纵坐标时需要考虑到 iOS7 的状态栏的高度：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (void)setupContainerFrame</div><div class="line">&#123;</div><div class="line">    self.actionContainer.frame = CGRectMake(kContainerLeft, kScreenHeight - self.actionContainer.frame.size.height - (!kiOS7Later? 20: 0), self.actionContainer.frame.size.width, self.actionContainer.frame.size.height);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>除此之外还用到了几个自定义的宏，都是为了简化代码的：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#define kScreenWidth [UIScreen mainScreen].bounds.size.width</div><div class="line">#define kScreenHeight [UIScreen mainScreen].bounds.size.height</div><div class="line">#define kContainerLeft ((kScreenWidth - self.sheetWidth)/2)</div></pre></td></tr></table></figure></p>
<h3>动画</h3>
<p>从 iOS7 开始 UIKit 支持了 Spring 动画，有趣的是 SpriteKit 和 UIDynamic 也是在 iOS7 新加入的。我猜其底层实现应该是公用的。</p>
<p>我只是简单的支持了弹簧动画，添加了几个属性作为动画参数而已。可能今后会丰富下动画种类，或是提供接口，让调用者传入自定义的动画。</p>
<p>目前调节动画的参数有三个属性：<code>animationDuration</code>，<code>animationDampingRatio</code> 和 <code>animationVelocity</code>。</p>
<h2>close &amp; buttonTapped</h2>
<p>用户点击背景或者按钮时，ActionSheet 会执行消失动画，并伴随着 <code>delegate</code> 的一些回调或是执行 block。这两个方法的实现差不多，仅以 <code>buttonTapped</code> 为例讲解一下。</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">- (void)buttonTapped:(TBActionButton *)sender</div><div class="line">&#123;</div><div class="line">    if (![self isVisible]) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    NSUInteger index = [self.buttons indexOfObject:sender];</div><div class="line">    </div><div class="line">    [UIView animateWithDuration:self.animationDuration delay:0 options:UIViewAnimationOptionCurveEaseInOut animations:^&#123;</div><div class="line">        self.background.backgroundColor = [UIColor colorWithWhite:0 alpha:0];</div><div class="line">        self.actionContainer.frame = CGRectMake(kContainerLeft, kScreenHeight, self.actionContainer.frame.size.width, self.actionContainer.frame.size.height);</div><div class="line">    &#125; completion:^(BOOL finished) &#123;</div><div class="line">        //这里之所以把各种 delegate 调用都放在动画完成后是有原因的：为了支持在回调方法中 show 另一个 actionsheet，系统的 UIActionSheet 的调用时机也是如此。</div><div class="line">        </div><div class="line">        if ([self.delegate respondsToSelector:@selector(actionSheet:willDismissWithButtonIndex:)]) &#123;</div><div class="line">            [self.delegate actionSheet:self willDismissWithButtonIndex:index];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        self.window.rootViewController = nil;</div><div class="line">        [self.previousKeyWindow makeKeyAndVisible];</div><div class="line">        </div><div class="line">        if ([self.delegate respondsToSelector:@selector(actionSheet:clickedButtonAtIndex:)]) &#123;</div><div class="line">            [self.delegate actionSheet:self clickedButtonAtIndex:index];</div><div class="line">        &#125;</div><div class="line">        if (sender.handler) &#123;</div><div class="line">            __weak __typeof(TBActionButton *)weakSender = sender;</div><div class="line">            sender.handler(weakSender);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        if ([self.delegate respondsToSelector:@selector(actionSheet:didDismissWithButtonIndex:)]) &#123;</div><div class="line">            [self.delegate actionSheet:self didDismissWithButtonIndex:index];</div><div class="line">        &#125;</div><div class="line">        self.visible = NO;</div><div class="line">    &#125;]; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>动画就不多说了，基本就是 <code>show</code> 方法中动画的逆动画。其余还有很多 <code>delegate</code> 回调，注意调用的顺序需要还原 <code>UIActionSheet</code> 的调用顺序，也不必多说。针对带有 block 的按钮，执行 block 时要避免内存泄露：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">__weak __typeof(TBActionButton *)weakSender = sender;</div><div class="line">sender.handler(weakSender);</div></pre></td></tr></table></figure></p>
<p>还有就是处理 <code>UIWindow</code> 的切换和释放 <code>rootViewController</code>：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">self.window.rootViewController = nil;</div><div class="line">[self.previousKeyWindow makeKeyAndVisible];</div></pre></td></tr></table></figure></p>
<p>只要调用方不再对 ActionSheet 有强引用，<code>window</code> 就会被释放，不会造成内存泄露。</p>
<h1>一些细节</h1>
<h2>Marco</h2>
<p>项目中用到了一些 UIKit 自带的宏，其实它们好多都是使用 <code>__attribute__</code> 的偷懒方式，目的是告诉编译器一些事情。</p>
<h3>UI_APPEARANCE_SELECTOR</h3>
<p>在声明属性的时候，考虑到方便一个应用内控件的统一风格，使用到了 <code>UI_APPEARANCE_SELECTOR</code> 宏。在 iOS8 之前 <code>UIAppearance</code> 不支持 <code>BOOL</code> 类型，需要用 <code>NSInteger</code> 替代。所有声明带有 <code>UI_APPEARANCE_SELECTOR</code> 的属性都在 <code>initialize</code> 初始化：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">+ (void)initialize</div><div class="line">&#123;</div><div class="line">    if (self != [TBActionSheet class]) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    TBActionSheet *appearance = [self appearance];</div><div class="line">    appearance.buttonHeight = 56;</div><div class="line">    appearance.offsetY = - bigFragment;</div><div class="line">    appearance.tintColor = [UIColor blackColor];</div><div class="line">    appearance.destructiveButtonColor = [UIColor redColor];</div><div class="line">    appearance.cancelButtonColor = [UIColor blackColor];</div><div class="line">    appearance.sheetWidth = MIN(kScreenWidth, kScreenHeight) - 20;</div><div class="line">    appearance.backgroundTransparentEnabled = YES;</div><div class="line">    appearance.backgroundTouchClosureEnabled = YES;</div><div class="line">    appearance.blurEffectEnabled = YES;</div><div class="line">    appearance.rectCornerRadius = 10;</div><div class="line">    appearance.ambientColor = [UIColor colorWithWhite:1 alpha:0.65];</div><div class="line">    appearance.separatorColor = [UIColor clearColor];</div><div class="line">    appearance.animationDuration = 0.2;</div><div class="line">    appearance.animationDampingRatio = 1;</div><div class="line">    appearance.animationVelocity = 1;</div><div class="line">    appearance.supportedInterfaceOrientations = UIInterfaceOrientationMaskAll;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当然我是不建议调用者直接在这里改源码来配置个性化的 ActionSheet ，而是应该使用 <code>UIAppearance</code> 在外部进行配置，或是针对某个实例的属性做修改。</p>
<p><code>UI_APPEARANCE_SELECTOR</code> 的定义如下：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">__attribute__((annotate(&quot;ui_appearance_selector&quot;)))</div></pre></td></tr></table></figure></p>
<h3>NS_UNAVAILABLE</h3>
<p>有时候自己创建了一个类，但是想禁用一些从父类继承来的方法，就可以使用 <code>NS_UNAVAILABLE</code> 宏。比如在 <code>TBActionSheet</code> 类中我禁用了这个初始化方法：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (instancetype)initWithFrame:(CGRect)frame NS_UNAVAILABLE;</div></pre></td></tr></table></figure></p>
<p><code>NS_UNAVAILABLE</code> 其实有一些替代者，从下面的宏定义可以看出：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#define NS_UNAVAILABLE UNAVAILABLE_ATTRIBUTE</div><div class="line">#define UNAVAILABLE_ATTRIBUTE __attribute__((unavailable))</div><div class="line">#define __unavailable	__attribute__((unavailable))</div></pre></td></tr></table></figure></p>
<p>然而上面的这些宏都是不含提示信息的，想要带提示信息还是老老实实写 <code>__attribute__</code> 吧。下面是 <code>TBActionContainer</code> 的初始化方法声明：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (instancetype)initWithSheet:(TBActionSheet *)actionSheet;</div><div class="line">- (instancetype)initWithFrame:(CGRect)frame __attribute__((unavailable(&quot;initWithFrame: not available, please use initWithSheet:&quot;)));</div><div class="line">- (instancetype)init __attribute__((unavailable(&quot;init not available, please use initWithSheet:&quot;)));</div></pre></td></tr></table></figure></p>
<h3>NS_ASSUME_NONNULL_BEGIN（_END）</h3>
<p>llvm 6.1 为 Objective-C 加入了 Nullability 的新特性后，头文件们一个个都更啰嗦了。可以默认一段代码的属性或参数为非空，针对可能为空的则用 <code>nullable</code> 修饰。但我们声明的大部分属性或者方法参数都是非空的，大量的 <code>nonnull</code> 会降低可读性，所以苹果提供了 Audited Regions 宏，也就是 <code>NS_ASSUME_NONNULL_BEGIN</code> 和 <code>NS_ASSUME_NONNULL_END</code>。在头文件中这对儿宏之间区域的代码都会被审查，指针都会被默认为是 <code>nonnull</code>。<code>TBActionSheet</code> 适配了 Nullability 特性，更多内容可以参考官方的<a href="https://developer.apple.com/swift/blog/?id=25" target="_blank" rel="external">Nullability and Objective-C</a>。</p>
<h2>动态配置</h2>
<p>iOS 系统的 <code>UIActionSheet</code> 在展现后就不能做修改了，而我的 <code>TBActionSheet</code> 可以做到实时动态更新，比如动态添加按钮：</p>
<p><img src="https://github.com/yulingtianxia/TBActionSheet/blob/master/images/addButton.gif?raw=true" alt=""></p>
<p>在动态配置 <code>TBActionSheet</code> 的属性后<strong>必须</strong>调用以下方法刷新 UI：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[self.actionSheet setupLayout];</div><div class="line">[self.actionSheet setupStyle];</div><div class="line">[self.actionSheet setupContainerFrame];</div></pre></td></tr></table></figure></p>
<p>为了实现动态配置，需要有一个还原机制来清理之前的状态。比如容器内有很多子视图，诸如那些 Separator 和 <code>UIVisualEffectView</code> 对象都是一次性使用的，在布局发生变化后必须清理掉它们，并重新生成一遍。容器内这些没有存储数据的视图都是没必要重用的，只需要清理掉重新创建一遍即可。这样虽然可能会带来性能问题，不过考虑到按钮的数量毕竟有限，所以这些一次性的视图数量并不多。而且重用它们需要修改它们的 frame，需要单独花精力管理它们，带来的成本更大。有时简单粗暴点更好，毕竟动态配置这种场景不多。</p>
<p>还有就是一些视图背景颜色的还原，每次设置前先将其设为 <code>nil</code>。</p>
<h1>属性</h1>
<p><code>UIActionSheet</code> 中除了 <code>UIActionSheetStyle actionSheetStyle</code> 属性，其余属性都已实现。因为 <code>TBActionSheet</code> 的样式可高度个性化定制，所以不再需要 <code>UIActionSheetStyle</code> 这种枚举了。可以说 <code>TBActionSheet</code> 在属性上依然『几乎』是 <code>UIActionSheet</code> 的超集。</p>
<p><code>TBActionSheet</code> 的属性实在是太多了，因为它完全是手撸的，太灵活了。但总结起来无非就是『尺寸』、『样式』、『状态』、『内容』、『标记』和『动画&amp;朝向』这几大类。</p>
<h2>尺寸</h2>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> *  按钮高度</div><div class="line"> */</div><div class="line">@property(nonatomic) CGFloat buttonHeight UI_APPEARANCE_SELECTOR;</div><div class="line">/**</div><div class="line"> *  actionsheet下方的 y 轴位移，向下为正，非负值无效，默认值为 -8</div><div class="line"> */</div><div class="line">@property(nonatomic) CGFloat offsetY UI_APPEARANCE_SELECTOR;</div><div class="line">/**</div><div class="line"> *  sheet 的宽度，也就是按钮宽度</div><div class="line"> */</div><div class="line">@property(nonatomic) CGFloat sheetWidth UI_APPEARANCE_SELECTOR;</div><div class="line">/**</div><div class="line"> *  矩形圆角半径</div><div class="line"> */</div><div class="line">@property(nonatomic,assign) CGFloat rectCornerRadius UI_APPEARANCE_SELECTOR;</div></pre></td></tr></table></figure></p>
<h2>样式</h2>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> *  文字颜色</div><div class="line"> */</div><div class="line">@property(nonatomic,strong) UIColor *tintColor UI_APPEARANCE_SELECTOR;</div><div class="line">/**</div><div class="line"> *  Destructive 按钮文字颜色</div><div class="line"> */</div><div class="line">@property(nonatomic,strong) UIColor *destructiveButtonColor UI_APPEARANCE_SELECTOR;</div><div class="line">/**</div><div class="line"> *  Cancel 按钮文字颜色</div><div class="line"> */</div><div class="line">@property(nonatomic,strong) UIColor *cancelButtonColor UI_APPEARANCE_SELECTOR;</div><div class="line">/**</div><div class="line"> *  分割线颜色</div><div class="line"> */</div><div class="line">@property(nonatomic,strong) UIColor *separatorColor UI_APPEARANCE_SELECTOR;</div><div class="line">/**</div><div class="line"> *  按钮字体</div><div class="line"> */</div><div class="line">@property(nonatomic,strong) UIFont *buttonFont UI_APPEARANCE_SELECTOR;</div><div class="line">/**</div><div class="line"> *  ActionSheet 的环境色</div><div class="line"> */</div><div class="line">@property(nonatomic,strong) UIColor *ambientColor UI_APPEARANCE_SELECTOR;</div></pre></td></tr></table></figure></p>
<h2>状态</h2>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> *  是否可见</div><div class="line"> */</div><div class="line">@property(nonatomic,readonly,getter=isVisible) BOOL visible;</div><div class="line">/**</div><div class="line"> *  是否让 ActionSheet 背景透明</div><div class="line"> */</div><div class="line">@property(nonatomic, getter=isBackgroundTransparentEnabled) NSInteger backgroundTransparentEnabled UI_APPEARANCE_SELECTOR;</div><div class="line">/**</div><div class="line"> *  是否点击背景后关闭 ActionSheet</div><div class="line"> */</div><div class="line">@property(nonatomic, getter=isBackgroundTouchClosureEnabled) NSInteger backgroundTouchClosureEnabled UI_APPEARANCE_SELECTOR;</div><div class="line">/**</div><div class="line"> *  是否启用毛玻璃效果</div><div class="line"> */</div><div class="line">@property(nonatomic, getter=isBlurEffectEnabled) NSInteger blurEffectEnabled UI_APPEARANCE_SELECTOR;</div></pre></td></tr></table></figure></p>
<h2>内容</h2>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">@property(nonatomic,copy)  NSString * _Nullable  title;</div><div class="line">@property(nonatomic,copy)  NSString * _Nullable  message;</div><div class="line">/**</div><div class="line"> *  标题 UILabel</div><div class="line"> */</div><div class="line">@property(nonatomic,strong,nullable,readonly) UILabel *titleLabel;</div><div class="line">/**</div><div class="line"> *  Message UILabel</div><div class="line"> */</div><div class="line">@property (nonatomic,strong,nullable,readonly) UILabel *messageLabel;</div><div class="line">/**</div><div class="line"> *  自定义视图</div><div class="line"> */</div><div class="line">@property(nonatomic,strong,nullable) UIView *customView;</div></pre></td></tr></table></figure></p>
<h2>标记</h2>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> *   标记藏于 ActionSheet 下面的 UIWindow</div><div class="line"> */</div><div class="line">@property (weak, nonatomic, readonly) UIWindow *previousKeyWindow;</div><div class="line">@property(nonatomic) NSInteger cancelButtonIndex;      // if the delegate does not implement -actionSheetCancel:, we pretend this button was clicked on. default is -1</div><div class="line">@property(nonatomic) NSInteger destructiveButtonIndex; // sets destructive (red) button. -1 means none set. default is -1. ignored if only one button</div><div class="line">@property(nonatomic,readonly) NSInteger firstOtherButtonIndex;	// -1 if no otherButtonTitles or initWithTitle:... not used</div></pre></td></tr></table></figure></p>
<h2>动画&amp;朝向</h2>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">@property(nonatomic,readonly) NSInteger numberOfButtons;</div><div class="line">/**</div><div class="line"> *  动画持续时长</div><div class="line"> */</div><div class="line">@property(nonatomic,assign) NSTimeInterval animationDuration UI_APPEARANCE_SELECTOR;</div><div class="line">/**</div><div class="line"> *  动画弹簧效果衰弱比例，值为 1 时无摆动，值越接近 0 摆动越大</div><div class="line"> */</div><div class="line">@property(nonatomic,assign) CGFloat animationDampingRatio UI_APPEARANCE_SELECTOR;</div><div class="line">/**</div><div class="line"> *  动画弹簧效果初速度。如果动画总距离为 200 点，想让初速度为每秒 100 点，那么将值设为 0.5</div><div class="line"> */</div><div class="line">@property(nonatomic,assign) CGFloat animationVelocity UI_APPEARANCE_SELECTOR;</div><div class="line">/**</div><div class="line"> *  支持的朝向</div><div class="line"> */</div><div class="line">@property(nonatomic,assign) UIInterfaceOrientationMask supportedInterfaceOrientations UI_APPEARANCE_SELECTOR;</div></pre></td></tr></table></figure></p>
<h2>属性存取器</h2>
<p>其实属性存取器并不都是必要的，很多 set 方法可以不写，毕竟所有的布局和样式都在最后的 <code>show</code> 方法中决定。但一些改动不大的轻量级属性修改还是可以接受的，这些属性的 set 方法实现也比较简单。动态配置需要再次调用 <code>setupLayout</code>、<code>setupStyle</code> 以及 <code>setupContainerFrame</code>，而这些轻量级的属性修改则可立即生效，无需再调用那三个方法。</p>
<p>按钮字体的存取器建立在对 <code>buttons</code> 数组的遍历上：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (void)setButtonFont:(UIFont *)buttonFont</div><div class="line">&#123;</div><div class="line">    if (buttonFont &amp;&amp; [self buttonFont] != buttonFont) &#123;</div><div class="line">        for (TBActionButton *btn in self.buttons) &#123;</div><div class="line">            btn.titleLabel.font = buttonFont;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">- (UIFont *)buttonFont</div><div class="line">&#123;</div><div class="line">    return self.buttons.lastObject.titleLabel.font;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>firstOtherButtonIndex</code> 是只读属性，它也是遍历 <code>buttons</code> 数组，知道找到第一个 Default 风格的按钮：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (NSInteger)firstOtherButtonIndex</div><div class="line">&#123;</div><div class="line">    for (int i=0; i&lt;self.buttons.count; i++) &#123;</div><div class="line">        if (self.buttons[i].style==TBActionButtonStyleDefault) &#123;</div><div class="line">            return i;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return -1;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Separator 的颜色修改需要更新 <code>separators</code> 数组所有的元素：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)setSeparatorColor:(UIColor *)separatorColor</div><div class="line">&#123;</div><div class="line">    if (separatorColor &amp;&amp; separatorColor != _separatorColor) &#123;</div><div class="line">        _separatorColor = separatorColor;</div><div class="line">        for (UIView *separator in self.separators) &#123;</div><div class="line">            separator.backgroundColor = separatorColor;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ActionSheet 是否可见，取决于窗口及控制器是否存在：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (BOOL)isVisible</div><div class="line">&#123;</div><div class="line">    // action sheet is visible iff it&apos;s associated with a window</div><div class="line">    return !!self.window &amp;&amp; self.window.rootViewController;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>backgroundTouchClosureEnabled</code> 的更新需要同步到背景 <code>userInteractionEnabled</code> 属性：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (void)setBackgroundTouchClosureEnabled:(NSInteger)backgroundTouchClosureEnabled</div><div class="line">&#123;</div><div class="line">    _backgroundTouchClosureEnabled = backgroundTouchClosureEnabled;</div><div class="line">    self.background.userInteractionEnabled = backgroundTouchClosureEnabled;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1>后记</h1>
<p>我也没想到一个简简单单的 ActionSheet 也会写的这么复杂，早知道会这样我真的不敢下手。以至于写完后还没测试就用在了公司的项目中，各种爆 Bug 然后 Debug。同事们各种提意见然后我再去完善。第一次线上版本全部替换成 <code>TBActionSheet</code> 后出了 Bug，这真的是实习生干的 23333 这锅我背了！</p>
<p>其实写这个轮子是留下了很多遗憾和不足的：</p>
<ol>
<li>一开始觉得布局很简单，无非就是几个 Button 啊 Label 啊，所以没用自动布局。后面功能越来越多布局开始变得复杂，需要大量计算，想想真是后悔。但再往后动态配置和个性化程度大大提升，发现已经复杂到不适合用自动布局，不知是否有些心安</li>
<li>系统控件的实现是用 <code>UITableView</code> 或 <code>UICollectionView</code> 来实现的，在长按按钮滑动选择的时候，<code>TBActionSheet</code> 就做不到系统控件那样了。如果重写的话一定要用 Table 啊</li>
<li>属性名几经修改，接口也有小幅度修改，功能强大但也已经臃肿</li>
<li>没能做到全功能适配 iOS7，或许是自己太懒了。其实有写过二维变换模拟系统的旋转动画，并进行了复杂的数学坐标推导出变换公式，最后觉得还是效果不满意，并投入太多精力，遂放弃</li>
<li>当时因为业务忙，写的代码真是乱，现在还在一点点整理。。。说啥都是借口！</li>
</ol>
<p>其实一开始我也想当把标题党，把文章标题写成『这可能是东半球最牛逼的 ActionSheet』，想想还是算了。我从不求 star 从不求转发，踏实点好😄。</p>
<p>因为写得比较匆忙，逻辑比较复杂的地方可能描述不清，还请大神们多多提建议和指正。更希望能看到有建设性的 PR，一起将其完善。</p>

    

    
</div>


                

                <!-- Post Comments -->
                
                    







                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2016/07/18/9-innovations-that-could-become-the-next-big-thing/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2016/07/18/webp-support/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="John Doe's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        youremail@email.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/04/">四月 2017<span class="sidebar_archives-count">28</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">三月 2017<span class="sidebar_archives-count">37</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">二月 2017<span class="sidebar_archives-count">12</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/01/">一月 2017<span class="sidebar_archives-count">12</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">十二月 2016<span class="sidebar_archives-count">18</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">24</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">39</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">32</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/08/">八月 2016<span class="sidebar_archives-count">32</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">七月 2016<span class="sidebar_archives-count">21</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/06/">六月 2016<span class="sidebar_archives-count">33</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/05/">五月 2016<span class="sidebar_archives-count">20</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/04/">四月 2016<span class="sidebar_archives-count">15</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/03/">三月 2016<span class="sidebar_archives-count">19</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/02/">二月 2016<span class="sidebar_archives-count">16</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/01/">一月 2016<span class="sidebar_archives-count">19</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/12/">十二月 2015<span class="sidebar_archives-count">20</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/11/">十一月 2015<span class="sidebar_archives-count">30</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/10/">十月 2015<span class="sidebar_archives-count">30</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/09/">九月 2015<span class="sidebar_archives-count">27</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/08/">八月 2015<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/07/">七月 2015<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/06/">六月 2015<span class="sidebar_archives-count">10</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/05/">五月 2015<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/04/">四月 2015<span class="sidebar_archives-count">11</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/03/">三月 2015<span class="sidebar_archives-count">10</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/02/">二月 2015<span class="sidebar_archives-count">14</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/01/">一月 2015<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/12/">十二月 2014<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/11/">十一月 2014<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/10/">十月 2014<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/09/">九月 2014<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/08/">八月 2014<span class="sidebar_archives-count">9</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/07/">七月 2014<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/06/">六月 2014<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/05/">五月 2014<span class="sidebar_archives-count">11</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/04/">四月 2014<span class="sidebar_archives-count">32</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/03/">三月 2014<span class="sidebar_archives-count">34</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/02/">二月 2014<span class="sidebar_archives-count">14</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/01/">一月 2014<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/12/">十二月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/07/">七月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/06/">六月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/04/">四月 2013<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/03/">三月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/02/">二月 2013<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/01/">一月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/12/">十二月 2012<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/10/">十月 2012<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/09/">九月 2012<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/07/">七月 2012<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/06/">六月 2012<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/05/">五月 2012<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/08/">八月 2011<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/07/">七月 2011<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/06/">六月 2011<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/05/">五月 2011<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/04/">四月 2011<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/03/">三月 2011<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/02/">二月 2011<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/12/">十二月 2010<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/11/">十一月 2010<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/09/">九月 2010<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/07/">七月 2010<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/06/">六月 2010<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/02/">二月 2010<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/01/">一月 2010<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/09/">九月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/07/">七月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/05/">五月 2009<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/04/">四月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/03/">三月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/02/">二月 2009<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2008/07/">七月 2008<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2008/06/">六月 2008<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-twitter.svg);">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-facebook.svg);">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-gplus.svg);">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;Hexo
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->

    <script src="/js/lazyload.min.js"></script>
    <script src="/js/js.min.js"></script>



    <script src="/js/nprogress.js"></script>


<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>
















<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script>
    <!-- Offer LazyLoad -->
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    <!-- Start Queue -->
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

                </main>
            </div>
        </body>
    
</html>
