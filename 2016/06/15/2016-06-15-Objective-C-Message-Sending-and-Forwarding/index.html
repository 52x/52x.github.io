<!DOCTYPE html>
<html lang="zh">
    <head>
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.4 -->

    <!-- Title -->
    
    <title>
        
            Objective-C 消息发送与转发机制原理 | 
        
        Hexo
    </title>

    <!-- Meta & Info -->
    <meta charset="utf-8">

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    

    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="John Doe">
    <meta name="description" content="null">
    <meta name="keywords" content="null,Objective-C,Runtime,Message Forwarding,Messaging">

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Hexo">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Objective-C 消息发送与转发机制原理 | Hexo">
    <meta property="og:description" content="null">
    <meta property="og:article:tag" content="Objective-C"> <meta property="og:article:tag" content="Runtime"> <meta property="og:article:tag" content="Message Forwarding"> <meta property="og:article:tag" content="Messaging"> 

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS & jQuery -->
    
        <link rel="stylesheet" href="/css/material.min.css">
        <link rel="stylesheet" href="/css/style.min.css">
        <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


        <script src="/js/jquery.min.js"></script>
        <script src="/js/queue.js"></script>
    

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    


    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">1.</span> <span class="post-toc-text">八面玲珑的 objc_msgSend</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">源码解析</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">为什么使用汇编语言</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">2.</span> <span class="post-toc-text">使用 lookUpImpOrForward 快速查找 IMP</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">优化缓存查找&类的初始化</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">继续在类的继承体系中查找</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">回顾 objc_msgSend 伪代码</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.</span> <span class="post-toc-text">forwarding 中路漫漫的消息转发</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">objc_msgForward_impcache 的转换</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">objc_msgForward 也只是个入口</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">objc_setForwardHandler 设置了消息转发的回调</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">逆向工程助力刨根问底</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.</span> <span class="post-toc-text">总结</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.</span> <span class="post-toc-text">参考文献</span></a></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                Objective-C 消息发送与转发机制原理
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>John Doe</strong>
        <span>6月 15, 2016</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/Message-Forwarding/">Message Forwarding</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/Messaging/">Messaging</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/Objective-C/">Objective-C</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/Runtime/">Runtime</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=Objective-C 消息发送与转发机制原理&url=http://yoursite.com//2016/06/15/2016-06-15-Objective-C-Message-Sending-and-Forwarding/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=Objective-C 消息发送与转发机制原理&url=http://yoursite.com//2016/06/15/2016-06-15-Objective-C-Message-Sending-and-Forwarding/index.html&via=John Doe" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com//2016/06/15/2016-06-15-Objective-C-Message-Sending-and-Forwarding/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com//2016/06/15/2016-06-15-Objective-C-Message-Sending-and-Forwarding/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <p>消息发送和转发流程可以概括为：消息发送（Messaging）是 Runtime 通过 selector 快速查找 IMP 的过程，有了函数指针就可以执行对应的方法实现；消息转发（Message Forwarding）是在查找 IMP 失败后执行一系列转发流程的慢速通道，如果不作转发处理，则会打日志和抛出异常。</p>
<p><strong>本文不讲述开发者在消息发送和转发流程中需要做的事，而是讲述原理。能够很好地阅读本文的前提是你对 <a href="http://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/" target="_blank" rel="external">Objective-C Runtime</a> 已经有一定的了解，关于什么是消息，Class 的结构，selector、IMP、元类等概念将不再赘述</strong>。本文用到的源码为 objc4-680 和 CF-1153.18，逆向 CoreFoundation.framework 的系统版本为 macOS 10.11.5，汇编语言架构为 x86_64。</p>
<p>&lt;!--more--&gt;</p>
<h2>八面玲珑的 objc_msgSend</h2>
<p>此函数是消息发送必经之路，但只要一提 <code>objc_msgSend</code>，都会说它的伪代码如下或类似的逻辑，反正就是获取 IMP 并调用：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">id objc_msgSend(id self, SEL _cmd, ...) &#123;</div><div class="line">  Class class = object_getClass(self);</div><div class="line">  IMP imp = class_getMethodImplementation(class, _cmd);</div><div class="line">  return imp ? imp(self, _cmd, ...) : 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>源码解析</h3>
<p>为啥老用伪代码？因为 <code>objc_msgSend</code> 是用汇编语言写的，针对不同架构有不同的实现。如下为 <code>x86_64</code> 架构下的源码，可以在 <a href="https://github.com/opensource-apple/objc4/blob/master/runtime/Messengers.subproj/objc-msg-x86_64.s" target="_blank" rel="external">objc-msg-x86_64.s</a> 文件中找到，关键代码如下：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">	ENTRY	_objc_msgSend</div><div class="line">	MESSENGER_START</div><div class="line"></div><div class="line">	NilTest	NORMAL</div><div class="line"></div><div class="line">	GetIsaFast NORMAL		// r11 = self-&gt;isa</div><div class="line">	CacheLookup NORMAL		// calls IMP on success</div><div class="line"></div><div class="line">	NilTestSupport	NORMAL</div><div class="line"></div><div class="line">	GetIsaSupport	   NORMAL</div><div class="line"></div><div class="line">// cache miss: go search the method lists</div><div class="line">LCacheMiss:</div><div class="line">	// isa still in r11</div><div class="line">	MethodTableLookup %a1, %a2	// r11 = IMP</div><div class="line">	cmp	%r11, %r11		// set eq (nonstret) for forwarding</div><div class="line">	jmp	*%r11			// goto *imp</div><div class="line"></div><div class="line">	END_ENTRY	_objc_msgSend</div></pre></td></tr></table></figure></p>
<p>这里面包含一些有意义的宏：</p>
<p><code>NilTest</code> 宏，判断被发送消息的对象是否为 <code>nil</code> 的。如果为 <code>nil</code>，那就直接返回 <code>nil</code>。这就是为啥也可以对 <code>nil</code> 发消息。</p>
<p><code>GetIsaFast</code> 宏可以『快速地』获取到对象的 <code>isa</code> 指针地址（放到 <code>r11</code> 寄存器，<code>r10</code> 会被重写；在 arm 架构上是直接赋值到 <code>r9</code>）</p>
<p><code>CacheLookup</code> 这个宏是在类的缓存中查找 selector 对应的 IMP（放到 <code>r10</code>）并执行。如果缓存没中，那就得到 Class 的方法表中查找了。</p>
<p><code>MethodTableLookup</code> 宏是重点，负责在缓存没命中时在方法表中负责查找 IMP：
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">.macro MethodTableLookup</div><div class="line"></div><div class="line">	MESSENGER_END_SLOW</div><div class="line">	</div><div class="line">	SaveRegisters</div><div class="line"></div><div class="line">	// _class_lookupMethodAndLoadCache3(receiver, selector, class)</div><div class="line"></div><div class="line">	movq	$0, %a1</div><div class="line">	movq	$1, %a2</div><div class="line">	movq	%r11, %a3</div><div class="line">	call	__class_lookupMethodAndLoadCache3</div><div class="line"></div><div class="line">	// IMP is now in %rax</div><div class="line">	movq	%rax, %r11</div><div class="line"></div><div class="line">	RestoreRegisters</div><div class="line"></div><div class="line">.endmacro</div></pre></td></tr></table></figure></p>
<p>从上面的代码可以看出方法查找 IMP 的工作交给了 OC 中的 <code>_class_lookupMethodAndLoadCache3</code> 函数，并将 IMP 返回（从 <code>r11</code> 挪到 <code>rax</code>）。最后在 <code>objc_msgSend</code> 中调用 IMP。</p>
<h3>为什么使用汇编语言</h3>
<p>其实在 <a href="https://github.com/opensource-apple/objc4/blob/master/runtime/Messengers.subproj/objc-msg-x86_64.s" target="_blank" rel="external">objc-msg-x86_64.s</a> 中包含了多个版本的 <code>objc_msgSend</code> 方法，它们是根据返回值的类型和调用者的类型分别处理的：</p>
<ul>
<li><code>objc_msgSendSuper</code>:向父类发消息，返回值类型为 <code>id</code></li>
<li><code>objc_msgSend_fpret</code>:返回值类型为 floating-point，其中包含 <code>objc_msgSend_fp2ret</code> 入口处理返回值类型为 <code>long double</code> 的情况</li>
<li><code>objc_msgSend_stret</code>:返回值为结构体</li>
<li><code>objc_msgSendSuper_stret</code>:向父类发消息，返回值类型为结构体</li>
</ul>
<p>当需要发送消息时，编译器会生成中间代码，根据情况分别调用 <code>objc_msgSend</code>, <code>objc_msgSend_stret</code>, <code>objc_msgSendSuper</code>, 或 <code>objc_msgSendSuper_stret</code> 其中之一。</p>
<p>这也是为什么 <code>objc_msgSend</code> 要用汇编语言而不是 OC、C 或 C++ 语言来实现，因为单独一个方法定义满足不了多种类型返回值，有的方法返回 <code>id</code>，有的返回 <code>int</code>。考虑到不同类型参数返回值排列组合映射不同方法签名（method signature）的问题，那 switch 语句得老长了。。。**这些原因可以总结为 <a href="https://en.wikipedia.org/wiki/Calling_convention" target="_blank" rel="external">Calling Convention</a>，也就是说函数调用者与被调用者必须约定好参数与返回值在不同架构处理器上的存取规则，比如参数是以何种顺序存储在栈上，或是存储在哪些寄存器上。**除此之外还有其他原因，比如其可变参数用汇编处理起来最方便，因为找到 IMP 地址后参数都在栈上。要是用 C++ 传递可变参数那就悲剧了，prologue 机制会弄乱地址（比如 i386 上为了存储 <code>ebp</code> 向后移位 4byte），最后还要用 epilogue 打扫战场。而且汇编程序执行效率高，在 Objective-C Runtime 中调用频率较高的函数好多都用汇编写的。</p>
<h2>使用 lookUpImpOrForward 快速查找 IMP</h2>
<p>上一节中说到的 <code>_class_lookupMethodAndLoadCache3</code> 函数其实只是简单的调用了 <code>lookUpImpOrForward</code> 函数：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">IMP _class_lookupMethodAndLoadCache3(id obj, SEL sel, Class cls)</div><div class="line">&#123;</div><div class="line">    return lookUpImpOrForward(cls, sel, obj, </div><div class="line">                              YES/*initialize*/, NO/*cache*/, YES/*resolver*/);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意 <code>lookUpImpOrForward</code> 调用时使用缓存参数传入为 <code>NO</code>，因为之前已经尝试过查找缓存了。<code>IMP lookUpImpOrForward(Class cls, SEL sel, id inst, bool initialize, bool cache, bool resolver)</code> 实现了一套查找 IMP 的标准路径，也就是在消息转发（Forward）之前的逻辑。</p>
<h3>优化缓存查找&amp;类的初始化</h3>
<p>先对 debug 模式下的 assert 进行 unlock：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">runtimeLock.assertUnlocked();</div></pre></td></tr></table></figure></p>
<p><code>runtimeLock</code> 本质上是对 Darwin 提供的线程读写锁 <code>pthread_rwlock_t</code> 的一层封装，提供了一些便捷的方法。</p>
<p><code>lookUpImpOrForward</code> 接着做了如下两件事：</p>
<ol>
<li>如果使用缓存（<code>cache</code> 参数为 <code>YES</code>），那就调用 <code>cache_getImp</code> 方法从缓存查找 IMP。<code>cache_getImp</code> 是用汇编语言写的，也可以在 <a href="https://github.com/opensource-apple/objc4/blob/master/runtime/Messengers.subproj/objc-msg-x86_64.s" target="_blank" rel="external">objc-msg-x86_64.s</a> 找到，其依然用了之前说过的 <code>CacheLookup</code> 宏。因为 <code>_class_lookupMethodAndLoadCache3</code> 调用 <code>lookUpImpOrForward</code> 时 <code>cache</code> 参数为 <code>NO</code>，<strong>这步直接略过</strong>。</li>
<li>如果是第一次用到这个类且 <code>initialize</code> 参数为 <code>YES</code>（<code>initialize &amp;&amp; !cls-&gt;isInitialized()</code>），需要进行初始化工作，也就是开辟一个用于读写数据的空间。先对 <code>runtimeLock</code> 写操作加锁，然后调用 <code>cls</code> 的 <code>initialize</code> 方法。如果 <code>sel == initialize</code> 也没关系，虽然 <code>initialize</code> 还会被调用一次，但不会起作用啦，因为 <code>cls-&gt;isInitialized()</code> 已经是 <code>YES</code> 啦。</li>
</ol>
<h3>继续在类的继承体系中查找</h3>
<p>考虑到运行时类中的方法可能会增加，需要先做读操作加锁，使得方法查找和缓存填充成为原子操作。添加 category 会刷新缓存，之后如果旧数据又被重填到缓存中，category 添加操作就会被忽略掉。</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">runtimeLock.read();</div></pre></td></tr></table></figure></p>
<p>之后的逻辑整理如下：</p>
<ol>
<li>如果 selector 是需要被忽略的垃圾回收用到的方法，则将 IMP 结果设为 <code>_objc_ignored_method</code>，这是个汇编程序入口，可以理解为一个标记。对此种情况进行缓存填充操作后，跳到第 7 步；否则执行下一步。</li>
<li>查找当前类中的缓存，跟之前一样，使用 <code>cache_getImp</code> 汇编程序入口。如果命中缓存获取到了 IMP，则直接跳到第 7 步；否则执行下一步。</li>
<li>在当前类中的方法列表（method list）中进行查找，也就是根据 selector 查找到 Method 后，获取 Method 中的 IMP（也就是 <code>method_imp</code> 属性），并填充到缓存中。查找过程比较复杂，会针对已经排序的列表使用二分法查找，未排序的列表则是线性遍历。如果成功查找到 Method 对象，就直接跳到第 7 步；否则执行下一步。</li>
<li>在继承层级中递归向父类中查找，情况跟上一步类似，也是先查找缓存，缓存没中就查找方法列表。这里跟上一步不同的地方在于缓存策略，有个 <code>_objc_msgForward_impcache</code> 汇编程序入口作为缓存中消息转发的标记。也就是说如果在缓存中找到了 IMP，但如果发现其内容是 <code>_objc_msgForward_impcache</code>，那就终止在类的继承层级中递归查找，进入下一步；否则跳到第 7 步。</li>
<li>当传入 <code>lookUpImpOrForward</code> 的参数 <code>resolver</code> 为 <code>YES</code> 并且是第一次进入第 5 步时，时进入动态方法解析；否则进入下一步。这步消息转发前的最后一次机会。此时释放读入锁（<code>runtimeLock.unlockRead()</code>），接着间接地发送 <code>+resolveInstanceMethod</code> 或 <code>+resolveClassMethod</code> 消息。这相当于告诉程序员『赶紧用 Runtime 给类里这个 selector 弄个对应的 IMP 吧』，因为此时锁已经 unlock 了所以不会缓存结果，甚至还需要软性地处理缓存过期问题可能带来的错误。这里的业务逻辑稍微复杂些，后面会总结。因为这些工作都是在非线程安全下进行的，完成后需要回到第 1 步再次查找 IMP。</li>
<li>此时不仅没查找到 IMP，动态方法解析也不奏效，只能将 <code>_objc_msgForward_impcache</code> 当做 IMP 并写入缓存。这也就是之前第 4 步中为何查找到 <code>_objc_msgForward_impcache</code> 就表明了要进入消息转发了。</li>
<li>读操作解锁，并将之前找到的 IMP 返回。（无论是正经 IMP 还是不正经的 <code>_objc_msgForward_impcache</code>）这步还偏执地做了一些脑洞略大的 assert，很有趣。</li>
</ol>
<p>对于第 5 步，其实是直接调用 <code>_class_resolveMethod</code> 函数，在这个函数中实现了复杂的方法解析逻辑。如果 <code>cls</code> 是元类则会发送  <code>+resolveClassMethod</code>，然后根据 <code>lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/)</code> 函数的结果来判断是否发送 <code>+resolveInstanceMethod</code>；如果不是元类，则只需要发送 <code>+resolveInstanceMethod</code> 消息。这里调用 <code>+resolveInstanceMethod</code> 或 <code>+resolveClassMethod</code> 时再次用到了 <code>objc_msgSend</code>，而且第三个参数正是传入 <code>lookUpImpOrForward</code> 的那个 <code>sel</code>。在发送方法解析消息之后还会调用 <code>lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/)</code> 来判断是否已经添加上 <code>sel</code> 对应的 IMP 了，打印出结果。</p>
<p>最后 <code>lookUpImpOrForward</code> 方法也会把真正的 IMP 或者需要消息转发的 <code>_objc_msgForward_impcache</code> 返回，并最终专递到 <code>objc_msgSend</code> 中。而 <code>_objc_msgForward_impcache</code> 会在转化成 <code>_objc_msgForward</code> 或 <code>_objc_msgForward_stret</code>。这个后面会讲解原理。</p>
<h3>回顾 objc_msgSend 伪代码</h3>
<p>回过头来会发现 <code>objc_msgSend</code> 的伪代码描述得很传神啊，因为<code>class_getMethodImplementation</code> 的实现如下：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">IMP class_getMethodImplementation(Class cls, SEL sel)</div><div class="line">&#123;</div><div class="line">    IMP imp;</div><div class="line">    if (!cls  ||  !sel) return nil;</div><div class="line">    imp = lookUpImpOrNil(cls, sel, nil, YES/*initialize*/, YES/*cache*/, YES/*resolver*/);</div><div class="line">    // Translate forwarding function to C-callable external version</div><div class="line">    if (!imp) &#123;</div><div class="line">        return _objc_msgForward;</div><div class="line">    &#125;</div><div class="line">    return imp;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>lookUpImpOrNil</code> 函数获取不到 IMP 时就返回 <code>_objc_msgForward</code>，后面会讲到它。<code>lookUpImpOrNil</code> 跟 <code>lookUpImpOrForward</code> 的功能很相似，只是将 <code>lookUpImpOrForward</code> 实现中的 <code>_objc_msgForward_impcache</code> 替换成了 <code>nil</code>:</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">IMP lookUpImpOrNil(Class cls, SEL sel, id inst, </div><div class="line">                   bool initialize, bool cache, bool resolver)</div><div class="line">&#123;</div><div class="line">    IMP imp = lookUpImpOrForward(cls, sel, inst, initialize, cache, resolver);</div><div class="line">    if (imp == _objc_msgForward_impcache) return nil;</div><div class="line">    else return imp;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>lookUpImpOrNil</code> 方法可以查找到 selector 对应的 IMP 或是 <code>nil</code>，所以如果不考虑返回值类型为结构体的情况，用那几行伪代码来表示复杂的汇编实现还是挺恰当的。</p>
<h2><strong>forwarding</strong> 中路漫漫的消息转发</h2>
<h3>objc_msgForward_impcache 的转换</h3>
<p><code>_objc_msgForward_impcache</code> 只是个内部的函数指针，只存储于上节提到的类的方法缓存中，需要被转化为 <code>_objc_msgForward</code> 和 <code>_objc_msgForward_stret</code> 才能被外部调用。但在 <s>Mac OS X</s> macOS 10.6 及更早版本的 libobjc.A.dylib 中是不能直接调用的，况且我们根本不会直接用到它。带 <code>stret</code> 后缀的函数依旧是返回值为结构体的版本。</p>
<p>上一节最后讲到如果没找到 IMP，就会将 <code>_objc_msgForward_impcache</code> 返回到 <code>objc_msgSend</code> 函数，而正是因为它是用汇编语言写的，所以将内部使用的 <code>_objc_msgForward_impcache</code> 转化成外部可调用的 <code>_objc_msgForward</code> 或 <code>_objc_msgForward_stret</code> 也是由汇编代码来完成。实现原理很简单，就是增加个静态入口 <code>__objc_msgForward_impcache</code>，然后根据此时 CPU 的状态寄存器的内容来决定转换成哪个。如果是 <code>NE</code>(Not Equal) 则转换成 <code>_objc_msgForward_stret</code>，反之是 <code>EQ</code>(Equal) 则转换成 <code>_objc_msgForward</code>:</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">jne	__objc_msgForward_stret</div><div class="line">jmp	__objc_msgForward</div></pre></td></tr></table></figure></p>
<p>为何根据状态寄存器的值来判断转换成哪个函数指针呢？回过头来看看 <code>objc_msgSend</code> 中调用完 <code>MethodTableLookup</code> 之后干了什么：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MethodTableLookup %a1, %a2	// r11 = IMP</div><div class="line">cmp	%r11, %r11		// set eq (nonstret) for forwarding</div><div class="line">jmp	*%r11			// goto *imp</div></pre></td></tr></table></figure></p>
<p>再看看返回值为结构体的 <code>objc_msgSend_stret</code> 这里的逻辑：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MethodTableLookup %a2, %a3	// r11 = IMP</div><div class="line">test	%r11, %r11		// set ne (stret) for forward; r11!=0</div><div class="line">jmp	*%r11			// goto *imp</div></pre></td></tr></table></figure></p>
<p>稍微懂汇编的人一眼就看明白了，不懂的看注释也懂了，我就不墨迹了。现在总算是把消息转发前的逻辑绕回来构成闭环了。</p>
<p>上一节中提到 <code>class_getMethodImplementation</code> 函数的实现，在查找不到 IMP 时返回 <code>_objc_msgForward</code>，而 <code>_objc_msgForward_stret</code> 正好对应着 <code>class_getMethodImplementation_stret</code>:</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">IMP class_getMethodImplementation_stret(Class cls, SEL sel)</div><div class="line">&#123;</div><div class="line">    IMP imp = class_getMethodImplementation(cls, sel);</div><div class="line">    // Translate forwarding function to struct-returning version</div><div class="line">    if (imp == (IMP)&amp;_objc_msgForward /* not _internal! */) &#123;</div><div class="line">        return (IMP)&amp;_objc_msgForward_stret;</div><div class="line">    &#125;</div><div class="line">    return imp;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也就是说 <code>_objc_msgForward*</code> 系列本质都是函数指针，都用汇编语言实现，都可以与 IMP 类型的值作比较。<code>_objc_msgForward</code> 和 <code>_objc_msgForward_stret</code> 声明在 <a href="https://github.com/opensource-apple/objc4/blob/master/runtime/message.h" target="_blank" rel="external">message.h</a> 文件中。<code>_objc_msgForward_impcache</code> 在早期版本的 Runtime 中叫做 <code>_objc_msgForward_internal</code>。</p>
<h3>objc_msgForward 也只是个入口</h3>
<p>从汇编源码可以很容易看出 <strong><code>_objc_msgForward</code> 和 <code>_objc_msgForward_stret</code> 会分别调用 <code>_objc_forward_handler</code> 和 <code>_objc_forward_handler_stret</code></strong>：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">ENTRY	__objc_msgForward</div><div class="line">// Non-stret version</div><div class="line"></div><div class="line">movq	__objc_forward_handler(%rip), %r11</div><div class="line">jmp	*%r11</div><div class="line"></div><div class="line">END_ENTRY	__objc_msgForward</div><div class="line"></div><div class="line"></div><div class="line">ENTRY	__objc_msgForward_stret</div><div class="line">// Struct-return version</div><div class="line"></div><div class="line">movq	__objc_forward_stret_handler(%rip), %r11</div><div class="line">jmp	*%r11</div><div class="line"></div><div class="line">END_ENTRY	__objc_msgForward_stret</div></pre></td></tr></table></figure></p>
<p>这两个 handler 函数的区别从字面上就能看出来，不再赘述。</p>
<p>也就是说，消息转发过程是现将 <code>_objc_msgForward_impcache</code> 强转成 <code>_objc_msgForward</code> 或 <code>_objc_msgForward_stret</code>，再分别调用 <code>_objc_forward_handler</code> 或 <code>_objc_forward_handler_stret</code>。</p>
<h3>objc_setForwardHandler 设置了消息转发的回调</h3>
<p>在 Objective-C 2.0 之前，默认的 <code>_objc_forward_handler</code> 或 <code>_objc_forward_handler_stret</code> 都是 <code>nil</code>，而新版本的默认实现是这样的：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">// Default forward handler halts the process.</div><div class="line">__attribute__((noreturn)) void </div><div class="line">objc_defaultForwardHandler(id self, SEL sel)</div><div class="line">&#123;</div><div class="line">    _objc_fatal(&quot;%c[%s %s]: unrecognized selector sent to instance %p &quot;</div><div class="line">                &quot;(no message forward handler is installed)&quot;, </div><div class="line">                class_isMetaClass(object_getClass(self)) ? &apos;+&apos; : &apos;-&apos;, </div><div class="line">                object_getClassName(self), sel_getName(sel), self);</div><div class="line">&#125;</div><div class="line">void *_objc_forward_handler = (void*)objc_defaultForwardHandler;</div><div class="line"></div><div class="line">#if SUPPORT_STRET</div><div class="line">struct stret &#123; int i[100]; &#125;;</div><div class="line">__attribute__((noreturn)) struct stret </div><div class="line">objc_defaultForwardStretHandler(id self, SEL sel)</div><div class="line">&#123;</div><div class="line">    objc_defaultForwardHandler(self, sel);</div><div class="line">&#125;</div><div class="line">void *_objc_forward_stret_handler = (void*)objc_defaultForwardStretHandler;</div><div class="line">#endif</div></pre></td></tr></table></figure></p>
<p><code>objc_defaultForwardHandler</code> 中的 <code>_objc_fatal</code> 作用就是打日志并调用 <code>__builtin_trap()</code> 触发 crash，可以看到我们最熟悉的那句 &quot;unrecognized selector sent to instance&quot; 日志。<code>__builtin_trap()</code> 在杀掉进程的同时还能生成日志，比调用 <code>exit()</code> 更好。<code>objc_defaultForwardStretHandler</code> 就是装模作样搞个形式主义，把 <code>objc_defaultForwardHandler</code> 包了一层。<code>__attribute__((noreturn))</code>  属性通知编译器函数从不返回值，当遇到类似函数需要返回值而却不可能运行到返回值处就已经退出来的情况，该属性可以避免出现错误信息。这里正适合此属性，因为要求返回结构体哒。</p>
<p>因为默认的 Handler 干的事儿就是打日志触发 crash，我们想要实现消息转发，就需要替换掉 Handler 并赋值给 <code>_objc_forward_handler</code> 或 <code>_objc_forward_handler_stret</code>，赋值的过程就需要用到 <code>objc_setForwardHandler</code> 函数，实现也是简单粗暴，就是赋值啊：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">void objc_setForwardHandler(void *fwd, void *fwd_stret)</div><div class="line">&#123;</div><div class="line">    _objc_forward_handler = fwd;</div><div class="line">#if SUPPORT_STRET</div><div class="line">    _objc_forward_stret_handler = fwd_stret;</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3>逆向工程助力刨根问底</h3>
<p>重头戏在于对 <code>objc_setForwardHandler</code> 的调用，以及之后的消息转发调用栈。这回不是在 Objective-C Runtime （libobjc.dylib）中啦，而是在 Core Foundation（CoreFoundation.framework）中。虽然 CF 是开源的，但有意思的是苹果故意在开源的代码中删除了在 <a href="https://github.com/opensource-apple/CF/blob/master/CFRuntime.c" target="_blank" rel="external">CFRuntime.c</a> 文件 <code>__CFInitialize()</code> 中调用 <code>objc_setForwardHandler</code> 的代码。<code>__CFInitialize()</code> 函数是在 CF runtime 连接到进程时初始化调用的。从反编译得到的汇编代码中可以很容易跟 C 源码对比出来，我用红色标出了同一段代码的差异。</p>
<p>汇编语言还是比较好理解的，红色标出的那三个指令就是把 <code>__CF_forwarding_prep_0</code> 和 <code>___forwarding_prep_1___</code> 作为参数调用 <code>objc_setForwardHandler</code> 方法（那么之前那两个 DefaultHandler 卵用都没有咯，反正不出意外会被 CF 替换掉）：</p>
<p><img src="http://7ni3rk.com1.z0.glb.clouddn.com/MessageForward/QQ20160614-1@2x.png" alt="反编译后的 __CFInitialize() 汇编代码"></p>
<p>然而在源码中对应的代码却被删掉啦：</p>
<p><img src="http://7ni3rk.com1.z0.glb.clouddn.com/MessageForward/QQ20160614-2@2x.png" alt="苹果提供的 __CFInitialize() 函数源码"></p>
<p>在早期版本的 CF 源码中，还是可以看到 <code>__CF_forwarding_prep_0</code> 和 <code>___forwarding_prep_1___</code> 的声明的，但是不会有实现源码，也没有对 <code>objc_setForwardHandler</code> 的调用。这些细节从函数调用栈中无法看出，只能逆向工程看汇编指令。但从函数调用栈可以看出 <code>__CF_forwarding_prep_0</code> 和 <code>___forwarding_prep_1___</code> 这两个 Forward Handler 做了啥：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">2016-06-14 12:50:15.385 MessageForward[67364:7174239] -[MFObject sendMessage]: unrecognized selector sent to instance 0x1006001a0</div><div class="line">2016-06-14 12:50:15.387 MessageForward[67364:7174239] *** Terminating app due to uncaught exception &apos;NSInvalidArgumentException&apos;, reason: &apos;-[MFObject sendMessage]: unrecognized selector sent to instance 0x1006001a0&apos;</div><div class="line">*** First throw call stack:</div><div class="line">(</div><div class="line">	0   CoreFoundation                      0x00007fff8fa554f2 __exceptionPreprocess + 178</div><div class="line">	1   libobjc.A.dylib                     0x00007fff98396f7e objc_exception_throw + 48</div><div class="line">	2   CoreFoundation                      0x00007fff8fabf1ad -[NSObject(NSObject) doesNotRecognizeSelector:] + 205</div><div class="line">	3   CoreFoundation                      0x00007fff8f9c5571 ___forwarding___ + 1009</div><div class="line">	4   CoreFoundation                      0x00007fff8f9c50f8 _CF_forwarding_prep_0 + 120</div><div class="line">	5   MessageForward                      0x0000000100000f1f main + 79</div><div class="line">	6   libdyld.dylib                       0x00007fff8bc2c5ad start + 1</div><div class="line">	7   ???                                 0x0000000000000001 0x0 + 1</div><div class="line">)</div><div class="line">libc++abi.dylib: terminating with uncaught exception of type NSException</div></pre></td></tr></table></figure></p>
<p>这个日志场景熟悉得不能再熟悉了，可以看出 <code>_CF_forwarding_prep_0</code> 函数调用了 <code>___forwarding___</code> 函数，接着又调用了 <code>doesNotRecognizeSelector</code> 方法，最后抛出异常。<strong>但是靠这些是无法说服看客的，还得靠逆向工程反编译后再反汇编成伪代码来一探究竟，刨根问底。</strong></p>
<p><code>__CF_forwarding_prep_0</code> 和 <code>___forwarding_prep_1___</code> 函数都调用了 <code>___forwarding___</code>，只是传入参数不同。<code>___forwarding___</code> 有两个参数，第一个参数为将要被转发消息的栈指针（可以简单理解成 IMP），第二个参数标记是否返回结构体。<code>__CF_forwarding_prep_0</code> 第二个参数传入 <code>0</code>，<code>___forwarding_prep_1___</code> 传入的是 <code>1</code>，从函数名都能看得出来。下面是这两个函数的伪代码：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">int __CF_forwarding_prep_0(int arg0, int arg1, int arg2, int arg3, int arg4, int arg5) &#123;</div><div class="line">    rax = ____forwarding___(rsp, 0x0);</div><div class="line">    if (rax != 0x0) &#123; // 转发结果不为空，将内容返回</div><div class="line">            rax = *rax;</div><div class="line">    &#125;</div><div class="line">    else &#123; // 转发结果为空，调用 objc_msgSend(id self, SEL _cmd,...);</div><div class="line">            rsi = *(rsp + 0x8);</div><div class="line">            rdi = *rsp;</div><div class="line">            rax = objc_msgSend(rdi, rsi);</div><div class="line">    &#125;</div><div class="line">    return rax;</div><div class="line">&#125;</div><div class="line">int ___forwarding_prep_1___(int arg0, int arg1, int arg2, int arg3, int arg4, int arg5) &#123;</div><div class="line">    rax = ____forwarding___(rsp, 0x1);</div><div class="line">    if (rax != 0x0) &#123;// 转发结果不为空，将内容返回</div><div class="line">            rax = *rax;</div><div class="line">    &#125;</div><div class="line">    else &#123;// 转发结果为空，调用 objc_msgSend_stret(void * st_addr, id self, SEL _cmd, ...);</div><div class="line">            rdx = *(rsp + 0x10);</div><div class="line">            rsi = *(rsp + 0x8);</div><div class="line">            rdi = *rsp;</div><div class="line">            rax = objc_msgSend_stret(rdi, rsi, rdx);</div><div class="line">    &#125;</div><div class="line">    return rax;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 <code>x86_64</code> 架构中，<code>rax</code> 寄存器一般是作为返回值，<code>rsp</code> 寄存器是栈指针。在调用 <code>objc_msgSend</code> 函数时，参数 <code>arg0(self), arg1(_cmd), arg2, arg3, arg4, arg5</code> 分别使用寄存器 <code>rdi, rsi, rdx, rcx, r8, r9</code> 的值。在调用 <code>objc_msgSend_stret</code> 时第一个参数为 <code>st_addr</code>，其余参数依次后移。为了能够打包出 <code>NSInvocation</code> 实例并传入后续的 <code>forwardInvocation:</code> 方法，在调用 <code>___forwarding___</code> 函数之前会先将所有参数压入栈中。因为寄存器 <code>rsp</code> 为栈指针指向栈顶，所以 <code>rsp</code> 的内容就是 <code>self</code> 啦，因为 <code>x86_64</code> 是小端，栈增长方向是由高地址到低地址，所以从栈顶往下移动一个指针需要<strong>加</strong> <code>0x8（64bit）</code>。而将参数入栈的顺序是从后往前的，也就是说 <code>arg0</code> 是最后一个入栈的，位于栈顶：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"> __CF_forwarding_prep_0:</div><div class="line">0000000000085080         push       rbp                                         ; XREF=___CFInitialize+138</div><div class="line">0000000000085081         mov        rbp, rsp</div><div class="line">0000000000085084         sub        rsp, 0xd0</div><div class="line">000000000008508b         mov        qword [ss:rsp+0xb0], rax</div><div class="line">0000000000085093         movq       qword [ss:rsp+0xa0], xmm7</div><div class="line">000000000008509c         movq       qword [ss:rsp+0x90], xmm6</div><div class="line">00000000000850a5         movq       qword [ss:rsp+0x80], xmm5</div><div class="line">00000000000850ae         movq       qword [ss:rsp+0x70], xmm4</div><div class="line">00000000000850b4         movq       qword [ss:rsp+0x60], xmm3</div><div class="line">00000000000850ba         movq       qword [ss:rsp+0x50], xmm2</div><div class="line">00000000000850c0         movq       qword [ss:rsp+0x40], xmm1</div><div class="line">00000000000850c6         movq       qword [ss:rsp+0x30], xmm0</div><div class="line">00000000000850cc         mov        qword [ss:rsp+0x28], r9</div><div class="line">00000000000850d1         mov        qword [ss:rsp+0x20], r8</div><div class="line">00000000000850d6         mov        qword [ss:rsp+0x18], rcx</div><div class="line">00000000000850db         mov        qword [ss:rsp+0x10], rdx</div><div class="line">00000000000850e0         mov        qword [ss:rsp+0x8], rsi</div><div class="line">00000000000850e5         mov        qword [ss:rsp], rdi</div><div class="line">00000000000850e9         mov        rdi, rsp                                    ; argument #1 for method ____forwarding___</div><div class="line">00000000000850ec         mov        rsi, 0x0                                    ; argument #2 for method ____forwarding___</div><div class="line">00000000000850f3         call       ____forwarding___</div></pre></td></tr></table></figure></p>
<p>消息转发的逻辑几乎都写在 <code>___forwarding___</code> 函数中了，实现比较复杂，反编译出的伪代码也不是很直观。我对 <a href="http://arigrant.com/blog/2013/12/13/a-selector-left-unhandled" target="_blank" rel="external">arigrant.com</a> 的结果完善如下：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">int __forwarding__(void *frameStackPointer, int isStret) &#123;</div><div class="line">  id receiver = *(id *)frameStackPointer;</div><div class="line">  SEL sel = *(SEL *)(frameStackPointer + 8);</div><div class="line">  const char *selName = sel_getName(sel);</div><div class="line">  Class receiverClass = object_getClass(receiver);</div><div class="line"></div><div class="line">  // 调用 forwardingTargetForSelector:</div><div class="line">  if (class_respondsToSelector(receiverClass, @selector(forwardingTargetForSelector:))) &#123;</div><div class="line">    id forwardingTarget = [receiver forwardingTargetForSelector:sel];</div><div class="line">    if (forwardingTarget &amp;&amp; forwarding != receiver) &#123;</div><div class="line">    	if (isStret == 1) &#123;</div><div class="line">    		int ret;</div><div class="line">    		objc_msgSend_stret(&amp;ret,forwardingTarget, sel, ...);</div><div class="line">    		return ret;</div><div class="line">    	&#125;</div><div class="line">      return objc_msgSend(forwardingTarget, sel, ...);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // 僵尸对象</div><div class="line">  const char *className = class_getName(receiverClass);</div><div class="line">  const char *zombiePrefix = &quot;_NSZombie_&quot;;</div><div class="line">  size_t prefixLen = strlen(zombiePrefix); // 0xa</div><div class="line">  if (strncmp(className, zombiePrefix, prefixLen) == 0) &#123;</div><div class="line">    CFLog(kCFLogLevelError,</div><div class="line">          @&quot;*** -[%s %s]: message sent to deallocated instance %p&quot;,</div><div class="line">          className + prefixLen,</div><div class="line">          selName,</div><div class="line">          receiver);</div><div class="line">    &lt;breakpoint-interrupt&gt;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // 调用 methodSignatureForSelector 获取方法签名后再调用 forwardInvocation</div><div class="line">  if (class_respondsToSelector(receiverClass, @selector(methodSignatureForSelector:))) &#123;</div><div class="line">    NSMethodSignature *methodSignature = [receiver methodSignatureForSelector:sel];</div><div class="line">    if (methodSignature) &#123;</div><div class="line">      BOOL signatureIsStret = [methodSignature _frameDescriptor]-&gt;returnArgInfo.flags.isStruct;</div><div class="line">      if (signatureIsStret != isStret) &#123;</div><div class="line">        CFLog(kCFLogLevelWarning ,</div><div class="line">              @&quot;*** NSForwarding: warning: method signature and compiler disagree on struct-return-edness of &apos;%s&apos;.  Signature thinks it does%s return a struct, and compiler thinks it does%s.&quot;,</div><div class="line">              selName,</div><div class="line">              signatureIsStret ? &quot;&quot; : not,</div><div class="line">              isStret ? &quot;&quot; : not);</div><div class="line">      &#125;</div><div class="line">      if (class_respondsToSelector(receiverClass, @selector(forwardInvocation:))) &#123;</div><div class="line">        NSInvocation *invocation = [NSInvocation _invocationWithMethodSignature:methodSignature frame:frameStackPointer];</div><div class="line"></div><div class="line">        [receiver forwardInvocation:invocation];</div><div class="line"></div><div class="line">        void *returnValue = NULL;</div><div class="line">        [invocation getReturnValue:&amp;value];</div><div class="line">        return returnValue;</div><div class="line">      &#125; else &#123;</div><div class="line">        CFLog(kCFLogLevelWarning ,</div><div class="line">              @&quot;*** NSForwarding: warning: object %p of class &apos;%s&apos; does not implement forwardInvocation: -- dropping message&quot;,</div><div class="line">              receiver,</div><div class="line">              className);</div><div class="line">        return 0;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  SEL *registeredSel = sel_getUid(selName);</div><div class="line"></div><div class="line">  // selector 是否已经在 Runtime 注册过</div><div class="line">  if (sel != registeredSel) &#123;</div><div class="line">    CFLog(kCFLogLevelWarning ,</div><div class="line">          @&quot;*** NSForwarding: warning: selector (%p) for message &apos;%s&apos; does not match selector known to Objective C runtime (%p)-- abort&quot;,</div><div class="line">          sel,</div><div class="line">          selName,</div><div class="line">          registeredSel);</div><div class="line">  &#125; // doesNotRecognizeSelector</div><div class="line">  else if (class_respondsToSelector(receiverClass,@selector(doesNotRecognizeSelector:))) &#123;</div><div class="line">    [receiver doesNotRecognizeSelector:sel];</div><div class="line">  &#125; </div><div class="line">  else &#123;</div><div class="line">    CFLog(kCFLogLevelWarning ,</div><div class="line">          @&quot;*** NSForwarding: warning: object %p of class &apos;%s&apos; does not implement doesNotRecognizeSelector: -- abort&quot;,</div><div class="line">          receiver,</div><div class="line">          className);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // The point of no return.</div><div class="line">  kill(getpid(), 9);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这么一大坨代码就是整个消息转发路径的逻辑，概括如下：</p>
<ol>
<li>先调用 <code>forwardingTargetForSelector</code> 方法获取新的 target 作为 receiver 重新执行 selector，如果返回的内容不合法（为 <code>nil</code> 或者跟旧 receiver 一样），那就进入第二步。</li>
<li>调用 <code>methodSignatureForSelector</code> 获取方法签名后，判断返回类型信息是否正确，再调用 <code>forwardInvocation</code> 执行 <code>NSInvocation</code> 对象，并将结果返回。如果对象没实现 <code>methodSignatureForSelector</code> 方法，进入第三步。</li>
<li>调用 <code>doesNotRecognizeSelector</code> 方法。</li>
</ol>
<p><code>doesNotRecognizeSelector</code> 之前其实还有个判断 selector 在 Runtime 中是否注册过的逻辑，但在我们正常发消息的时候不会出此问题。但如果手动创建一个 <code>NSInvocation</code> 对象并调用 <code>invoke</code>，并将第二个参数设置成一个不存在的 selector，那就会导致这个问题，并输入日志 &quot;does not match selector known to Objective C runtime&quot;。较真儿的读者可能会有疑问：何这段逻辑判断干脆用不到却还存在着？难道除了 <code>__CF_forwarding_prep_0</code> 和 <code>___forwarding_prep_1___</code> 函数还有其他函数也调用 <code>___forwarding___</code> 么？莫非消息转发还有其他路径？其实并不是！原因是 <code>___forwarding___</code> 调用了 <code>___invoking___</code> 函数，所以上面的伪代码直接把 <code>___invoking___</code> 函数的逻辑也『翻译』过来了。除了 <code>___forwarding___</code> 函数，以下方法也会调用<code>___invoking___</code> 函数:</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-[NSInvocation invoke]</div><div class="line">-[NSInvocation invokeUsingIMP:]</div><div class="line">-[NSInvocation invokeSuper]</div></pre></td></tr></table></figure></p>
<p><code>doesNotRecognizeSelector</code> 方法其实在 libobj.A.dylib 中已经废弃了，而是在 CF 框架中实现，而且也不是开源的。从函数调用栈可以发现 <code>doesNotRecognizeSelector</code> 之后会抛出异常，而 Runtime 中废弃的实现知识打日志后直接杀掉进程（<code>__builtin_trap()</code>）。下面是 CF 中实现的伪代码：</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">void -[NSObject doesNotRecognizeSelector:](void * self, void * _cmd, void * arg2) &#123;</div><div class="line">    r14 = ___CFFullMethodName([self class], self, arg2);</div><div class="line">    _CFLog(0x3, @&quot;%@: unrecognized selector sent to instance %p&quot;, r14, self, r8, r9, stack[2048]);</div><div class="line">    rbx = _CFMakeCollectable(_CFStringCreateWithFormat(___kCFAllocatorSystemDefault, 0x0, @&quot;%@: unrecognized selector sent to instance %p&quot;));</div><div class="line">    if (*(int8_t *)___CFOASafe != 0x0) &#123;</div><div class="line">            ___CFRecordAllocationEvent();</div><div class="line">    &#125;</div><div class="line">    rax = _objc_rootAutorelease(rbx);</div><div class="line">    rax = [NSException exceptionWithName:@&quot;NSInvalidArgumentException&quot; reason:rax userInfo:0x0];</div><div class="line">    objc_exception_throw(rax);</div><div class="line">    return;</div><div class="line">&#125;</div><div class="line">void +[NSObject doesNotRecognizeSelector:](void * self, void * _cmd, void * arg2) &#123;</div><div class="line">    r14 = ___CFFullMethodName([self class], self, arg2);</div><div class="line">    _CFLog(0x3, @&quot;%@: unrecognized selector sent to class %p&quot;, r14, self, r8, r9, stack[2048]);</div><div class="line">    rbx = _CFMakeCollectable(_CFStringCreateWithFormat(___kCFAllocatorSystemDefault, 0x0, @&quot;%@: unrecognized selector sent to class %p&quot;));</div><div class="line">    if (*(int8_t *)___CFOASafe != 0x0) &#123;</div><div class="line">            ___CFRecordAllocationEvent();</div><div class="line">    &#125;</div><div class="line">    rax = _objc_rootAutorelease(rbx);</div><div class="line">    rax = [NSException exceptionWithName:@&quot;NSInvalidArgumentException&quot; reason:rax userInfo:0x0];</div><div class="line">    objc_exception_throw(rax);</div><div class="line">    return;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也就是说我们可以 override <code>doesNotRecognizeSelector</code> 或者捕获其抛出的异常。在这里还是大有文章可做的。</p>
<h2>总结</h2>
<p>我将整个实现流程绘制出来，过滤了一些不会进入的分支路径和跟主题无关的细节：</p>
<p><img src="http://7ni3rk.com1.z0.glb.clouddn.com/MessageForward/%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E4%B8%8E%E8%BD%AC%E5%8F%91%E8%B7%AF%E5%BE%84%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg" alt="消息发送与转发路径流程图"></p>
<p>介于国内关于这块知识的好多文章描述不够准确和详细，或是对消息转发的原理描述理解不够深刻，或是侧重贴源码而欠思考，所以我做了一个比较全面详细的讲解。</p>
<h2>参考文献</h2>
<ul>
<li><a href="http://arigrant.com/blog/2014/2/12/why-objcmsgsend-must-be-written-in-assembly" target="_blank" rel="external">Why objc_msgSend Must be Written in Assembly</a></li>
<li><a href="http://arigrant.com/blog/2013/12/13/a-selector-left-unhandled" target="_blank" rel="external">Hmmm, What's that Selector?</a></li>
<li><a href="http://blog.zhengdong.me/2013/07/18/a-look-under-the-hood-of-objc-msgsend/" target="_blank" rel="external">A Look Under the Hood of objc_msgSend()</a></li>
<li><a href="http://arigrant.com/blog/2014/2/18/chisels-print-invocation-command" target="_blank" rel="external">Printing Objective-C Invocations in LLDB</a></li>
</ul>

    

    
</div>


                

                <!-- Post Comments -->
                
                    







                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2016/06/13/android_about_page_lib/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2016/06/18/why-not-traditional-medicine/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="John Doe's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        youremail@email.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/04/">四月 2017<span class="sidebar_archives-count">28</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">三月 2017<span class="sidebar_archives-count">37</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">二月 2017<span class="sidebar_archives-count">12</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/01/">一月 2017<span class="sidebar_archives-count">12</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">十二月 2016<span class="sidebar_archives-count">18</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">24</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">39</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">32</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/08/">八月 2016<span class="sidebar_archives-count">32</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">七月 2016<span class="sidebar_archives-count">21</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/06/">六月 2016<span class="sidebar_archives-count">33</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/05/">五月 2016<span class="sidebar_archives-count">20</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/04/">四月 2016<span class="sidebar_archives-count">15</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/03/">三月 2016<span class="sidebar_archives-count">19</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/02/">二月 2016<span class="sidebar_archives-count">16</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/01/">一月 2016<span class="sidebar_archives-count">19</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/12/">十二月 2015<span class="sidebar_archives-count">20</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/11/">十一月 2015<span class="sidebar_archives-count">30</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/10/">十月 2015<span class="sidebar_archives-count">30</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/09/">九月 2015<span class="sidebar_archives-count">27</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/08/">八月 2015<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/07/">七月 2015<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/06/">六月 2015<span class="sidebar_archives-count">10</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/05/">五月 2015<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/04/">四月 2015<span class="sidebar_archives-count">11</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/03/">三月 2015<span class="sidebar_archives-count">10</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/02/">二月 2015<span class="sidebar_archives-count">14</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/01/">一月 2015<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/12/">十二月 2014<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/11/">十一月 2014<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/10/">十月 2014<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/09/">九月 2014<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/08/">八月 2014<span class="sidebar_archives-count">9</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/07/">七月 2014<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/06/">六月 2014<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/05/">五月 2014<span class="sidebar_archives-count">11</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/04/">四月 2014<span class="sidebar_archives-count">32</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/03/">三月 2014<span class="sidebar_archives-count">34</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/02/">二月 2014<span class="sidebar_archives-count">14</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/01/">一月 2014<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/12/">十二月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/07/">七月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/06/">六月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/04/">四月 2013<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/03/">三月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/02/">二月 2013<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/01/">一月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/12/">十二月 2012<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/10/">十月 2012<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/09/">九月 2012<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/07/">七月 2012<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/06/">六月 2012<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/05/">五月 2012<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/08/">八月 2011<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/07/">七月 2011<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/06/">六月 2011<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/05/">五月 2011<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/04/">四月 2011<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/03/">三月 2011<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/02/">二月 2011<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/12/">十二月 2010<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/11/">十一月 2010<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/09/">九月 2010<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/07/">七月 2010<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/06/">六月 2010<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/02/">二月 2010<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/01/">一月 2010<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/09/">九月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/07/">七月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/05/">五月 2009<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/04/">四月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/03/">三月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/02/">二月 2009<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2008/07/">七月 2008<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2008/06/">六月 2008<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-twitter.svg);">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-facebook.svg);">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-gplus.svg);">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;Hexo
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->

    <script src="/js/lazyload.min.js"></script>
    <script src="/js/js.min.js"></script>



    <script src="/js/nprogress.js"></script>


<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>
















<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script>
    <!-- Offer LazyLoad -->
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    <!-- Start Queue -->
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

                </main>
            </div>
        </body>
    
</html>
