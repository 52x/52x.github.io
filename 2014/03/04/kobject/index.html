<!DOCTYPE html>
<html lang="zh">
    <head>
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.4 -->

    <!-- Title -->
    
    <title>
        
            关于 kobject，kset 和 ktype 的一切 | 
        
        Hexo
    </title>

    <!-- Meta & Info -->
    <meta charset="utf-8">

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    

    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="John Doe">
    <meta name="description" content="null">
    <meta name="keywords" content="null,设备模型">

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Hexo">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="关于 kobject，kset 和 ktype 的一切 | Hexo">
    <meta property="og:description" content="null">
    <meta property="og:article:tag" content="设备模型"> 

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS & jQuery -->
    
        <link rel="stylesheet" href="/css/material.min.css">
        <link rel="stylesheet" href="/css/style.min.css">
        <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


        <script src="/js/jquery.min.js"></script>
        <script src="/js/queue.js"></script>
    

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    


    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">1.</span> <span class="post-toc-text">内嵌 kobject</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">2.</span> <span class="post-toc-text">kobject 的初始化</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.</span> <span class="post-toc-text">Uevents</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.</span> <span class="post-toc-text">引用计数</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.</span> <span class="post-toc-text">创建“简单”的 kobject</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">6.</span> <span class="post-toc-text">ktypes 和 release 方法</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">7.</span> <span class="post-toc-text">ksets</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">8.</span> <span class="post-toc-text">kobject 的移除</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">9.</span> <span class="post-toc-text">示例代码</span></a></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                关于 kobject，kset 和 ktype 的一切
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>John Doe</strong>
        <span>3月 04, 2014</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/设备模型/">设备模型</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=关于 kobject，kset 和 ktype 的一切&url=http://yoursite.com//2014/03/04/kobject/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=关于 kobject，kset 和 ktype 的一切&url=http://yoursite.com//2014/03/04/kobject/index.html&via=John Doe" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com//2014/03/04/kobject/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com//2014/03/04/kobject/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <p>翻译原文链接：<a href="http://blog.chinaunix.net/uid-20522771-id-3447116.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-20522771-id-3447116.html</a>
内核文档： Documentation/kobject.txt</p>
<blockquote>
<p>Everything you never wanted to know about kobjects, ksets, and ktypes
你永远不会想知道的关于 kobject，kset 和 ktype 的一切
Greg Kroah-Hartman</p>
</blockquote>
<p>Based on an original article by Jon Corbet for lwn.net written October 1,
2003 and located at <a href="http://lwn.net/Articles/51437/" target="_blank" rel="external">http://lwn.net/Articles/51437/</a></p>
<p>Last updated December 19, 2007
&lt;!--more--&gt;
理解那些建立在<code>kobject</code>抽象之上的驱动模型的困难之一就是没有一个明确的入口。
使用<code>kobject</code>需要了解几种不同的类型，而这些类型又会相互引用。为了让这一切变
得简单些，我们将采取多通道方法，以模糊的术语开始，然后逐渐添加细节。为此，
现在给出一些今后会使用到的一些术语的简单定义。</p>
<ul>
<li>
<p><code>kobject</code>是一个<code>struct kobject</code>类型的对象。<code>kobject</code>包含一个名字和一个
引用计数。同时一个<code>kobject</code>还包含一个父指针（允许对象被安排成层次结构）、
一个特定的类型，通常情况下还有一个在<code>sysfs</code>虚拟文件系统里的表现。
通常我们并不关注<code>kobject</code>本身，而应该关注那些嵌入了<code>kobject</code>的那些结构体。
任何结构体都不允许包含一个以上的<code>kobject</code>。如果这么做，那么引用计数将肯
定会出错，你的代码也将bug百出。所以千万别这么做。</p>
</li>
<li>
<p><code>ktype</code>是嵌入了<code>kobject</code>的对象的类型。每个嵌入了<code>kobject</code>的对象都需要一个
相应的<code>ktype</code>。<code>ktype</code>用来控制当<code>kobject</code>创建和销毁时所发生的操作。</p>
</li>
<li>
<p><code>kset</code>是<code>kobject</code>的一组集合。这些<code>kobject</code>可以是同样的<code>ktype</code>，也可以分别
属于不同的<code>ktype</code>。<code>kset</code>是<code>kobject</code>集合的基本容器类型。<code>kset</code>也包含它们自
己的<code>kobject</code>，但是你可以放心的忽略这些<code>kobjects</code>，因为<code>kset</code>的核心代码会
自动处理这些<code>kobject</code>。</p>
<p>当你看到一个<code>sysfs</code>目录里全都是其它目录时，通常每一个目录都对应着一个在
同一个<code>kset</code>里的<code>kobject</code>。</p>
</li>
</ul>
<p>我们来看看如何创建和操作所有的这些类型。因为采用自下而上的方法，所以我们
首先回到<code>kobject</code>。</p>
<p><code>kobject</code>结构定义如下：
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> kobject &#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span>              *name;</div><div class="line">        <span class="keyword">struct</span> list_head        entry;</div><div class="line">        <span class="keyword">struct</span> kobject          *parent;</div><div class="line">        <span class="keyword">struct</span> kset             *kset;</div><div class="line">        <span class="keyword">struct</span> kobj_type        *ktype;</div><div class="line">        <span class="keyword">struct</span> sysfs_dirent     *sd;</div><div class="line">        <span class="keyword">struct</span> kref             kref;</div><div class="line">        .</div><div class="line">        .</div><div class="line">        .</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h2>内嵌 kobject</h2>
<p>就内核代码而言，基本上不会创建一个单独的<code>kobject</code>，但也有例外，这以后再说。
其实，<code>kobject</code>通常被用来控制一个更大的特定域对象。因此你将发现<code>kobject</code>都被
嵌入到了其他的结构体当中。如果从面向对象的观点出发，那么<code>kobject</code>可以被看做
是被其他类继承的、顶层的、抽象的类。一个<code>kobject</code>实现了一组对于它们自己不是
很有用，但对那些包含了这个<code>kobject</code>的对象很有用的功能。另外 C 语言不支持直接
使用继承，所以必须依靠其他的技术来实现，比如结构体嵌套。</p>
<p>（顺便说一句，对于那些熟悉内核链表实现的同志来说，这和“list_head”结构体很
类似。它们都是本身没什么用，其真正的价值是在嵌套进一个更大的结构体中才得以
体现。）</p>
<p>举一个例子，drivers/uio/uio.c 里的 UIO 代码包含一个定义了内存区域的 uio 设备。
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> uio_map &#123;</div><div class="line">    <span class="keyword">struct</span> kobject kobj;</div><div class="line">    <span class="keyword">struct</span> uio_mem *mem;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>如果你有一个<code>struct uio_map</code>结构体，使用它的成员<code>kobj</code>就能找到嵌套的<code>kobject</code>。
但是操作<code>kobject</code>的代码往往会引出一个相反的问题：如果给定一个<code>struct kobject</code>
指针，那么包含这个指针的结构体又是什么呢？别投机取巧（比如假设这个<code>kobject</code>
是该结构体的第一个字段），你应该使用<code>container_of()</code>宏函数：
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">container_of(pointer, type, member)</div></pre></td></tr></table></figure></p>
<p>其中：</p>
<ul>
<li>&quot;<code>pointer</code>&quot; 是指向被嵌入的<code>kobject</code>的指针。</li>
<li>&quot;<code>type</code>&quot; 是包含<code>kobject</code>的结构体类型。</li>
<li>&quot;<code>member</code>&quot; 是结构体中&quot;<code>pointer</code>&quot;所指向的字段名。
<code>container_of()</code>的返回值就是一个相应结构体的指针。例如，一个指向嵌套在<code>uio_map</code>里的<code>struct kobject</code>的指针“<code>kp</code>”，可以这样获得包含它的结构体的指针：
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> uio_map *u_map = container_of(kp, <span class="keyword">struct</span> uio_map, kobj);</div></pre></td></tr></table></figure></li>
</ul>
<p>为方便起见，程序员通常会定义一个简单的宏，用于“反指”包含这个<code>kobject</code>的容器
类型指针。正因为这样，在以前的文件 drivers/uio/uio.c 中你可以看到：
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> uio_map &#123;</div><div class="line">    <span class="keyword">struct</span> kobject kobj;</div><div class="line">    <span class="keyword">struct</span> uio_mem *mem;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> to_map(map) container_of(map, struct uio_map, kobj)</span></div></pre></td></tr></table></figure></p>
<p>宏参数“<code>map</code>”是一个指向<code>struct kobject</code>的指针。这个宏函数将随后被调用：
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> uio_map *<span class="built_in">map</span> = to_map(kobj);</div></pre></td></tr></table></figure></p>
<h2>kobject 的初始化</h2>
<p>创建一个<code>kobject</code>的代码首先必须初始化这个对象。调用<code>kobject_init()</code>来设置一些
内部字段（强制性的）：
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">kobject_init</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_type *ktype)</span></span>;</div></pre></td></tr></table></figure></p>
<p>因为每一个<code>kobject</code>都有一个关联的<code>kobj_type</code>，所以正确创建一个<code>kobject</code>时
<code>ktype</code>是必须的。调用<code>kobject_init()</code>之后，必须是用<code>kobject_add()</code>在<code>sysfs</code>上
注册<code>kobject</code>。
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">kobject_add</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobject *parent, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</div></pre></td></tr></table></figure></p>
<p>这将为<code>kobject</code>设置<code>parent</code>和<code>name</code>。如果这个<code>kobject</code>将关联于一个指定的
<code>kset</code>，那么<code>kobj-&gt;kset</code>必须在<code>kobject_add()</code>之前被赋值。如果一个<code>ket</code>关联
于一个<code>kobject</code>，那么在调用<code>kobject_add()</code>时<code>parent</code>可以是<code>NULL</code>，这时<code>kobject</code>
的<code>parent</code>将会是这个<code>kset</code>本身。</p>
<p>当一个<code>kobject</code>的<code>name</code>已经被设置并添加至<code>kernel</code>之后，就不允许直接操作这个
<code>kobject</code>的<code>name</code>了。如果你必须修改这个<code>name</code>，请使用<code>kobject_rename()</code>:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">kobject_rename</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">const</span> <span class="keyword">char</span> *new_name)</span></span>;</div></pre></td></tr></table></figure></p>
<p><code>kobject_rename</code>不会执行任何锁定操作，也不会验证<code>name</code>的有效性，所以调用者
必须提供自己的完整性检查和序列化。</p>
<p>这里有一个函数<code>kobject_set_name()</code>，但这个函数是遗留问题，而且在将来会被删
除。如果你的代码需要调用这个函数，那么这将是不正确的并且必须被修正。</p>
<p>要正确访问<code>kobject</code>的<code>name</code>，使用这个函数<code>kobject_name()</code>:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">kobject_name</span><span class="params">(<span class="keyword">const</span> <span class="keyword">struct</span> kobject * kobj)</span></span>;</div></pre></td></tr></table></figure></p>
<p>这里有一个辅助函数将同时初始化<code>kobject</code>并将其添加至 kernel，<code>kobject_init_and_add()</code>:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">kobject_init_and_add</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_type *ktype,</span></span></div><div class="line">                         <span class="keyword">struct</span> kobject *parent, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...);</div></pre></td></tr></table></figure></p>
<p>其中的参数与<code>kobject_init()</code>和<code>kobject_add()</code>里描述的一致。</p>
<h2>Uevents</h2>
<p>在一个<code>kobject</code>注册到核心(core)之后，你需要通过<code>kobject_uevent()</code>向系统宣布它被创建了。
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">kobject_uevent</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">enum</span> kobject_action action)</span></span>;</div></pre></td></tr></table></figure></p>
<p>当<code>kobject</code>首次被添加进 kernel 时，使用<code>KOBJ_ADD</code>动作。这个调用必须在<code>kobject</code>所有
的<code>attributes</code>或<code>children</code>都被正确初始化之后，因为当这个调用发生时，用户空间将会
立即开始寻找它们。</p>
<p>当<code>kobject</code>从 kernel 中移除时，<code>KOBJ_REMOVE</code>的<code>uevent</code>将会被<code>kobject</code>核心(core)
自动创建，所以调用者不必担心手动完成这些。</p>
<h2>引用计数</h2>
<p>一个<code>kobject</code>的主要功能之一就是在它被嵌入的对象中作为一个引用计数器。只要存
在对该对象的引用，对象（和支持它的代码）就必须继续存在。操作一个<code>kobject</code>的
引用计数的底层函数是：
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">struct</span> kobject *<span class="title">kobject_get</span><span class="params">(<span class="keyword">struct</span> kobject *kobj)</span></span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">kobject_put</span><span class="params">(<span class="keyword">struct</span> kobject *kobj)</span></span>;</div></pre></td></tr></table></figure></p>
<p>对<code>kobject_get()</code>的成功调用将递增<code>kobject</code>的引用计数并且返回指向该<code>kobject</code>的指针。</p>
<p>当一个引用被释放时，调用<code>kobject_put()</code>将递减引用计数，并且可能的话，释放对象。
请注意，<code>kobject_init()</code>将引用计数设置为 1，所以在建立<code>kobject</code>的代码里需要执行
<code>kobject_put()</code>用于最终释放该引用。</p>
<p>因为<code>kobject</code>是动态的，所以它们不能被声明为静态的或者在栈区分配空间，它们
应该始终被动态分配。未来的 kernel 版本将会包含一个对<code>kobject</code>是否静态创建的
运行时检查，并且会警告开发人员这种不正确的使用。</p>
<p>如果你使用<code>kobject</code>的理由仅仅是使用引用计数的话，那么请使用<code>struct kref</code>替代
<code>kobject</code>。更多关于<code>struct kref</code>的信息请参考 Linux 内核文档 Documentation/kref.txt</p>
<h2>创建“简单”的 kobject</h2>
<p>有时开发人员希望有一种创建一个在 sysfs 层次中简单目录的方式，而并不想搞乱本来
就错综复杂的<code>ksets</code>，<code>show</code> 和<code>store</code>函数，或一些其他的细节。这是一个创建单独的
<code>kobjects</code>的一个例外。要创建这样的条目，使用这个函数：
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">struct</span> kobject *<span class="title">kobject_create_and_add</span><span class="params">(<span class="keyword">char</span> *name, <span class="keyword">struct</span> kobject *parent)</span></span>;</div></pre></td></tr></table></figure></p>
<p>此函数将创建一个<code>kobject</code>，并将其放置在指定的父<code>kobject</code>在 sysfs 中的目录下。
要创建简单的与这个<code>kobject</code>关联的属性，使用函数：
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">sysfs_create_file</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> attribute *attr)</span></span>;</div></pre></td></tr></table></figure></p>
<p>或者
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">sysfs_create_group</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> attribute_group *grp)</span></span>;</div></pre></td></tr></table></figure></p>
<p>这两种使用<code>kobject_create_and_add()</code>创建的<code>kobject</code>的属性类型都可以是
<code>kobj_attribute</code>，所以没有创建自定义属性的需要。</p>
<p>查看示例模块 samples/kobject/kobject-example.c，一个简单的<code>kobject</code>
及其属性的实现。</p>
<h2>ktypes 和 release 方法</h2>
<p>到目前为止我们遗漏了一个重要的事情，那就是当一个<code>kobject</code>的引用计数达到 0 时将
会发生什么。通常，创建<code>kobject</code>的代码并不知道这种情况何时发生。如果它们知道何
时发生，那么把<code>kobject</code>放在结构体的首位可能会有那么一点点帮助。即使是一个可预
测的对象生命周期也将变得复杂，特别是在 sysfs 作为 kernel 的一部分被引入时，它
可以获取到任意在系统中注册的<code>kobject</code>的引用。</p>
<p>结论就是一个被<code>kobject</code>保护的结构体不能在这个<code>kobject</code>引用计数到 0 之前被释放。
而这个引用计数又不被创建这个<code>kobject</code>的代码所直接控制，所以必须在这个<code>kobject</code>
的最后一个引用消失时异步通知这些代码。</p>
<p>一旦你通过<code>kobject_add()</code> 注册你的<code>kobject</code>之后，永远也不要使用<code>kfree()</code>去释
放直接它。唯一安全的途径是使用<code>kobject_put()</code>。总是在<code>kobject_init()</code>之后使
用<code>kobject_put()</code>是避免错误蔓延的很好的做法。</p>
<p>这个通知是通过<code>kobject</code>的<code>release()</code>函数完成的。该函数通常具有这样的形式：
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">my_object_release</span><span class="params">(<span class="keyword">struct</span> kobject *kobj)</span></span></div><div class="line">&#123;</div><div class="line">   <span class="keyword">struct</span> my_object *mine = container_of(kobj, <span class="keyword">struct</span> my_object, kobj);</div><div class="line"></div><div class="line">   kfree(mine);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>很重要的一点怎么强调也不过分：每个<code>kobject</code>必须有一个<code>release()</code>方法，而且
在这个方法被调用之前<code>kobject</code>必须继续存在（保持一致的状态）。如果不符合这
些限制，那么代码是有缺陷的。需要注意的是，如果你忘记提供一个<code>release()</code>方法，
kernel 会警告你。不要试图提供一个“空”的<code>release</code>函数来摆脱这个警告，如果你
这样做你会受到<code>kobject</code>维护者们无情的嘲笑。</p>
<p>注意，尽管在<code>release</code>函数中<code>kobject</code>的<code>name</code>是可用的，但是千万不要在这个回调函
数中修改它。否则将会在<code>kobject</code>核心(core)中发生令人不愉快的内存泄露问题。</p>
<p>有趣的是<code>release()</code>方法并没有保存在<code>kobject</code>之中，而是关联在它的<code>ktype</code>
成员中。让我们来介绍<code>struct kobj_type</code>:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> kobj_type &#123;</div><div class="line">    <span class="keyword">void</span> (*release)(<span class="keyword">struct</span> kobject *);</div><div class="line">    <span class="keyword">const</span> <span class="keyword">struct</span> sysfs_ops *sysfs_ops;</div><div class="line">    <span class="keyword">struct</span> attribute **default_attrs;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>这个结构体是用来描述一个特定类型的<code>kobject</code>（或者更确切的说，包含它的对象）。
每个<code>kobject</code>都需要一个关联的<code>kobj_type</code>结构体，当你调用<code>kobject_init()</code>或
<code>kobject_init_and_add()</code>时必须指定一个指向<code>kobj_type</code>结构体的指针。</p>
<p>当然<code>struct kobj_type</code>中的<code>release</code>字段就是一个指向同类型对象<code>release()</code>方法的
函数指针。另外两个字段（<code>sysfs_ops</code>和<code>default_attrs</code>）是用来控制这些类型的对象在
sysfs 里是如何表现的，这已经超出了本文的讨论范围。</p>
<p><code>default_attrs</code>成员指针是一个在任何属于这个<code>ktype</code>的<code>kobject</code>注册时自动创
建的默认属性列表。</p>
<h2>ksets</h2>
<p><code>kset</code>仅仅是一个需要相互关联的<code>kobject</code>集合。在这里没有任何规定它们必须是同
样的<code>ktype</code>，但如果它们不是一样的<code>ktype</code>，则一定要小心处理。</p>
<p>一个<code>kset</code>提供以下功能：</p>
<ul>
<li>它就像一个装有一堆对象袋子。<code>kset</code>可以被 kernel 用来跟踪像“所有的块设备”
或者“所有的 PCI 设备驱动”这样的东西。</li>
<li>一个<code>kset</code>也是一个 sysfs 里的子目录，该目录里能够看见这些相关的<code>kobject</code>。
每个<code>kset</code>都包含一个<code>kobject</code>，这个<code>kobject</code>可以用来设置成其他<code>kobjects</code>
的<code>parent</code>。sysfs 层次结构中的顶层目录就是通过这样的方法构建的。</li>
<li><code>kset</code>还可以支持<code>kobject</code>的“热插拔”，并会影响<code>uevent</code>事件如何报告给用户空间。</li>
</ul>
<p>以面向对象的观点来看，“<code>kset</code>” 是一个顶层容器类。<code>kset</code>包含有它们自己的<code>kobject</code>，
这个<code>kobject</code>是在<code>kset</code>代码管理之下的，而且不允许其他任何用户对其操作。</p>
<p>一个<code>kset</code>使用标准的 kernel 链表来保存它的<code>children</code>。<code>kobjects</code>通过它们的<code>kset</code>
字段回指向包含它们的<code>kset</code>。在几乎所有的情况下，属于某<code>kset</code>的<code>kobject</code>的
<code>parent</code>都指向这个<code>kset</code>（严格来说是嵌套进这个<code>kset</code>的<code>kobject</code>）。</p>
<p>正是因为一个<code>kset</code>包含了一个<code>kobject</code>，就应该始终动态创建这个<code>kset</code>，千万
不要将其声明为静态的或在栈区分配空间。创建一个<code>kset</code>使用：
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">struct</span> kset *<span class="title">kset_create_and_add</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name,</span></span></div><div class="line">                                 <span class="keyword">struct</span> kset_uevent_ops *u,</div><div class="line">                                 <span class="keyword">struct</span> kobject *parent);</div></pre></td></tr></table></figure></p>
<p>当你使用完一个<code>kset</code>时，调用这个函数：
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">kset_unregister</span><span class="params">(<span class="keyword">struct</span> kset *kset)</span></span>;</div></pre></td></tr></table></figure></p>
<p>来销毁它。</p>
<p>内核树中的 samples/kobject/kset-example.c 文件是一个
有关于如何使用<code>kset</code>的示例。</p>
<p>如果一个<code>kset</code>希望控制那些与它相关联的<code>kobject</code>的<code>uevent</code>操作，可以使用
<code>struct kset_uevent_ops</code>处理。
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> kset_uevent_ops &#123;</div><div class="line">    <span class="keyword">int</span> (*filter)(<span class="keyword">struct</span> kset *kset, <span class="keyword">struct</span> kobject *kobj);</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *(*name)(<span class="keyword">struct</span> kset *kset, <span class="keyword">struct</span> kobject *kobj);</div><div class="line">    <span class="keyword">int</span> (*uevent)(<span class="keyword">struct</span> kset *kset, <span class="keyword">struct</span> kobject *kobj,</div><div class="line">                  <span class="keyword">struct</span> kobj_uevent_env *env);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p><code>filter</code>函数允许<code>kset</code>阻止一个特定的<code>kobject</code>的<code>uevent</code>是否发送到用户空间。如果
这个函数返回 0，则<code>uevent</code>将不会被发出。</p>
<p><code>name</code>函数用来重写那些将被<code>uevent</code>发送到用户空间的<code>kset</code>的默认名称。默认情况下，
这个名称应该和<code>kset</code>本身的名称相同，但如果提供这个函数，则可以改写这个名称。</p>
<p><code>uevent</code>函数会向即将被发送到用户空间的<code>uevent</code>添加更多的环境变量。</p>
<p>有人可能会问，当一个<code>kobject</code>加入到一个<code>kset</code> 但没有提供完成这些功能的函数时，情况会怎样？
答案就是这些任务将由<code>kobject_add()</code>来完成，当一个<code>kobject</code>传递给<code>kobject_add()</code>函数，它的<code>kset</code>成员必将指向它将被
加入到的<code>kset</code>，然后<code>kobject_add()</code>会帮你干完剩下的活。</p>
<p>如果一个属于某个<code>kset</code>的<code>kobject</code>没有设置它的<code>parent kobject</code>，那么它将被
添加到<code>kset</code>的目录中去。但并不是<code>kset</code>的所有成员都一定存在于<code>kset</code>目录下。
如果在<code>kobject</code>被添加前就指明了它的<code>parent kobject</code>， 那么该<code>kobject</code>将被
注册到这个<code>kset</code>下，然后添加到它的<code>parent kobject</code>下。</p>
<h2>kobject 的移除</h2>
<p>当一个<code>kobject</code>成功的注册到<code>kobject</code>核心(core)之后，这个<code>kobject</code>必须在代码完成对它的
使用时销毁。要做到这一点，请调用<code>kobject_put()</code>。通过这个调用，<code>kobject</code> 核心(core)会
自动清理所有通过这个<code>kobject</code>分配的内存空间。如果曾经为了这个<code>kobject</code>发送过一个
<code>KOBJ_ADD</code> uevent，那么一个相应的<code>KOBJ_REMOVE</code> uevent 将会被发送，并且任何
其他的 sysfs 维护者都将为这个调用作出相应的处理。</p>
<p>如果你需要分两步来删除一个<code>kobject</code>的话（也就是说在你需要销毁一个对象时不允
许 sleep），那么请使用<code>kobject_del()</code>从 sysfs 注销这个<code>kobject</code>。这将使得该
<code>kobject</code> “不可见”，但是它并没有被清理，并且它的引用计数也没变。在稍后的时候
调用<code>kobject_put()</code>去完成与这个<code>kobject</code>相关的内存空间的清理。</p>
<p>如果建立了循环引用，<code>kobject_del()</code>可以用来删除指向<code>parent</code>对象的引用。
一些情况下，某个<code>parnet</code>对象引用了它的<code>child</code>是合法的，循环引用必须
显式的通过调用<code>kobject_del()</code> 来打破，这样做之后将会调用一个<code>release</code>函数，
先前在循环引用中的对象才会彼此释放。</p>
<h2>示例代码</h2>
<p>想要获得更完整的关于正确使用<code>kset</code>和<code>kobject</code>的例子，请参考示例程序
samples/kobject/{kobject-example.c,kset-example.c}。可以通过选择编译条件
<code>CONFIG_SAMPLE_KOBJECT</code>来把这些示例编译成可装载模块。</p>
<p>samples/kobject/kobject-example.c
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * Sample kobject implementation</div><div class="line"> *</div><div class="line"> * Copyright (C) 2004-2007 Greg Kroah-Hartman &lt;greg@kroah.com&gt;</div><div class="line"> * Copyright (C) 2007 Novell Inc.</div><div class="line"> *</div><div class="line"> * Released under the GPL version 2 only.</div><div class="line"> *</div><div class="line"> */</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kobject.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sysfs.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * This module shows how to create a simple subdirectory in sysfs called</div><div class="line"> * /sys/kernel/kobject-example  In that directory, 3 files are created:</div><div class="line"> * "foo", "baz", and "bar".  If an integer is written to these files, it can be</div><div class="line"> * later read out of it.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> foo;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> baz;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> bar;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * The "foo" file where a static variable is read from and written to.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">foo_show</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_attribute *attr,</span></span></div><div class="line">			<span class="keyword">char</span> *buf)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">sprintf</span>(buf, <span class="string">"%d\n"</span>, foo);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">foo_store</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_attribute *attr,</span></span></div><div class="line">			 <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> count)</div><div class="line">&#123;</div><div class="line">	<span class="built_in">sscanf</span>(buf, <span class="string">"%du"</span>, &amp;foo);</div><div class="line">	<span class="keyword">return</span> count;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> kobj_attribute foo_attribute =</div><div class="line">	__ATTR(foo, <span class="number">0666</span>, foo_show, foo_store);</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * More complex function where we determine which variable is being accessed by</div><div class="line"> * looking at the attribute for the "baz" and "bar" files.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">b_show</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_attribute *attr,</span></span></div><div class="line">		      <span class="keyword">char</span> *buf)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> var;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (<span class="built_in">strcmp</span>(attr-&gt;attr.name, <span class="string">"baz"</span>) == <span class="number">0</span>)</div><div class="line">		var = baz;</div><div class="line">	<span class="keyword">else</span></div><div class="line">		var = bar;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">sprintf</span>(buf, <span class="string">"%d\n"</span>, var);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">b_store</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> kobj_attribute *attr,</span></span></div><div class="line">		       <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> count)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> var;</div><div class="line"></div><div class="line">	<span class="built_in">sscanf</span>(buf, <span class="string">"%du"</span>, &amp;var);</div><div class="line">	<span class="keyword">if</span> (<span class="built_in">strcmp</span>(attr-&gt;attr.name, <span class="string">"baz"</span>) == <span class="number">0</span>)</div><div class="line">		baz = var;</div><div class="line">	<span class="keyword">else</span></div><div class="line">		bar = var;</div><div class="line">	<span class="keyword">return</span> count;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> kobj_attribute baz_attribute =</div><div class="line">	__ATTR(baz, <span class="number">0666</span>, b_show, b_store);</div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> kobj_attribute bar_attribute =</div><div class="line">	__ATTR(bar, <span class="number">0666</span>, b_show, b_store);</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Create a group of attributes so that we can create and destroy them all</div><div class="line"> * at once.</div><div class="line"> */</div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> attribute *attrs[] = &#123;</div><div class="line">	&amp;foo_attribute.attr,</div><div class="line">	&amp;baz_attribute.attr,</div><div class="line">	&amp;bar_attribute.attr,</div><div class="line">	<span class="literal">NULL</span>,	<span class="comment">/* need to NULL terminate the list of attributes */</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * An unnamed attribute group will put all of the attributes directly in</div><div class="line"> * the kobject directory.  If we specify a name, a subdirectory will be</div><div class="line"> * created for the attributes with the directory being the name of the</div><div class="line"> * attribute group.</div><div class="line"> */</div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> attribute_group attr_group = &#123;</div><div class="line">	.attrs = attrs,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> kobject *example_kobj;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">example_init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> retval;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Create a simple kobject with the name of "kobject_example",</div><div class="line">	 * located under /sys/kernel/</div><div class="line">	 *</div><div class="line">	 * As this is a simple directory, no uevent will be sent to</div><div class="line">	 * userspace.  That is why this function should not be used for</div><div class="line">	 * any type of dynamic kobjects, where the name and number are</div><div class="line">	 * not known ahead of time.</div><div class="line">	 */</div><div class="line">	example_kobj = kobject_create_and_add(<span class="string">"kobject_example"</span>, kernel_kobj);</div><div class="line">	<span class="keyword">if</span> (!example_kobj)</div><div class="line">		<span class="keyword">return</span> -ENOMEM;</div><div class="line"></div><div class="line">	<span class="comment">/* Create the files associated with this kobject */</span></div><div class="line">	retval = sysfs_create_group(example_kobj, &amp;attr_group);</div><div class="line">	<span class="keyword">if</span> (retval)</div><div class="line">		kobject_put(example_kobj);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> retval;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">example_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">	kobject_put(example_kobj);</div><div class="line">&#125;</div><div class="line"></div><div class="line">module_init(example_init);</div><div class="line">module_exit(example_exit);</div><div class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</div><div class="line">MODULE_AUTHOR(<span class="string">"Greg Kroah-Hartman &lt;greg@kroah.com&gt;"</span>);</div></pre></td></tr></table></figure></p>
<p>samples/kobject/kset-example.c
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * Sample kset and ktype implementation</div><div class="line"> *</div><div class="line"> * Copyright (C) 2004-2007 Greg Kroah-Hartman &lt;greg@kroah.com&gt;</div><div class="line"> * Copyright (C) 2007 Novell Inc.</div><div class="line"> *</div><div class="line"> * Released under the GPL version 2 only.</div><div class="line"> *</div><div class="line"> */</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kobject.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sysfs.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * This module shows how to create a kset in sysfs called</div><div class="line"> * /sys/kernel/kset-example</div><div class="line"> * Then tree kobjects are created and assigned to this kset, "foo", "baz",</div><div class="line"> * and "bar".  In those kobjects, attributes of the same name are also</div><div class="line"> * created and if an integer is written to these files, it can be later</div><div class="line"> * read out of it.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * This is our "object" that we will create a few of and register them with</div><div class="line"> * sysfs.</div><div class="line"> */</div><div class="line"><span class="keyword">struct</span> foo_obj &#123;</div><div class="line">	<span class="keyword">struct</span> kobject kobj;</div><div class="line">	<span class="keyword">int</span> foo;</div><div class="line">	<span class="keyword">int</span> baz;</div><div class="line">	<span class="keyword">int</span> bar;</div><div class="line">&#125;;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> to_foo_obj(x) container_of(x, struct foo_obj, kobj)</span></div><div class="line"></div><div class="line"><span class="comment">/* a custom attribute that works just for a struct foo_obj. */</span></div><div class="line"><span class="keyword">struct</span> foo_attribute &#123;</div><div class="line">	<span class="keyword">struct</span> attribute attr;</div><div class="line">	<span class="keyword">ssize_t</span> (*show)(<span class="keyword">struct</span> foo_obj *foo, <span class="keyword">struct</span> foo_attribute *attr, <span class="keyword">char</span> *buf);</div><div class="line">	<span class="keyword">ssize_t</span> (*store)(<span class="keyword">struct</span> foo_obj *foo, <span class="keyword">struct</span> foo_attribute *attr, <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> count);</div><div class="line">&#125;;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> to_foo_attr(x) container_of(x, struct foo_attribute, attr)</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * The default show function that must be passed to sysfs.  This will be</div><div class="line"> * called by sysfs for whenever a show function is called by the user on a</div><div class="line"> * sysfs file associated with the kobjects we have registered.  We need to</div><div class="line"> * transpose back from a "default" kobject to our custom struct foo_obj and</div><div class="line"> * then call the show function for that specific object.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">foo_attr_show</span><span class="params">(<span class="keyword">struct</span> kobject *kobj,</span></span></div><div class="line">			     <span class="keyword">struct</span> attribute *attr,</div><div class="line">			     <span class="keyword">char</span> *buf)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">struct</span> foo_attribute *attribute;</div><div class="line">	<span class="keyword">struct</span> foo_obj *foo;</div><div class="line"></div><div class="line">	attribute = to_foo_attr(attr);</div><div class="line">	foo = to_foo_obj(kobj);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!attribute-&gt;show)</div><div class="line">		<span class="keyword">return</span> -EIO;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> attribute-&gt;show(foo, attribute, buf);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Just like the default show function above, but this one is for when the</div><div class="line"> * sysfs "store" is requested (when a value is written to a file.)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">foo_attr_store</span><span class="params">(<span class="keyword">struct</span> kobject *kobj,</span></span></div><div class="line">			      <span class="keyword">struct</span> attribute *attr,</div><div class="line">			      <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> len)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">struct</span> foo_attribute *attribute;</div><div class="line">	<span class="keyword">struct</span> foo_obj *foo;</div><div class="line"></div><div class="line">	attribute = to_foo_attr(attr);</div><div class="line">	foo = to_foo_obj(kobj);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!attribute-&gt;store)</div><div class="line">		<span class="keyword">return</span> -EIO;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> attribute-&gt;store(foo, attribute, buf, len);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* Our custom sysfs_ops that we will associate with our ktype later on */</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct</span> sysfs_ops foo_sysfs_ops = &#123;</div><div class="line">	.show = foo_attr_show,</div><div class="line">	.store = foo_attr_store,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * The release function for our object.  This is REQUIRED by the kernel to</div><div class="line"> * have.  We free the memory held in our object here.</div><div class="line"> *</div><div class="line"> * NEVER try to get away with just a "blank" release function to try to be</div><div class="line"> * smarter than the kernel.  Turns out, no one ever is...</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">foo_release</span><span class="params">(<span class="keyword">struct</span> kobject *kobj)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">struct</span> foo_obj *foo;</div><div class="line"></div><div class="line">	foo = to_foo_obj(kobj);</div><div class="line">	kfree(foo);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * The "foo" file where the .foo variable is read from and written to.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">foo_show</span><span class="params">(<span class="keyword">struct</span> foo_obj *foo_obj, <span class="keyword">struct</span> foo_attribute *attr,</span></span></div><div class="line">			<span class="keyword">char</span> *buf)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">sprintf</span>(buf, <span class="string">"%d\n"</span>, foo_obj-&gt;foo);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">foo_store</span><span class="params">(<span class="keyword">struct</span> foo_obj *foo_obj, <span class="keyword">struct</span> foo_attribute *attr,</span></span></div><div class="line">			 <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> count)</div><div class="line">&#123;</div><div class="line">	<span class="built_in">sscanf</span>(buf, <span class="string">"%du"</span>, &amp;foo_obj-&gt;foo);</div><div class="line">	<span class="keyword">return</span> count;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> foo_attribute foo_attribute =</div><div class="line">	__ATTR(foo, <span class="number">0666</span>, foo_show, foo_store);</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * More complex function where we determine which variable is being accessed by</div><div class="line"> * looking at the attribute for the "baz" and "bar" files.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">b_show</span><span class="params">(<span class="keyword">struct</span> foo_obj *foo_obj, <span class="keyword">struct</span> foo_attribute *attr,</span></span></div><div class="line">		      <span class="keyword">char</span> *buf)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> var;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (<span class="built_in">strcmp</span>(attr-&gt;attr.name, <span class="string">"baz"</span>) == <span class="number">0</span>)</div><div class="line">		var = foo_obj-&gt;baz;</div><div class="line">	<span class="keyword">else</span></div><div class="line">		var = foo_obj-&gt;bar;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">sprintf</span>(buf, <span class="string">"%d\n"</span>, var);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">b_store</span><span class="params">(<span class="keyword">struct</span> foo_obj *foo_obj, <span class="keyword">struct</span> foo_attribute *attr,</span></span></div><div class="line">		       <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> count)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> var;</div><div class="line"></div><div class="line">	<span class="built_in">sscanf</span>(buf, <span class="string">"%du"</span>, &amp;var);</div><div class="line">	<span class="keyword">if</span> (<span class="built_in">strcmp</span>(attr-&gt;attr.name, <span class="string">"baz"</span>) == <span class="number">0</span>)</div><div class="line">		foo_obj-&gt;baz = var;</div><div class="line">	<span class="keyword">else</span></div><div class="line">		foo_obj-&gt;bar = var;</div><div class="line">	<span class="keyword">return</span> count;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> foo_attribute baz_attribute =</div><div class="line">	__ATTR(baz, <span class="number">0666</span>, b_show, b_store);</div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> foo_attribute bar_attribute =</div><div class="line">	__ATTR(bar, <span class="number">0666</span>, b_show, b_store);</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Create a group of attributes so that we can create and destroy them all</div><div class="line"> * at once.</div><div class="line"> */</div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> attribute *foo_default_attrs[] = &#123;</div><div class="line">	&amp;foo_attribute.attr,</div><div class="line">	&amp;baz_attribute.attr,</div><div class="line">	&amp;bar_attribute.attr,</div><div class="line">	<span class="literal">NULL</span>,	<span class="comment">/* need to NULL terminate the list of attributes */</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Our own ktype for our kobjects.  Here we specify our sysfs ops, the</div><div class="line"> * release function, and the set of default attributes we want created</div><div class="line"> * whenever a kobject of this type is registered with the kernel.</div><div class="line"> */</div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> kobj_type foo_ktype = &#123;</div><div class="line">	.sysfs_ops = &amp;foo_sysfs_ops,</div><div class="line">	.release = foo_release,</div><div class="line">	.default_attrs = foo_default_attrs,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> kset *example_kset;</div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> foo_obj *foo_obj;</div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> foo_obj *bar_obj;</div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> foo_obj *baz_obj;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">struct</span> foo_obj *<span class="title">create_foo_obj</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">struct</span> foo_obj *foo;</div><div class="line">	<span class="keyword">int</span> retval;</div><div class="line"></div><div class="line">	<span class="comment">/* allocate the memory for the whole object */</span></div><div class="line">	foo = kzalloc(<span class="keyword">sizeof</span>(*foo), GFP_KERNEL);</div><div class="line">	<span class="keyword">if</span> (!foo)</div><div class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * As we have a kset for this kobject, we need to set it before calling</div><div class="line">	 * the kobject core.</div><div class="line">	 */</div><div class="line">	foo-&gt;kobj.kset = example_kset;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Initialize and add the kobject to the kernel.  All the default files</div><div class="line">	 * will be created here.  As we have already specified a kset for this</div><div class="line">	 * kobject, we don't have to set a parent for the kobject, the kobject</div><div class="line">	 * will be placed beneath that kset automatically.</div><div class="line">	 */</div><div class="line">	retval = kobject_init_and_add(&amp;foo-&gt;kobj, &amp;foo_ktype, <span class="literal">NULL</span>, <span class="string">"%s"</span>, name);</div><div class="line">	<span class="keyword">if</span> (retval) &#123;</div><div class="line">		kobject_put(&amp;foo-&gt;kobj);</div><div class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * We are always responsible for sending the uevent that the kobject</div><div class="line">	 * was added to the system.</div><div class="line">	 */</div><div class="line">	kobject_uevent(&amp;foo-&gt;kobj, KOBJ_ADD);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> foo;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">destroy_foo_obj</span><span class="params">(<span class="keyword">struct</span> foo_obj *foo)</span></span></div><div class="line">&#123;</div><div class="line">	kobject_put(&amp;foo-&gt;kobj);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">example_init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Create a kset with the name of "kset_example",</div><div class="line">	 * located under /sys/kernel/</div><div class="line">	 */</div><div class="line">	example_kset = kset_create_and_add(<span class="string">"kset_example"</span>, <span class="literal">NULL</span>, kernel_kobj);</div><div class="line">	<span class="keyword">if</span> (!example_kset)</div><div class="line">		<span class="keyword">return</span> -ENOMEM;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Create three objects and register them with our kset</div><div class="line">	 */</div><div class="line">	foo_obj = create_foo_obj(<span class="string">"foo"</span>);</div><div class="line">	<span class="keyword">if</span> (!foo_obj)</div><div class="line">		<span class="keyword">goto</span> foo_error;</div><div class="line"></div><div class="line">	bar_obj = create_foo_obj(<span class="string">"bar"</span>);</div><div class="line">	<span class="keyword">if</span> (!bar_obj)</div><div class="line">		<span class="keyword">goto</span> bar_error;</div><div class="line"></div><div class="line">	baz_obj = create_foo_obj(<span class="string">"baz"</span>);</div><div class="line">	<span class="keyword">if</span> (!baz_obj)</div><div class="line">		<span class="keyword">goto</span> baz_error;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">baz_error:</div><div class="line">	destroy_foo_obj(bar_obj);</div><div class="line">bar_error:</div><div class="line">	destroy_foo_obj(foo_obj);</div><div class="line">foo_error:</div><div class="line">	kset_unregister(example_kset);</div><div class="line">	<span class="keyword">return</span> -EINVAL;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">example_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">	destroy_foo_obj(baz_obj);</div><div class="line">	destroy_foo_obj(bar_obj);</div><div class="line">	destroy_foo_obj(foo_obj);</div><div class="line">	kset_unregister(example_kset);</div><div class="line">&#125;</div><div class="line"></div><div class="line">module_init(example_init);</div><div class="line">module_exit(example_exit);</div><div class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</div><div class="line">MODULE_AUTHOR(<span class="string">"Greg Kroah-Hartman &lt;greg@kroah.com&gt;"</span>);</div></pre></td></tr></table></figure></p>

    

    
</div>


                

                <!-- Post Comments -->
                
                    







                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2014/03/04/codingstyle/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2014/03/04/sysfs/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="John Doe's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        youremail@email.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/04/">四月 2017<span class="sidebar_archives-count">28</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">三月 2017<span class="sidebar_archives-count">37</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">二月 2017<span class="sidebar_archives-count">12</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/01/">一月 2017<span class="sidebar_archives-count">12</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">十二月 2016<span class="sidebar_archives-count">18</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">24</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">39</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">32</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/08/">八月 2016<span class="sidebar_archives-count">32</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">七月 2016<span class="sidebar_archives-count">21</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/06/">六月 2016<span class="sidebar_archives-count">33</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/05/">五月 2016<span class="sidebar_archives-count">20</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/04/">四月 2016<span class="sidebar_archives-count">15</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/03/">三月 2016<span class="sidebar_archives-count">19</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/02/">二月 2016<span class="sidebar_archives-count">16</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/01/">一月 2016<span class="sidebar_archives-count">19</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/12/">十二月 2015<span class="sidebar_archives-count">20</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/11/">十一月 2015<span class="sidebar_archives-count">30</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/10/">十月 2015<span class="sidebar_archives-count">30</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/09/">九月 2015<span class="sidebar_archives-count">27</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/08/">八月 2015<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/07/">七月 2015<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/06/">六月 2015<span class="sidebar_archives-count">10</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/05/">五月 2015<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/04/">四月 2015<span class="sidebar_archives-count">11</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/03/">三月 2015<span class="sidebar_archives-count">10</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/02/">二月 2015<span class="sidebar_archives-count">14</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/01/">一月 2015<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/12/">十二月 2014<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/11/">十一月 2014<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/10/">十月 2014<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/09/">九月 2014<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/08/">八月 2014<span class="sidebar_archives-count">9</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/07/">七月 2014<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/06/">六月 2014<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/05/">五月 2014<span class="sidebar_archives-count">11</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/04/">四月 2014<span class="sidebar_archives-count">32</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/03/">三月 2014<span class="sidebar_archives-count">34</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/02/">二月 2014<span class="sidebar_archives-count">14</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/01/">一月 2014<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/12/">十二月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/07/">七月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/06/">六月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/04/">四月 2013<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/03/">三月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/02/">二月 2013<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/01/">一月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/12/">十二月 2012<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/10/">十月 2012<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/09/">九月 2012<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/07/">七月 2012<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/06/">六月 2012<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/05/">五月 2012<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/08/">八月 2011<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/07/">七月 2011<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/06/">六月 2011<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/05/">五月 2011<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/04/">四月 2011<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/03/">三月 2011<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/02/">二月 2011<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/12/">十二月 2010<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/11/">十一月 2010<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/09/">九月 2010<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/07/">七月 2010<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/06/">六月 2010<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/02/">二月 2010<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/01/">一月 2010<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/09/">九月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/07/">七月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/05/">五月 2009<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/04/">四月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/03/">三月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/02/">二月 2009<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2008/07/">七月 2008<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2008/06/">六月 2008<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-twitter.svg);">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-facebook.svg);">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-gplus.svg);">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;Hexo
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->

    <script src="/js/lazyload.min.js"></script>
    <script src="/js/js.min.js"></script>



    <script src="/js/nprogress.js"></script>


<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>
















<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script>
    <!-- Offer LazyLoad -->
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    <!-- Start Queue -->
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

                </main>
            </div>
        </body>
    
</html>
