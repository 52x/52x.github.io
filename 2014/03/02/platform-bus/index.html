<!DOCTYPE html>
<html lang="zh">
    <head>
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.4 -->

    <!-- Title -->
    
    <title>
        
            platform总线 | 
        
        Hexo
    </title>

    <!-- Meta & Info -->
    <meta charset="utf-8">

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    

    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="John Doe">
    <meta name="description" content="null">
    <meta name="keywords" content="null">

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Hexo">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="platform总线 | Hexo">
    <meta property="og:description" content="null">
    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS & jQuery -->
    
        <link rel="stylesheet" href="/css/material.min.css">
        <link rel="stylesheet" href="/css/style.min.css">
        <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


        <script src="/js/jquery.min.js"></script>
        <script src="/js/queue.js"></script>
    

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    


    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">1.</span> <span class="post-toc-text">前言</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">2.</span> <span class="post-toc-text">platform概貌</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">3.</span> <span class="post-toc-text">platform初始化</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">4.</span> <span class="post-toc-text">platform device注册</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">5.</span> <span class="post-toc-text">platform driver的注册</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#undefined"><span class="post-toc-number">6.</span> <span class="post-toc-text">小结</span></a></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                platform总线
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>John Doe</strong>
        <span>3月 02, 2014</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=platform总线&url=http://yoursite.com//2014/03/02/platform-bus/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=platform总线&url=http://yoursite.com//2014/03/02/platform-bus/index.html&via=John Doe" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com//2014/03/02/platform-bus/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com//2014/03/02/platform-bus/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <p>原文链接：<a href="http://blog.chinaunix.net/uid-20543183-id-1930814.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-20543183-id-1930814.html</a></p>
<h2>前言</h2>
<p><code>platform</code>总线是kernel中最近加入的一种虚拟总线.在近版的2.6kernel中,很多驱动都用<code>platform</code>改写了.只有在分析完<code>platform</code>总线之后,才能继续深入下去分析.在分析完<code>sysfs</code>和设备驱动模型之后,这部份应该很简单了.闲言少叙.步入正题.GO.GO!以下的源代码分析是基于2.6.25的.
&lt;!--more--&gt;</p>
<h2>platform概貌</h2>
<p>在分析源代码之前,先在内核代码中找一个<code>platform</code>架构的驱动程序.下面以<code>i8042</code>芯片的驱动为例进行分析.<br>
在<code>linux-2.6.25/drivers/input/serio/i8042.c</code>的<code>intel 8042</code>的初始化入口中,有以下代码分段:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">i8042_init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">     ……</div><div class="line"></div><div class="line">  err = platform_driver_register(&amp;i8042_driver);</div><div class="line">  <span class="keyword">if</span> (err)</div><div class="line">       <span class="keyword">goto</span> err_platform_exit;</div><div class="line"></div><div class="line">  i8042_platform_device = platform_device_alloc(<span class="string">"i8042"</span>, <span class="number">-1</span>);</div><div class="line">     <span class="keyword">if</span> (!i8042_platform_device) &#123;</div><div class="line">         err = -ENOMEM;</div><div class="line">         <span class="keyword">goto</span> err_unregister_driver;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     err = platform_device_add(i8042_platform_device);</div><div class="line">     <span class="keyword">if</span> (err)</div><div class="line">         <span class="keyword">goto</span> err_free_device;</div><div class="line">     ……</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们在上面的程序片段中看到,驱动程序先注册了一个<code>platform driver</code>,然后又添加了一个<code>platform device</code>.这里就涉及到了<code>platform</code>的两个最主要的操作：一个设备驱动注册，一个设备注册。</p>
<p>要了解<code>platform</code>总线的来龙去脉.得从它的初始化开始.</p>
<h2>platform初始化</h2>
<p><code>platform</code>总线的初始化是在<code>linux-2.6.25/drivers/base/platform.c</code>中的<code>platform_bus_init()</code>完成的,代码如下:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> __<span class="function">init <span class="title">platform_bus_init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">     <span class="keyword">int</span> error;</div><div class="line"></div><div class="line">     error = device_register(&amp;platform_bus);</div><div class="line">     <span class="keyword">if</span> (error)</div><div class="line">         <span class="keyword">return</span> error;</div><div class="line"></div><div class="line">     error =  bus_register(&amp;platform_bus_type);</div><div class="line">     <span class="keyword">if</span> (error)</div><div class="line">         device_unregister(&amp;platform_bus);</div><div class="line">     <span class="keyword">return</span> error;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面代码中调用的子函数在<a href="/2014/02/27/probe-of-linux-kernel-driver-module/" title="linux设备模型深探">linux设备模型深探</a>中已经分析过了。这段初始化代码创建了一个名为 “<code>platform</code>”的设备，后续<code>platform</code>的设备都会以此为<code>parent</code>。在<code>sysfs</code>中表示为：所有<code>platform</code>类型的设备都会添加在<code>platform_bus</code>所代表的目录下，即 <code>/sys/devices/platform</code> 下面.<br>
接着,这段初始化代码又创建了一个名为“<code>platform</code>”的总线.<br>
<code>platform_bus_type</code>的定义如下:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> bus_type platform_bus_type = &#123;</div><div class="line">     .name         = <span class="string">"platform"</span>,</div><div class="line">     .dev_attrs    = platform_dev_attrs,</div><div class="line">     .match        = platform_match,</div><div class="line">     .uevent       = platform_uevent,</div><div class="line">     .suspend      = platform_suspend,</div><div class="line">     .suspend_late = platform_suspend_late,</div><div class="line">     .resume_early = platform_resume_early,</div><div class="line">     .resume       = platform_resume,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>我们知道，在<code>bus_type</code>中包含了诸如设备与驱动匹配，<code>hotplug</code>事件等很多重要的操作。这些操作在分析<code>platform</code>设备注册与<code>platform</code>驱动注册的时候依次分析。</p>
<h2>platform device注册</h2>
<p>在<code>intel 8042</code>的驱动代码中,我们看到注册一个<code>platform device</code>分为了两部分,一部份是创建一个<code>platform device</code>结构,另一部份是将其注册到总线中.先来看第一个接口.
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">struct</span> platform_device *<span class="title">platform_device_alloc</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> id)</span></span></div><div class="line">&#123;</div><div class="line">     <span class="keyword">struct</span> platform_object *pa;</div><div class="line"></div><div class="line">     pa = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> platform_object) + <span class="built_in">strlen</span>(name), GFP_KERNEL);</div><div class="line">     <span class="keyword">if</span> (pa) &#123;</div><div class="line">         <span class="built_in">strcpy</span>(pa-&gt;name, name);</div><div class="line">         pa-&gt;pdev.name = pa-&gt;name;</div><div class="line">         pa-&gt;pdev.id = id;</div><div class="line">         device_initialize(&amp;pa-&gt;pdev.dev);</div><div class="line"></div><div class="line">         pa-&gt;pdev.dev.release = platform_device_release;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">return</span> pa ? &amp;pa-&gt;pdev : <span class="literal">NULL</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这段代码主要初始化了封装在<code>struct platform_object</code>中的<code>struct device</code>.</p>
<p><code>struct platform_object</code>结构定义如下:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> platform_object &#123;</div><div class="line">     <span class="keyword">struct</span> platform_device pdev;</div><div class="line">     <span class="keyword">char</span> name[<span class="number">1</span>];</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>在定义中,定义<code>name</code>长度为<code>1</code>,所以,才有了<code>platform_device_alloc()</code>中分配<code>struct platform_object</code>的时候多加了名称的长度:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pa = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> platform_object) + <span class="built_in">strlen</span>(name), GFP_KERNEL);</div></pre></td></tr></table></figure></p>
<p><code>struct device</code>结构如下:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> platform_device &#123;</div><div class="line">     <span class="keyword">const</span> <span class="keyword">char</span>    * name;</div><div class="line">     <span class="keyword">int</span>      id;</div><div class="line">     <span class="keyword">struct</span> device dev;</div><div class="line">     u32      num_resources;</div><div class="line">     <span class="keyword">struct</span> resource    * resource;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>在这个结构里封装了<code>struct device</code>、<code>struct resource</code>，<code>struct resource</code>这个结构在此之前没有接触过,这个结构表示设备所拥有的资源，即I/O端口或者是I/O映射内存。</p>
<p><code>platform_device_add()</code>代码分段分析如下:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">platform_device_add</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span></div><div class="line">&#123;</div><div class="line">     <span class="keyword">int</span> i, ret = <span class="number">0</span>;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (!pdev)</div><div class="line">         <span class="keyword">return</span> -EINVAL;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (!pdev-&gt;dev.parent)</div><div class="line">         pdev-&gt;dev.parent = &amp;platform_bus;</div><div class="line"></div><div class="line">     pdev-&gt;dev.bus = &amp;platform_bus_type;</div></pre></td></tr></table></figure></p>
<p>初始化设备的<code>parent</code>为<code>platform_bus</code>, 初始化驱备的总线为<code>platform_bus_type</code>. 回忆<code>platform</code>初始化的时候, 这两个东东这里终于派上用场了.
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (pdev-&gt;id != <span class="number">-1</span>)</div><div class="line">    <span class="built_in">snprintf</span>(pdev-&gt;dev.bus_id, BUS_ID_SIZE, <span class="string">"%s.%d"</span>, pdev-&gt;name,</div><div class="line">          pdev-&gt;id);</div><div class="line"><span class="keyword">else</span></div><div class="line">    strlcpy(pdev-&gt;dev.bus_id, pdev-&gt;name, BUS_ID_SIZE);</div></pre></td></tr></table></figure></p>
<p>设置设备<code>struct device</code>的<code>bus_id</code>成员, 留心这个地方, 在以后还需要用到这个的.
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pdev-&gt;num_resources; i++) &#123;</div><div class="line">    <span class="keyword">struct</span> resource *p, *r = &amp;pdev-&gt;resource[i];</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r-&gt;name == <span class="literal">NULL</span>)</div><div class="line">         r-&gt;name = pdev-&gt;dev.bus_id;</div><div class="line"></div><div class="line">    p = r-&gt;parent;</div><div class="line">    <span class="keyword">if</span> (!p) &#123;</div><div class="line">         <span class="keyword">if</span> (r-&gt;flags &amp; IORESOURCE_MEM)</div><div class="line">              p = &amp;iomem_resource;</div><div class="line">         <span class="keyword">else</span> <span class="keyword">if</span> (r-&gt;flags &amp; IORESOURCE_IO)</div><div class="line">              p = &amp;ioport_resource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (p &amp;&amp; insert_resource(p, r)) &#123;</div><div class="line">         printk(KERN_ERR</div><div class="line">                <span class="string">"%s: failed to claim resource %d\n"</span>,</div><div class="line">                pdev-&gt;dev.bus_id, i);</div><div class="line">         ret = -EBUSY;</div><div class="line">         <span class="keyword">goto</span> failed;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果设备指定了它所拥有的资源, 将这些资源分配给它. 如果分配失败, 则失败退出. 从代码中可以看出, 如果<code>struct resource</code>的<code>flags</code>域被指定为<code>IORESOURCE_MEM</code>, 则所表示的资源为I/O映射内存; 如果指定为<code>IORESOURCE_IO</code>, 则所表示的资源为I/O端口.
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">     pr_debug(<span class="string">"Registering platform device '%s'. Parent at %s\n"</span>,</div><div class="line">          pdev-&gt;dev.bus_id, pdev-&gt;dev.parent-&gt;bus_id);</div><div class="line"></div><div class="line">     ret = device_add(&amp;pdev-&gt;dev);</div><div class="line">     <span class="keyword">if</span> (ret == <span class="number">0</span>)</div><div class="line">         <span class="keyword">return</span> ret;</div><div class="line"></div><div class="line"> failed:</div><div class="line">     <span class="keyword">while</span> (--i &gt;= <span class="number">0</span>)</div><div class="line">         <span class="keyword">if</span> (pdev-&gt;resource[i].flags &amp; (IORESOURCE_MEM|IORESOURCE_IO))</div><div class="line">              release_resource(&amp;pdev-&gt;resource[i]);</div><div class="line">     <span class="keyword">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>device_add()</code>已经很熟悉了吧, 没错, 它就是将设备注册到指定的<code>bus_type</code>.</p>
<p>在分析linux设备模型的时候, 曾说过, 调用<code>device_add()</code>会产生一个<code>hotplug</code>事件. <code>platform device</code>的<code>hotplug</code>与一般的<code>device</code>事件相比, 它还要它所属<code>bus_type</code>的<code>uevent()</code>.对这个流程不熟悉的可以参照<a href="/2014/02/27/probe-of-linux-kernel-driver-module/" title="linux设备模型深探">linux设备模型深探</a>. <code>platform device</code>所属的<code>bus_type</code>为<code>platform_bus_type</code>, 它的<code>uevent()</code>接口代码如下:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">platform_uevent</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> kobj_uevent_env *env)</span></span></div><div class="line">&#123;</div><div class="line">     <span class="keyword">struct</span> platform_device *pdev = to_platform_device(dev);</div><div class="line"></div><div class="line">     add_uevent_var(env, <span class="string">"MODALIAS=platform:%s"</span>, pdev-&gt;name);</div><div class="line">     <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的代码很简单,它就是在环境变量中添加一项<code>MODALIAS</code>.</p>
<h2>platform driver的注册</h2>
<p>在<code>intel 8024</code>的驱动代码中看到，<code>platform driver</code>注册的接口为:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">platform_driver_register</span><span class="params">(<span class="keyword">struct</span> platform_driver *drv)</span></span></div><div class="line">&#123;</div><div class="line">     drv-&gt;driver.bus = &amp;platform_bus_type;</div><div class="line">     <span class="keyword">if</span> (drv-&gt;probe)</div><div class="line">         drv-&gt;driver.probe = platform_drv_probe;</div><div class="line">     <span class="keyword">if</span> (drv-&gt;remove)</div><div class="line">         drv-&gt;driver.remove = platform_drv_remove;</div><div class="line">     <span class="keyword">if</span> (drv-&gt;shutdown)</div><div class="line">         drv-&gt;driver.shutdown = platform_drv_shutdown;</div><div class="line">     <span class="keyword">if</span> (drv-&gt;suspend)</div><div class="line">         drv-&gt;driver.suspend = platform_drv_suspend;</div><div class="line">     <span class="keyword">if</span> (drv-&gt;resume)</div><div class="line">         drv-&gt;driver.resume = platform_drv_resume;</div><div class="line"></div><div class="line">     <span class="keyword">return</span> driver_register(&amp;drv-&gt;driver);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>struct platform_driver</code>主要封装了<code>struct device_driver</code>结构, 如下:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> platform_driver &#123;</div><div class="line">     <span class="keyword">int</span> (*probe)(<span class="keyword">struct</span> platform_device *);</div><div class="line">     <span class="keyword">int</span> (*remove)(<span class="keyword">struct</span> platform_device *);</div><div class="line">     <span class="keyword">void</span> (*shutdown)(<span class="keyword">struct</span> platform_device *);</div><div class="line">     <span class="keyword">int</span> (*suspend)(<span class="keyword">struct</span> platform_device *, <span class="keyword">pm_message_t</span> state);</div><div class="line">     <span class="keyword">int</span> (*suspend_late)(<span class="keyword">struct</span> platform_device *, <span class="keyword">pm_message_t</span> state);</div><div class="line">     <span class="keyword">int</span> (*resume_early)(<span class="keyword">struct</span> platform_device *);</div><div class="line">     <span class="keyword">int</span> (*resume)(<span class="keyword">struct</span> platform_device *);</div><div class="line">     <span class="keyword">struct</span> device_driver driver;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>在这个接口里, 它指定<code>platform driver</code>的所属总线. 如果在<code>struct platform_driver</code>指定了各项接口的操作, 就会为<code>struct device_driver</code>中的相应接口赋值.</p>
<p>不要被上面的<code>platform_drv_XXX</code>吓倒了, 它们其实很简单, 就是将<code>struct device</code>转换为<code>struct platform_device</code>和<code>struct platform_driver</code>, 然后调用<code>platform_driver</code>中的相应接口函数.</p>
<p>最后, <code>platform_driver_register()</code>将驱动注册到总线上.<br>
这样, 总线上有设备, 又有驱动, 就会进行设备与驱动匹配的过程, 调用的相应接口为：<br>
<code>bus -&gt;match --- &gt; bus-&gt;probe/driver-&gt;probe</code> (如果总线的<code>probe</code>操作不存在,就会调用设备的<code>probe</code>接口)。<br>
这样，我们又回到<code>platform_bus_type</code>中的各项操作了。<br>
对应的<code>match</code>接口如下:
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">platform_match</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_driver *drv)</span></span></div><div class="line">&#123;</div><div class="line">     <span class="keyword">struct</span> platform_device *pdev;</div><div class="line"></div><div class="line">     pdev = container_of(dev, <span class="keyword">struct</span> platform_device, dev);</div><div class="line">     <span class="keyword">return</span> (<span class="built_in">strncmp</span>(pdev-&gt;name, drv-&gt;name, BUS_ID_SIZE) == <span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从代码中看出，如果要匹配成功，那么设备与驱动的名称必须要一致。</p>
<p><code>platform_bus_type</code> 中没有指定<code>probe</code>接口，所以，会转至驱动的<code>probe</code>接口。在<code>platform_driver_register()</code>中，将其<code>probe</code>接口指定为了<code>platform_drv_probe</code>，这个函数又会将操作回溯到<code>struct platform_driver</code>的<code>probe</code>接口中。</p>
<p>到这里，<code>platform driver</code>的注册过程就会析完了。</p>
<h2>小结</h2>
<p>在本小节里，我们以linux设备模型为基础，分析虚拟总线<code>platform</code>的架构，对其<code>hotplug</code>事件，以及设备与驱动的匹配过程做了非常详细的分析，这部份知识是我们深入理解具体设备驱动的基础.</p>

    

    
</div>


                

                <!-- Post Comments -->
                
                    







                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2014/02/28/linux-sysfs/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2014/03/03/serio-bus/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="John Doe's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        youremail@email.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/04/">四月 2017<span class="sidebar_archives-count">28</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">三月 2017<span class="sidebar_archives-count">37</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">二月 2017<span class="sidebar_archives-count">12</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/01/">一月 2017<span class="sidebar_archives-count">12</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">十二月 2016<span class="sidebar_archives-count">18</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">24</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/10/">十月 2016<span class="sidebar_archives-count">39</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">32</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/08/">八月 2016<span class="sidebar_archives-count">32</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">七月 2016<span class="sidebar_archives-count">21</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/06/">六月 2016<span class="sidebar_archives-count">33</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/05/">五月 2016<span class="sidebar_archives-count">20</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/04/">四月 2016<span class="sidebar_archives-count">15</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/03/">三月 2016<span class="sidebar_archives-count">19</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/02/">二月 2016<span class="sidebar_archives-count">16</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/01/">一月 2016<span class="sidebar_archives-count">19</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/12/">十二月 2015<span class="sidebar_archives-count">20</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/11/">十一月 2015<span class="sidebar_archives-count">30</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/10/">十月 2015<span class="sidebar_archives-count">30</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/09/">九月 2015<span class="sidebar_archives-count">27</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/08/">八月 2015<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/07/">七月 2015<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/06/">六月 2015<span class="sidebar_archives-count">10</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/05/">五月 2015<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/04/">四月 2015<span class="sidebar_archives-count">11</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/03/">三月 2015<span class="sidebar_archives-count">10</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/02/">二月 2015<span class="sidebar_archives-count">14</span></a></li><li><a class="sidebar_archives-link" href="/archives/2015/01/">一月 2015<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/12/">十二月 2014<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/11/">十一月 2014<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/10/">十月 2014<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/09/">九月 2014<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/08/">八月 2014<span class="sidebar_archives-count">9</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/07/">七月 2014<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/06/">六月 2014<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/05/">五月 2014<span class="sidebar_archives-count">11</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/04/">四月 2014<span class="sidebar_archives-count">32</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/03/">三月 2014<span class="sidebar_archives-count">34</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/02/">二月 2014<span class="sidebar_archives-count">14</span></a></li><li><a class="sidebar_archives-link" href="/archives/2014/01/">一月 2014<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/12/">十二月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/07/">七月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/06/">六月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/04/">四月 2013<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/03/">三月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/02/">二月 2013<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2013/01/">一月 2013<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/12/">十二月 2012<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/10/">十月 2012<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/09/">九月 2012<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/07/">七月 2012<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/06/">六月 2012<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2012/05/">五月 2012<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/08/">八月 2011<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/07/">七月 2011<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/06/">六月 2011<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/05/">五月 2011<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/04/">四月 2011<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/03/">三月 2011<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2011/02/">二月 2011<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/12/">十二月 2010<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/11/">十一月 2010<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/09/">九月 2010<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/07/">七月 2010<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/06/">六月 2010<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/02/">二月 2010<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2010/01/">一月 2010<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/09/">九月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/07/">七月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/05/">五月 2009<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/04/">四月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/03/">三月 2009<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2009/02/">二月 2009<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2008/07/">七月 2008<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2008/06/">六月 2008<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-twitter.svg);">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-facebook.svg);">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-gplus.svg);">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;Hexo
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->

    <script src="/js/lazyload.min.js"></script>
    <script src="/js/js.min.js"></script>



    <script src="/js/nprogress.js"></script>


<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>
















<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script>
    <!-- Offer LazyLoad -->
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    <!-- Start Queue -->
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

                </main>
            </div>
        </body>
    
</html>
